# 生成新聞 リファクタリング指示書

## この文書について
2026年3月のプロジェクト全体レビューを踏まえた、抜本的な改善指示書。
以下の方針に基づき、段階的に実装すること。

---

## 方針決定事項

### 1. パーソナライズの基盤を「位置情報」に変える
- 恵比寿固定のローカルニュースをやめる
- **購読者の端末の位置情報（ブラウザのGeolocation API）** を取得し、その場所に合わせた紙面を生成する
- 位置情報に連動するコーナー：天気、近所ニュース、催事（展示会・映画）
- これにより、引っ越しても旅行先でも、その場所の紙面が届く

### 2. 「天声生成」コーナーを廃止
- 天声生成（AIコラム）を紙面から削除する
- 代替コーナーは不要（他コーナーの充実で補う）

### 3. 夕刊の方向性を変える
- 夕刊は新聞のパロディとしての体験価値があるので継続
- 朝刊 ＝ 硬めのニュース中心
- 夕刊 ＝ やわらかいニュース多め（トレンド、ほっこり、エンタメ寄り）
- 朝刊と夕刊で紙面のトーンを明確に分ける

### 4. 課金モデルの変更
- 現在の有料課金フロー（Apple Pay等）を一旦停止
- **完全無料** にする（メールアドレスのみで購読開始）
- 招待コード制も廃止し、誰でもすぐ読めるようにする
- LP・index.html・sample.htmlの購読導線をすべて「無料」前提に書き換える
- 将来的に課金を再導入する可能性があるため、Stripe/Apple Pay関連のコードは削除せずコメントアウトで残す

### 5. 仕様書の一元化
- 散在している仕様書を整理する：
  - `CLAUDE.md` → Claude Codeへの全体指示書（これだけ読めばOKな状態に）
  - `docs/ARCHITECTURE.md` → 技術構成の全体像
  - `docs/ROADMAP.md` → やること・やらないことの一覧と優先順位
  - `docs/CHANGELOG.md` → 変更履歴
- 既存の個別SPEC（NEW_CORNERS_SPEC.md, ADMIN_SPEC.md, LP_SPEC.md, EMAIL_FIX_SPEC.md）は、内容をROADMAP.mdに統合した上で `docs/archive/` に移動
- PROJECT.mdの内容もCLAUDE.mdに統合

---

## 実装フェーズ

### Phase 1: 基盤整理（最優先）

#### 1-1. 仕様書の一元化
- 上記の構成で仕様書を整理・統合する
- CLAUDE.mdを「このプロジェクトの全体像と開発ルール」として書き直す

#### 1-2. 天声生成の削除
- index.htmlから天声生成コーナーのHTML/CSS/JSを削除
- Workers側のプロンプト（prompt.js等）から天声生成の生成指示を削除
- sample.htmlからも削除

#### 1-3. Apple Payメール上書きバグの修正
- Workers内のApple Pay決済処理を確認
- 決済レスポンスのemailで登録メールを上書きしている箇所を修正
- 登録フォームのメールを常に優先する

#### 1-4. ダッシュボードにメール手動編集機能を追加
- 購読者一覧にメールアドレスのインライン編集ボタンを追加
- 編集 → input表示 → 保存/キャンセル のフロー
- バリデーション（メール形式チェック、空欄不可）
- APIエンドポイント: PATCH /api/subscribers/{id} でメール更新

### Phase 2: 無料化と導線整理

#### 2-1. 課金フローの停止
- Apple Pay / Stripe関連の購読フローをコメントアウト
- 体験パス（招待コード制）を廃止
- 購読ボタンの動作を「メールアドレス入力 → 購読開始」に変更

#### 2-2. LP・各ページの書き換え
- lp.html: 「無料で購読する」に変更、料金表示を削除
- index.html: 購読導線を無料前提に
- sample.html: 「無料で始める」に変更
- 利用規約・プライバシーポリシーから課金関連の記述を調整

### Phase 3: 位置情報パーソナライズ

#### 3-1. 位置情報の取得と保存
- index.htmlにブラウザGeolocation APIの呼び出しを追加
- 初回アクセス時に位置情報の許可を求める
- 許可された場合：緯度・経度を取得し、購読者データに保存
- 拒否された場合：手動で地域を選択できるフォールバックUI（都道府県 → 市区町村）
- 購読者プロフィールに `location` フィールドを追加: `{ lat, lng, area_name }`
- 逆ジオコーディング（緯度経度 → 地名）はWorkers側で行う（Google Maps Geocoding APIまたは無料の代替API）

#### 3-2. 位置情報に連動するコーナーの実装

**天気コーナー**
- 現在の恵比寿固定 → 購読者の位置情報に連動
- OpenWeatherMap API等で取得（既存実装があればそれを拡張）

**近所ニュース**
- 現在の恵比寿固定 → 購読者の位置周辺のニュースを収集
- RSSソースを地域で分類するか、ウェブ検索で「{地域名} ニュース」を取得
- プロンプトに地域名を動的に注入

**催事（展示会・映画）**
- 現在の東京都内固定 → 購読者の最寄り地域の催事情報を取得
- 地域に応じたRSSソースの切り替え、またはウェブ検索での取得

#### 3-3. 位置情報の更新
- 毎回のアクセス時に位置情報を更新（ユーザーが移動している可能性があるため）
- ただし、前回の位置と大きく変わらなければ（1km以内等）更新しない
- 設定画面に「位置情報を手動で変更」オプションを追加

### Phase 4: 朝刊・夕刊の差別化

#### 4-1. プロンプトの分離
- 朝刊用プロンプトと夕刊用プロンプトを分ける
- 朝刊: ニュース中心、硬め、データ分析（数字で読む）を含む
- 夕刊: トレンド、エンタメ、ほっこりニュース、SNS話題など、やわらかめ

#### 4-2. コーナー構成の差別化
- 朝刊コーナー: 一面、近所ニュース、催事、数字で読む、天気と服装
- 夕刊コーナー: トレンド/SNS話題、ほっこりニュース、エンタメ（映画・音楽等）、明日の天気
- 共通: 天気は朝夕両方に出すが、朝は「今日の天気」、夕は「明日の天気」

#### 4-3. デザイン上の差別化
- 朝刊と夕刊でヘッダーの色味やトーンを微妙に変えてもよい（例：朝刊は白基調、夕刊はクリーム色基調）
- 「夕刊」のラベルを目立たせ、朝刊との違いを演出

---

## 注意事項

- 各Phaseは順番に実装すること（Phase 1 → 2 → 3 → 4）
- Phase 1は最優先でバグ修正と整理を行う
- Phase 3の位置情報は、APIキーの取得や外部サービスの設定が必要になるため、事前にPaulに確認を取ること
- 既存の購読者データ（KV内）のスキーマ変更が必要な場合は、マイグレーション手順も記述すること
- コード変更時は`docs/CHANGELOG.md`に変更内容を記録すること
