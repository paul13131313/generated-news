<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-N9N0681N4H"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-N9N0681N4H');</script>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>生成新聞 — 第〇〇七号</title>
<meta name="description" content="AIがあなただけの朝刊・夕刊を毎日届ける、生成AIによるパーソナライズド新聞。">
<meta property="og:title" content="生成新聞 — あなたの関心から、生まれる新聞。">
<meta property="og:description" content="AIがあなただけの朝刊・夕刊を毎日届ける、生成AIによるパーソナライズド新聞。">
<meta property="og:type" content="website">
<meta property="og:url" content="https://seiseishinbun.com/">
<meta property="og:image" content="https://seiseishinbun.com/ogp.png">
<meta property="og:locale" content="ja_JP">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="生成新聞 — あなたの関心から、生まれる新聞。">
<meta name="twitter:description" content="AIがあなただけの朝刊・夕刊を毎日届ける、生成AIによるパーソナライズド新聞。">
<meta name="twitter:image" content="https://seiseishinbun.com/ogp.png">
<meta name="theme-color" content="#111111">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="生成新聞">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;700;900&family=Noto+Sans+JP:wght@300;400;500;700;900&family=Shippori+Mincho:wght@400;500;600;700;800&family=Shippori+Mincho+B1:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #111;
    --paper: #f3ede2;
    --paper-mid: #e9e1d3;
    --accent: #b82010;
    --rule: #222;
    --rule-light: #c4b9a8;
    --caption: #6b6358;
    --font-mincho: 'Shippori Mincho B1', 'Shippori Mincho', 'Noto Serif JP', serif;
    --font-gothic: 'Noto Sans JP', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: var(--font-mincho);
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
  }

  /* ===== GENERATION OVERLAY ===== */
  .gen-overlay {
    position: fixed;
    inset: 0;
    background: var(--ink);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 1s ease;
  }
  .gen-overlay.done { opacity: 0; pointer-events: none; }

  .gen-overlay .gen-title {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 28px;
    color: var(--paper);
    letter-spacing: 0.5em;
    margin-right: -0.5em;
    margin-bottom: 32px;
    opacity: 0;
    animation: fadeUp 0.8s 0.3s forwards;
  }

  .gen-overlay .gen-steps {
    list-style: none;
    font-family: var(--font-gothic);
    font-size: 12px;
    color: rgba(243,237,226,0.3);
    letter-spacing: 0.12em;
    line-height: 2.4;
    text-align: left;
    padding: 0;
    margin: 0;
    align-self: flex-start;
  }

  .gen-steps li {
    opacity: 0;
    transform: translateY(6px);
    transition: all 0.5s ease;
  }
  .gen-steps li.active {
    opacity: 1;
    color: rgba(243,237,226,0.9);
    transform: translateY(0);
  }
  .gen-steps li.done-step {
    opacity: 1;
    color: rgba(243,237,226,0.35);
    transform: translateY(0);
  }
  .gen-steps li::before {
    content: '';
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    margin-right: 10px;
    vertical-align: middle;
    background: rgba(243,237,226,0.15);
    transition: background 0.4s;
  }
  .gen-steps li.active::before {
    background: var(--accent);
    box-shadow: 0 0 8px rgba(184,32,16,0.5);
  }
  .gen-steps li.done-step::before { background: rgba(243,237,226,0.3); }

  @keyframes fadeUp { to { opacity: 1; } }

  /* ===== GEN CONTENT ANIM ===== */
  .gen-animate {
    opacity: 0;
    transform: translateY(8px);
    filter: blur(3px);
    transition: opacity 0.7s ease, transform 0.7s ease, filter 0.7s ease;
  }
  .gen-animate.gen-visible {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }

  .typing-cursor::after {
    content: '｜';
    color: var(--accent);
    animation: blink 0.7s step-end infinite;
    font-weight: 400;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* ===== AUTH USER BAR (footer) ===== */
  .user-bar {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
    padding: 16px 0 0;
    margin-top: 16px;
    border-top: 1px solid var(--rule-light);
    font-family: var(--font-gothic);
    font-size: 10px;
    color: var(--caption);
    letter-spacing: 0.04em;
  }
  .user-bar-email { font-weight: 500; color: var(--ink); }
  .user-bar-link {
    color: var(--caption);
    text-decoration: underline;
    cursor: pointer;
    font-size: 10px;
  }
  .user-bar-link:hover { color: var(--accent); }
  .user-bar-sep { margin: 0 2px; }

  /* ===== PUSH TOGGLE SWITCH ===== */
  .push-toggle-wrap {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    cursor: pointer;
    font-family: var(--font-gothic);
    font-size: 10px;
    color: var(--caption);
    letter-spacing: 0.04em;
    user-select: none;
  }
  .push-toggle-label { white-space: nowrap; }
  .push-toggle-track {
    position: relative;
    width: 30px;
    height: 16px;
    border-radius: 8px;
    background: var(--rule-light);
    transition: background 0.3s;
  }
  .push-toggle-track.on { background: #5c3a1e; }
  .push-toggle-thumb {
    position: absolute;
    top: 2px;
    left: 2px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--paper);
    transition: transform 0.3s;
    box-shadow: 0 1px 2px rgba(0,0,0,0.15);
  }
  .push-toggle-track.on .push-toggle-thumb { transform: translateX(14px); }
  .push-toggle-track.disabled { opacity: 0.4; cursor: default; }

  /* ===== PROFILE MODAL ===== */
  .profile-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5); z-index: 10001;
    align-items: center; justify-content: center;
  }
  .profile-overlay.show { display: flex; }
  .profile-modal {
    background: var(--paper); width: 100%; max-width: 480px;
    max-height: 90vh; overflow-y: auto; margin: 24px;
    padding: 32px 28px; position: relative; border: 1px solid var(--rule);
  }
  .profile-modal-close {
    position: absolute; top: 10px; right: 14px;
    background: none; border: none; font-size: 22px;
    cursor: pointer; color: var(--caption); line-height: 1;
  }
  .profile-modal-close:hover { color: var(--ink); }
  .profile-title {
    font-family: var(--font-mincho); font-size: 20px;
    font-weight: 800; letter-spacing: 0.1em; margin-bottom: 6px;
  }
  .profile-sub {
    font-family: var(--font-gothic); font-size: 12px;
    color: var(--caption); margin-bottom: 24px;
  }
  .profile-section-label {
    font-family: var(--font-gothic); font-size: 11px; font-weight: 700;
    letter-spacing: 0.1em; color: var(--caption);
    margin-bottom: 12px; border-bottom: 1px solid var(--rule-light); padding-bottom: 6px;
  }
  .profile-cats { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
  .profile-cat {
    font-family: var(--font-gothic); font-size: 13px; padding: 8px 16px;
    border: 1px solid var(--rule-light); background: transparent;
    color: var(--ink); cursor: pointer; transition: all 0.2s; letter-spacing: 0.04em;
  }
  .profile-cat:hover { border-color: var(--accent); color: var(--accent); }
  .profile-cat.selected { background: var(--ink); color: var(--paper); border-color: var(--ink); }
  .profile-keywords-input {
    width: 100%; font-family: var(--font-gothic); font-size: 14px;
    padding: 10px 14px; border: 1px solid var(--rule-light);
    background: #fff; color: var(--ink); outline: none; margin-bottom: 8px;
  }
  .profile-keywords-input:focus { border-color: var(--accent); }
  .profile-keywords-hint { font-size: 11px; color: var(--caption); margin-bottom: 16px; }
  .profile-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 24px; }
  .profile-tag {
    font-family: var(--font-gothic); font-size: 12px; padding: 4px 12px;
    background: var(--paper-mid); color: var(--ink);
    display: inline-flex; align-items: center; gap: 6px;
  }
  .profile-tag-x { cursor: pointer; font-size: 14px; color: var(--caption); line-height: 1; }
  .profile-tag-x:hover { color: var(--accent); }
  .profile-save {
    width: 100%; font-family: var(--font-gothic); font-size: 14px;
    font-weight: 700; letter-spacing: 0.1em; padding: 14px;
    background: var(--ink); color: var(--paper); border: none;
    cursor: pointer; transition: all 0.3s;
  }
  .profile-save:hover { background: var(--accent); }
  .profile-save:disabled { opacity: 0.7; cursor: not-allowed; }
  .profile-msg {
    font-family: var(--font-gothic); font-size: 12px; text-align: center;
    margin-top: 10px; min-height: 1.5em;
  }
  .profile-msg.success { color: #2d5016; }
  .profile-msg.error { color: var(--accent); }

  /* ===== MASTHEAD ===== */
  .masthead {
    padding: 0 16px;
  }

  .masthead-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    padding: 10px 0 4px;
    font-family: var(--font-gothic);
    font-size: 10px;
    letter-spacing: 0.08em;
    color: var(--caption);
    border-bottom: 1px solid var(--rule-light);
  }

  /* Edition toggle */
  .edition-toggle {
    display: flex;
    gap: 0;
    font-family: var(--font-gothic);
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 0.08em;
  }

  .edition-btn {
    padding: 4px 12px 4px;
    border: 1px solid var(--rule-light);
    background: none;
    color: var(--caption);
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    letter-spacing: inherit;
    line-height: 1;
    transition: all 0.3s;
  }

  .edition-btn:first-child { border-right: none; }
  .edition-btn:last-child { border-left: none; }

  .edition-btn.active {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
  }

  .masthead-center {
    text-align: center;
    padding: 28px 0 24px;
  }

  .masthead-center h1 {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 46px;
    letter-spacing: 0.35em;
    margin-right: -0.35em;
    line-height: 1;
  }

  .masthead-en {
    font-family: var(--font-gothic);
    font-size: 9px;
    font-weight: 400;
    letter-spacing: 0.5em;
    color: var(--caption);
    margin-top: 10px;
    opacity: 0.7;
  }

  .masthead-issue {
    text-align: center;
    padding-bottom: 14px;
  }

  .issue-badge {
    font-family: var(--font-gothic);
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.15em;
    color: var(--caption);
    border: 1px solid var(--rule-light);
    padding: 2px 10px;
  }

  .masthead-divider {
    display: none;
  }


  /* ===== TICKER ===== */
  .ticker {
    background: var(--ink);
    color: var(--paper);
    padding: 8px 0 11px;
    overflow: hidden;
  }
  .ticker-track {
    display: inline-flex;
    white-space: nowrap;
    font-family: var(--font-gothic);
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.02em;
  }
  .ticker-track .ticker-item { padding: 0 24px; }
  .ticker-track .up { color: #5cc779; }
  .ticker-track .dn { color: #e05040; }

  /* ===== CONTENT ===== */
  .content { padding: 0 16px; }
  .content a {
    color: var(--ink);
    text-decoration: none;
    border-bottom: 1px solid var(--rule-light);
    transition: border-color 0.2s, color 0.2s;
  }
  .content a:hover {
    border-color: var(--accent);
    color: var(--accent);
  }

  /* ===== TOP ARTICLE ===== */
  .top-article {
    padding: 20px 0 18px;
    border-bottom: 2px solid var(--rule);
  }

  .kicker {
    font-family: var(--font-gothic);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.12em;
    margin-bottom: 8px;
  }

  .top-headline {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 30px;
    line-height: 1.35;
    letter-spacing: -0.02em;
    margin-bottom: 6px;
    min-height: 2.7em;
  }

  .top-sub {
    font-family: var(--font-mincho);
    font-size: 17px;
    font-weight: 500;
    line-height: 1.5;
    color: #3a3a3a;
    letter-spacing: -0.01em;
    margin-bottom: 16px;
    min-height: 1.5em;
  }

  /* ===== MEDIA ===== */
  .media-frame {
    position: relative;
    width: 100%;
    overflow: hidden;
    margin-bottom: 6px;
  }
  .hero-photo {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }
  .hero-photo-canvas {
    width: 100%;
    display: block;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
  }
  .photo-credit {
    font-family: var(--font-gothic);
    font-size: 9px;
    color: var(--caption);
    text-align: right;
    margin-top: 2px;
    margin-bottom: 48px;
  }
  .photo-credit a { color: var(--caption); text-decoration: none; }
  .photo-credit a:hover { text-decoration: underline; }

  /* ===== BODY TEXT ===== */
  .body-text {
    column-count: 2;
    column-gap: 14px;
    column-rule: 1px solid var(--rule-light);
    font-size: 15px;
    line-height: 1.9;
    letter-spacing: -0.01em;
    text-align: justify;
  }
  .body-text p { margin-bottom: 0.6em; text-indent: 1em; }
  .body-text p:first-child { text-indent: 0; }
  .body-text .dropcap::first-letter {
    font-size: 3.4em;
    float: left;
    line-height: 0.8;
    margin: 4px 6px 0 0;
    font-weight: 800;
  }

  /* ===== SECTION RULE ===== */
  .sec-rule {
    display: flex; align-items: center; gap: 10px;
    padding: 22px 0 14px;
  }
  .sec-rule::before, .sec-rule::after {
    content: ''; flex: 1; height: 1px; background: var(--rule);
  }
  .sec-rule span {
    font-family: var(--font-mincho);
    font-size: 14px; font-weight: 700; letter-spacing: 0.2em;
  }

  /* ===== DUO STORIES ===== */
  .duo {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-bottom: 1px solid var(--rule);
    padding-bottom: 16px;
  }
  .duo-item { padding: 0 12px; }
  .duo-item:first-child { padding-left: 0; }
  .duo-item:first-child:not(:last-child) { border-right: 1px solid var(--rule-light); }
  .duo-item:last-child { padding-right: 0; }
  .duo-tag {
    font-family: var(--font-gothic);
    font-size: 10px; font-weight: 700;
    color: var(--accent); letter-spacing: 0.1em; margin-bottom: 5px;
  }
  .duo-item h3 {
    font-family: var(--font-mincho);
    font-weight: 700; font-size: 18px;
    line-height: 1.4; letter-spacing: -0.02em; margin-bottom: 8px;
  }
  .duo-item p {
    font-size: 13px; line-height: 1.8; color: #3a3a3a; letter-spacing: -0.01em;
  }

  /* ===== ARTICLE PHOTO ===== */
  .art-photo-wrap {
    width: 100%;
    overflow: hidden;
    margin-bottom: 6px;
  }
  .art-photo {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }
  .art-photo-canvas {
    width: 100%;
    display: block;
    image-rendering: pixelated;
    image-rendering: -moz-crisp-edges;
  }
  .art-photo-credit {
    font-family: var(--font-gothic);
    font-size: 9px;
    color: var(--caption);
    text-align: right;
    margin-top: 2px;
    margin-bottom: 8px;
  }
  .art-photo-credit a { color: var(--caption); text-decoration: none; }
  .art-photo-credit a:hover { text-decoration: underline; }

  /* ===== GEN ART ===== */
  .gen-art {
    position: relative; width: 100%; height: 160px;
    background: var(--ink); margin: 18px 0; overflow: hidden;
    border-top: 1px solid #333; border-bottom: 1px solid #333;
  }
  .gen-art canvas { width: 100%; height: 100%; }
  .gen-art-tag {
    position: absolute; bottom: 6px; left: 8px;
    font-family: var(--font-gothic);
    font-size: 8px; color: rgba(255,255,255,0.35); letter-spacing: 0.18em;
  }

  /* ===== COLUMN (天声生成) ===== */
  .column-block {
    padding: 20px 0;
    border-bottom: 2px solid var(--rule);
  }
  .column-head {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 14px; padding-bottom: 10px;
    border-bottom: 1px solid var(--rule-light);
  }
  .column-stamp {
    font-family: var(--font-mincho);
    font-weight: 800; font-size: 20px; letter-spacing: 0.08em;
  }
  .column-stamp-sub {
    font-family: var(--font-gothic);
    font-size: 10px; color: var(--caption); letter-spacing: 0.06em;
  }
  .column-body {
    font-family: var(--font-mincho);
    font-size: 15px; line-height: 2;
    letter-spacing: -0.01em; text-align: justify;
    position: relative;
  }
  .column-body::before {
    content: '';
    position: absolute; left: -16px; top: 0; bottom: 0;
    width: 3px; background: var(--accent);
  }
  .column-body p { text-indent: 1em; margin-bottom: 0.4em; }

  /* ===== NUMBERS (数字で読む) ===== */
  .stories-list { padding: 8px 0 4px; }
  .s-item {
    display: flex; align-items: baseline; gap: 14px;
    padding: 10px 0;
    border-bottom: 1px solid var(--rule-light);
  }
  .s-item:last-child { border-bottom: none; }
  .s-num {
    font-family: var(--font-mincho); font-weight: 800;
    font-size: 22px; line-height: 1; color: var(--ink);
    white-space: nowrap; min-width: 0; flex-shrink: 0;
    letter-spacing: 0.02em;
  }
  .s-label {
    font-family: var(--font-gothic); font-size: 11px;
    font-weight: 400; color: var(--caption); line-height: 1.5;
    letter-spacing: 0.02em;
  }

  /* ===== CORNERS (新コーナー共通) ===== */
  .corner-block {
    margin: 20px 0 0;
    padding: 16px 0 12px;
    border-top: 2px solid var(--rule);
  }
  .corner-head {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }
  .corner-icon {
    font-size: 18px;
    line-height: 1;
  }
  .corner-title {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 16px;
    letter-spacing: 0.15em;
    color: var(--ink);
  }
  .corner-body {
    font-family: var(--font-mincho);
    font-size: 13px;
    line-height: 1.9;
    color: var(--ink);
  }

  /* SNS・YouTubeトレンド */
  .sns-platform-label {
    font-family: var(--font-gothic);
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 0.1em;
    color: var(--accent);
    margin: 12px 0 6px;
    text-transform: uppercase;
  }
  .sns-platform-label:first-child {
    margin-top: 0;
  }
  .sns-item {
    padding: 6px 0;
    border-bottom: 1px solid var(--rule-light);
  }
  .sns-item:last-child {
    border-bottom: none;
  }
  .sns-topic {
    font-family: var(--font-mincho);
    font-weight: 700;
    font-size: 13px;
    color: var(--ink);
    margin-bottom: 2px;
  }
  .sns-topic-link {
    color: var(--ink);
    text-decoration: none;
    border-bottom: 1px solid var(--rule-light);
    transition: border-color 0.2s;
  }
  .sns-topic-link:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .sns-desc {
    font-family: var(--font-gothic);
    font-size: 11px;
    color: var(--caption);
    line-height: 1.6;
  }

  /* 炎上中ミニコーナー */
  .flame-box {
    margin-top: 16px;
    padding: 12px;
    border: 1px solid var(--accent);
    border-left: 3px solid var(--accent);
    background: rgba(184, 32, 16, 0.03);
  }
  .flame-label {
    font-family: var(--font-gothic);
    font-weight: 700;
    font-size: 11px;
    letter-spacing: 0.1em;
    color: var(--accent);
    margin-bottom: 6px;
  }
  .flame-topic {
    font-family: var(--font-mincho);
    font-weight: 700;
    font-size: 13px;
    color: var(--ink);
    margin-bottom: 4px;
  }
  .flame-topic a {
    color: var(--ink);
    text-decoration: none;
    border-bottom: 1px solid var(--rule-light);
    transition: border-color 0.2s;
  }
  .flame-topic a:hover {
    border-color: var(--accent);
    color: var(--accent);
  }
  .flame-desc {
    font-family: var(--font-gothic);
    font-size: 11px;
    color: var(--caption);
    line-height: 1.6;
  }

  /* ===== 天気と服装 ===== */
  .weather-block {
    margin: 24px 0 0;
    padding: 20px 0 16px;
    border-top: 2px solid var(--rule);
  }
  .weather-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 14px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--rule-light);
    gap: 16px;
  }
  .weather-title-row {
    display: flex;
    align-items: baseline;
    gap: 10px;
  }
  .weather-title {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 0.15em;
    color: var(--ink);
  }
  .weather-area {
    font-family: var(--font-gothic);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.08em;
    color: var(--caption);
  }
  .weather-data {
    text-align: left;
    margin-top: 6px;
  }
  .weather-data-temp {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 28px;
    letter-spacing: -0.02em;
    color: var(--ink);
    line-height: 1;
  }
  .weather-data-temp small {
    font-size: 16px;
    font-weight: 400;
    color: var(--caption);
  }
  .weather-data-detail {
    font-family: var(--font-gothic);
    font-size: 10px;
    color: var(--caption);
    margin-top: 2px;
    letter-spacing: 0.03em;
  }
  .weather-advice {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    padding: 0;
    align-items: flex-end;
    justify-content: flex-end;
    max-width: 50%;
  }
  .weather-item-tag {
    font-family: var(--font-gothic);
    font-size: 11px;
    letter-spacing: 0.05em;
    color: var(--ink);
    background: rgba(0,0,0,0.06);
    border: none;
    padding: 5px 12px;
    border-radius: 14px;
  }
  .weather-tip-row {
    margin-top: 10px;
    padding: 8px 10px;
    background: rgba(0,0,0,0.02);
    border-left: 2px solid var(--accent);
    font-family: var(--font-gothic);
    font-size: 11px;
    color: var(--caption);
    line-height: 1.5;
  }

  /* ===== ご近所情報 ===== */
  .local-block {
    margin: 24px 0 0;
    padding: 20px 0 16px;
    border-top: 2px solid var(--rule);
  }
  .local-header {
    display: flex;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--rule-light);
  }
  .local-title {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 0.15em;
    color: var(--ink);
  }
  .local-area {
    font-family: var(--font-gothic);
    font-size: 10px;
    font-weight: 600;
    letter-spacing: 0.08em;
    color: var(--caption);
  }
  .local-item {
    padding: 10px 0;
    border-bottom: 1px solid var(--rule-light);
  }
  .local-item:last-child { border-bottom: none; }
  .local-item-title {
    font-family: var(--font-mincho);
    font-weight: 700;
    font-size: 14px;
    color: var(--ink);
    margin-bottom: 4px;
  }
  .local-item-body {
    font-family: var(--font-mincho);
    font-size: 12px;
    line-height: 1.8;
    color: var(--ink);
  }

  /* ===== 催事 ===== */
  .culture-block {
    margin: 24px 0 0;
    padding: 20px 0 16px;
    border-top: 2px solid var(--rule);
  }
  .culture-header {
    display: flex;
    align-items: baseline;
    gap: 10px;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--rule-light);
  }
  .culture-title {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 0.15em;
    color: var(--ink);
  }
  .culture-sub {
    font-family: var(--font-gothic);
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.12em;
    color: var(--caption);
  }
  .culture-type-label {
    font-family: var(--font-gothic);
    font-weight: 700;
    font-size: 10px;
    letter-spacing: 0.12em;
    color: var(--accent);
    text-transform: uppercase;
    margin: 14px 0 6px;
    padding-bottom: 4px;
    border-bottom: 1px dotted var(--rule-light);
  }
  .culture-type-label:first-child { margin-top: 0; }
  .culture-item {
    padding: 8px 0;
  }
  .culture-item-title {
    font-family: var(--font-mincho);
    font-weight: 700;
    font-size: 13px;
    color: var(--ink);
  }
  .culture-item-recommended {
    display: inline-block;
    font-family: var(--font-gothic);
    font-size: 9px;
    font-weight: 700;
    color: #fff;
    background: var(--accent);
    padding: 1px 5px;
    border-radius: 2px;
    margin-right: 6px;
    vertical-align: 1px;
    letter-spacing: 0.05em;
  }
  .culture-item-meta {
    font-family: var(--font-gothic);
    font-size: 11px;
    color: var(--caption);
    margin-top: 3px;
  }
  .culture-item-desc {
    font-family: var(--font-mincho);
    font-size: 12px;
    color: var(--ink);
    margin-top: 3px;
    line-height: 1.7;
  }

  /* ===== FOOTER ===== */
  footer {
    padding: 24px 16px;
    text-align: center;
    border-top: 3px solid var(--rule);
    margin-top: 16px;
  }
  footer .f-logo {
    font-family: var(--font-mincho);
    font-weight: 800; font-size: 18px;
    letter-spacing: 0.3em; margin-right: -0.3em;
  }
  footer .f-tagline {
    font-family: var(--font-mincho);
    font-size: 14px; color: var(--caption);
    margin-top: 6px; letter-spacing: 0.06em;
  }
  footer .f-edition-info {
    font-family: var(--font-gothic);
    font-size: 11px; color: var(--caption);
    margin-top: 10px; letter-spacing: 0.04em;
    line-height: 1.8;
  }
  footer .f-stamp {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 14px; padding: 5px 14px;
    border: 1px solid var(--rule-light);
    font-family: var(--font-gothic);
    font-size: 10px; color: var(--caption); letter-spacing: 0.12em;
  }
  footer .f-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.4); }
  }

  /* ===== SUBSCRIBE TOAST ===== */
  .subscribe-toast {
    display: none;
    position: fixed;
    top: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--ink);
    color: var(--paper);
    font-family: var(--font-gothic);
    font-size: 14px;
    padding: 16px 28px;
    border-radius: 4px;
    z-index: 10001;
    text-align: center;
    box-shadow: 0 4px 24px rgba(0,0,0,0.3);
    max-width: 90vw;
  }
  .subscribe-toast.show { display: block; }
  .subscribe-toast .toast-title {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 16px;
    margin-bottom: 6px;
    letter-spacing: 0.1em;
  }
  .subscribe-toast .toast-body {
    font-size: 12px;
    opacity: 0.8;
    letter-spacing: 0.04em;
  }
  .subscribe-toast .toast-close {
    position: absolute;
    top: 8px;
    right: 12px;
    background: none;
    border: none;
    color: var(--paper);
    font-size: 18px;
    cursor: pointer;
    opacity: 0.5;
    line-height: 1;
  }
  .subscribe-toast .toast-close:hover { opacity: 1; }

  /* ===== CANCEL MODAL ===== */
  .cancel-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5); z-index: 10001;
    align-items: center; justify-content: center;
  }
  .cancel-overlay.show { display: flex; }
  .cancel-modal {
    background: var(--paper); width: 100%; max-width: 400px;
    margin: 24px; padding: 32px 28px; position: relative;
    border: 1px solid var(--rule); text-align: center;
  }
  .cancel-modal-close {
    position: absolute; top: 10px; right: 14px;
    background: none; border: none; font-size: 22px;
    cursor: pointer; color: var(--caption); line-height: 1;
  }
  .cancel-modal-close:hover { color: var(--ink); }
  .cancel-title {
    font-family: var(--font-mincho); font-size: 20px;
    font-weight: 800; letter-spacing: 0.1em; margin-bottom: 16px;
  }
  .cancel-body {
    font-family: var(--font-gothic); font-size: 13px;
    color: var(--caption); line-height: 1.8; margin-bottom: 24px;
  }
  .cancel-btns {
    display: flex; gap: 12px; justify-content: center;
  }
  .cancel-btn-back {
    font-family: var(--font-gothic); font-size: 13px; font-weight: 700;
    letter-spacing: 0.06em; padding: 12px 28px;
    background: var(--ink); color: var(--paper); border: none;
    cursor: pointer; transition: all 0.3s;
  }
  .cancel-btn-back:hover { background: #333; }
  .cancel-btn-confirm {
    font-family: var(--font-gothic); font-size: 13px; font-weight: 700;
    letter-spacing: 0.06em; padding: 12px 28px;
    background: none; color: var(--accent); border: 1px solid var(--accent);
    cursor: pointer; transition: all 0.3s;
  }
  .cancel-btn-confirm:hover { background: var(--accent); color: var(--paper); }
  .cancel-btn-confirm:disabled { opacity: 0.5; cursor: not-allowed; }
  .cancel-msg {
    font-family: var(--font-gothic); font-size: 12px;
    text-align: center; margin-top: 12px; min-height: 1.5em;
  }
  .cancel-msg.success { color: #2d5016; }
  .cancel-msg.error { color: var(--accent); }

  /* ===== INVITE MODAL ===== */
  .invite-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.5); z-index: 10001;
    align-items: center; justify-content: center;
  }
  .invite-overlay.show { display: flex; }
  .invite-modal {
    background: var(--paper); width: 100%; max-width: 400px;
    margin: 24px; padding: 32px 28px; position: relative;
    border: 1px solid var(--rule); text-align: center;
  }
  .invite-modal-close {
    position: absolute; top: 10px; right: 14px;
    background: none; border: none; font-size: 22px;
    cursor: pointer; color: var(--caption); line-height: 1;
  }
  .invite-modal-close:hover { color: var(--ink); }
  .invite-title {
    font-family: var(--font-mincho); font-size: 20px;
    font-weight: 800; letter-spacing: 0.1em; margin-bottom: 10px;
  }
  .invite-sub {
    font-family: var(--font-gothic); font-size: 12px;
    color: var(--caption); line-height: 1.8; margin-bottom: 20px;
  }
  .invite-field { margin-bottom: 14px; text-align: left; }
  .invite-field label {
    display: block; font-family: var(--font-gothic);
    font-size: 11px; font-weight: 500; letter-spacing: 0.08em;
    color: var(--caption); margin-bottom: 6px;
  }
  .invite-field input {
    width: 100%; font-family: var(--font-gothic); font-size: 15px;
    padding: 12px 16px; border: 1px solid var(--rule-light);
    background: #fff; color: var(--ink); outline: none;
    transition: border-color 0.3s; box-sizing: border-box;
  }
  .invite-field input:focus { border-color: var(--accent); }
  .invite-submit {
    width: 100%; font-family: var(--font-gothic); font-size: 14px;
    font-weight: 700; letter-spacing: 0.1em; padding: 14px;
    background: var(--ink); color: var(--paper); border: none;
    cursor: pointer; transition: all 0.3s; margin-top: 8px;
  }
  .invite-submit:hover { background: var(--accent); }
  .invite-submit:disabled { opacity: 0.7; cursor: not-allowed; }
  .invite-msg {
    font-family: var(--font-gothic); font-size: 12px;
    text-align: center; margin-top: 10px; min-height: 1.5em;
  }
  .invite-msg.success { color: #2d5016; }
  .invite-msg.error { color: var(--accent); }
</style>
</head>
<body>

<!-- SAMPLE BANNER（見本紙モード時のみ表示） -->
<div id="sampleBanner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:9999;background:#b91c1c;color:#fff;text-align:center;padding:10px 16px;font-size:14px;font-family:'Noto Serif JP',serif;display:none;align-items:center;justify-content:center;gap:12px;">
  <span style="background:#fff;color:#b91c1c;font-weight:700;font-size:11px;padding:2px 8px;border-radius:2px;">見本紙</span>
  <span>これは見本紙です。毎朝・毎夕、あなただけの新聞をお届けします。</span>
  <a href="lp.html" style="background:#fff;color:#b91c1c;font-weight:700;font-size:12px;padding:4px 14px;border-radius:2px;text-decoration:none;white-space:nowrap;">購読する</a>
  <span style="color:rgba(255,255,255,0.8);font-size:12px;cursor:pointer;text-decoration:underline;" onclick="openInviteModal()">招待コードをお持ちの方</span>
</div>

<!-- SUBSCRIBE TOAST -->
<div class="subscribe-toast" id="subscribeToast">
  <button class="toast-close" onclick="this.parentElement.classList.remove('show')">&times;</button>
  <div class="toast-title">ご購読ありがとうございます</div>
  <div class="toast-body">生成新聞をお届けいたします。毎朝・毎夕の新聞をお楽しみください。</div>
</div>

<!-- GENERATION OVERLAY -->
<div class="gen-overlay" id="genOverlay">
  <div class="gen-title">生成新聞</div>
  <ul class="gen-steps" id="genSteps">
    <li>関心領域を分析中…</li>
    <li>ニュースソースを収集中…</li>
    <li>記事を構成中…</li>
    <li>紙面レイアウトを生成中…</li>
    <li>データを可視化中…</li>
    <li id="genDeliverStep">朝刊を配達中…</li>
  </ul>
</div>

<!-- PROFILE MODAL -->
<div class="profile-overlay" id="profileOverlay" onclick="if(event.target===this)closeProfile()">
  <div class="profile-modal">
    <button class="profile-modal-close" onclick="closeProfile()">&times;</button>
    <div class="profile-title">関心プロファイル</div>
    <div class="profile-sub">あなたの関心に合わせて紙面をカスタマイズします</div>

    <div class="profile-section-label">カテゴリ（複数選択可）</div>
    <div class="profile-cats" id="profileCats"></div>

    <div class="profile-section-label">キーワード（最大10個）</div>
    <input class="profile-keywords-input" id="profileKeywordInput" placeholder="キーワードを入力してEnter" onkeydown="if(event.key==='Enter'){event.preventDefault();addKeyword()}">
    <div class="profile-keywords-hint">例: AI、半導体、スタートアップ、宇宙開発</div>
    <div class="profile-tags" id="profileTags"></div>

    <button class="profile-save" id="profileSave" onclick="saveProfile()">保存する</button>
    <div class="profile-msg" id="profileMsg"></div>
  </div>
</div>

<!-- CANCEL MODAL -->
<div class="cancel-overlay" id="cancelOverlay" onclick="if(event.target===this)closeCancelModal()">
  <div class="cancel-modal">
    <button class="cancel-modal-close" onclick="closeCancelModal()">&times;</button>
    <div class="cancel-title">購読を解約</div>
    <div class="cancel-body">
      解約すると、現在の請求期間の終了後に<br>新聞の配信が停止されます。<br>
      期間終了まではこれまで通りお読みいただけます。<br><br>
      <span style="font-size:12px;">※ 無料トライアル期間中に解約すれば料金は発生しません。</span>
    </div>
    <div class="cancel-btns">
      <button class="cancel-btn-back" onclick="closeCancelModal()">戻る</button>
      <button class="cancel-btn-confirm" id="cancelConfirmBtn" onclick="confirmCancel()">解約する</button>
    </div>
    <div class="cancel-msg" id="cancelMsg"></div>
  </div>
</div>

<!-- INVITE MODAL -->
<div class="invite-overlay" id="inviteOverlay" onclick="if(event.target===this)closeInviteModal()">
  <div class="invite-modal">
    <button class="invite-modal-close" onclick="closeInviteModal()">&times;</button>
    <div class="invite-title">体験パス</div>
    <div class="invite-sub">招待コードをお持ちの方は、メールアドレスとコードを入力してください。<br>7日間無料で新聞をお読みいただけます。</div>
    <div class="invite-field">
      <label>メールアドレス</label>
      <input type="email" id="inviteEmail" placeholder="example@email.com">
    </div>
    <div class="invite-field">
      <label>招待コード</label>
      <input type="text" id="inviteCode" placeholder="例: PAUL" style="text-transform:uppercase;">
    </div>
    <button class="invite-submit" id="inviteSubmit" onclick="submitInvite()">体験パスを有効にする</button>
    <div class="invite-msg" id="inviteMsg"></div>
  </div>
</div>

<!-- MASTHEAD -->
<header class="masthead gen-animate">
  <div class="masthead-top">
    <span id="mastheadDate">令和七年 二月十二日（水曜日）</span>
    <div class="edition-toggle">
      <button class="edition-btn active" id="btnMorning" onclick="switchEdition('morning')">朝刊</button>
      <button class="edition-btn" id="btnEvening" onclick="switchEdition('evening')">夕刊</button>
    </div>
  </div>
  <div class="masthead-center">
    <h1>生成新聞</h1>
    <div class="masthead-en">GENERATED DAILY NEWS</div>
  </div>
  <div class="masthead-issue">
    <span class="issue-badge" id="issueNumber">第〇〇七号</span>
  </div>
  <div class="masthead-divider"></div>
</header>

<!-- TICKER -->
<div class="ticker gen-animate">
  <div class="ticker-track" id="tickerTrack"></div>
</div>

<main class="content">

  <!-- TOP ARTICLE -->
  <article class="top-article gen-animate">
    <div class="kicker" id="headlineKicker">一面</div>
    <h2 class="top-headline" id="topHeadline"></h2>
    <p class="top-sub" id="topSub"></p>

    <div class="media-frame" id="mediaFrame" style="display:none;">
      <canvas id="heroPhotoCanvas" class="hero-photo-canvas"></canvas>
      <div class="photo-credit" id="photoCredit"></div>
    </div>
    <div class="body-text" id="headlineBody"></div>
  </article>

  <!-- ARTICLES (generated dynamically) -->
  <div id="articlesContainer"></div>

  <!-- 3. 催事（展示会・映画） -->
  <div class="culture-block gen-animate" id="cultureBlock" style="display:none;">
    <div class="culture-header">
      <span class="culture-title">催事</span>
      <span class="culture-sub">EXHIBITIONS & FILMS</span>
    </div>
    <div class="culture-body" id="cultureBody"></div>
  </div>

  <!-- 4. 天気と服装 -->
  <div class="weather-block gen-animate" id="weatherFashionBlock" style="display:none;">
    <div class="weather-header">
      <div>
        <div class="weather-title-row">
          <span class="weather-title">天気と服装</span>
          <span class="weather-area">恵比寿</span>
        </div>
        <div class="weather-data" id="weatherData"></div>
      </div>
      <div class="weather-advice" id="weatherAdvice"></div>
    </div>
    <div class="weather-tip-row" id="weatherTip"></div>
  </div>

  <!-- 5. ご近所情報 -->
  <div class="local-block gen-animate" id="localNewsBlock" style="display:none;">
    <div class="local-header">
      <span class="local-title">ご近所情報</span>
      <span class="local-area" id="localNewsArea"></span>
    </div>
    <div class="local-body" id="localNewsBody"></div>
  </div>

  <!-- 6. GEN ART（視覚的区切り） -->
  <div class="gen-art gen-animate">
    <canvas id="genArt"></canvas>
    <div class="gen-art-tag">INFORMATION FLOW — REAL-TIME GENERATIVE VISUALIZATION</div>
  </div>

  <!-- 7. 天声生成 -->
  <div class="column-block gen-animate">
    <div class="column-head">
      <div>
        <div class="column-stamp" id="columnTitle">天声生成</div>
        <div class="column-stamp-sub" id="columnSub">TENSEI GENERATED — AI朝刊コラム</div>
      </div>
    </div>
    <div class="column-body" id="columnBody"></div>
  </div>

  <!-- 8. ネットで話題（はてブホットエントリ） -->
  <div class="corner-block gen-animate" id="snsTrendBlock" style="display:none;">
    <div class="corner-body" id="snsTrendBody"></div>
  </div>

  <!-- 9. 数字で読む -->
  <div class="sec-rule gen-animate" id="numbersHeader"><span>数字で読む</span></div>
  <div class="stories-list gen-animate" id="highlightsContainer"></div>

</main>

<footer>
  <div class="f-logo">生成新聞</div>
  <div class="f-tagline">あなたの関心から、生まれる新聞。</div>
  <div class="f-edition-info">朝刊 06:00 ／ 夕刊 17:00</div>
  <div class="f-stamp">
    <span class="f-dot"></span>
    <span id="genTimeStamp">GENERATED AT 06:00 JST</span>
  </div>
  <div class="user-bar gen-animate" id="userBar"></div>
</footer>

<script>
// ===== CONFIG =====
const API_URL = 'https://news-generator.hiroshinagano0113.workers.dev/api/generate';
const AUTH_API = 'https://auth-api.hiroshinagano0113.workers.dev';
let currentNewspaper = null;

// ===== XSS ESCAPE =====
function escapeForDisplay(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// ===== AUTH USER BAR =====
const PUSH_API = 'https://push-api.hiroshinagano0113.workers.dev';

let _pushSubActive = false;
let _emailNotifyActive = true; // デフォルトtrue

function getPushToggleHtml() {
  if (!('Notification' in window) || !('PushManager' in window)) return '';
  const perm = Notification.permission;
  if (perm === 'denied') {
    return '<span class="push-toggle-wrap"><span class="push-toggle-label">通知</span><span class="push-toggle-track disabled"><span class="push-toggle-thumb"></span></span></span>';
  }
  const onClass = _pushSubActive ? ' on' : '';
  return '<span class="push-toggle-wrap" onclick="togglePushSubscription()" id="pushToggle"><span class="push-toggle-label">通知</span><span class="push-toggle-track' + onClass + '"><span class="push-toggle-thumb"></span></span></span>';
}

function getEmailToggleHtml() {
  const onClass = _emailNotifyActive ? ' on' : '';
  return '<span class="push-toggle-wrap" onclick="toggleEmailNotify()" id="emailToggle"><span class="push-toggle-label">メール</span><span class="push-toggle-track' + onClass + '"><span class="push-toggle-thumb"></span></span></span>';
}

async function toggleEmailNotify() {
  const email = localStorage.getItem('auth_email');
  if (!email) return;

  const newState = !_emailNotifyActive;
  try {
    const res = await fetch(PAYMENT_API + '/api/email-notify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: email, enabled: newState }),
    });
    if (res.ok) {
      _emailNotifyActive = newState;
      updateUserBar();
    }
  } catch (e) {
    console.error('Email notify toggle failed:', e);
  }
}
// Check actual push subscription state on load
if ('serviceWorker' in navigator && 'PushManager' in window) {
  navigator.serviceWorker.ready.then(function(reg) {
    reg.pushManager.getSubscription().then(function(sub) {
      _pushSubActive = !!sub;
      updateUserBar();
    });
  });
}

function updateUserBar() {
  const bar = document.getElementById('userBar');
  const email = localStorage.getItem('auth_email');
  const isInvite = localStorage.getItem('invite_user') === 'true';

  if (email && isInvite) {
    // 招待ユーザー
    const expires = localStorage.getItem('invite_expires');
    const expiresDate = expires ? new Date(expires).toLocaleDateString('ja-JP') : '';
    const expiresText = expiresDate ? '（' + expiresDate + 'まで）' : '';
    const inviteEmailToggle = getEmailToggleHtml();
    bar.innerHTML = '<span class="user-bar-email">' + email + '</span>' +
      '<span class="user-bar-sep">|</span>' +
      '<span style="font-size:10px;color:var(--caption);">体験パス' + expiresText + '</span>' +
      '<span class="user-bar-sep">|</span>' +
      inviteEmailToggle +
      '<span class="user-bar-sep">|</span>' +
      '<a class="user-bar-link" href="lp.html">正式購読する</a>' +
      '<span class="user-bar-sep">|</span>' +
      '<span class="user-bar-link" onclick="handleInviteLogout()">ログアウト</span>';
  } else if (email) {
    // 認証ユーザー
    const pushToggle = getPushToggleHtml();
    const pushPart = pushToggle ? '<span class="user-bar-sep">|</span>' + pushToggle : '';
    const emailToggle = getEmailToggleHtml();
    const emailPart = '<span class="user-bar-sep">|</span>' + emailToggle;
    bar.innerHTML = '<span class="user-bar-email">' + email + '</span>' +
      '<span class="user-bar-sep">|</span>' +
      '<span class="user-bar-link" onclick="openProfile()">関心設定</span>' +
      pushPart +
      emailPart +
      '<span class="user-bar-sep">|</span>' +
      '<span class="user-bar-link" onclick="openCancelModal()">購読管理</span>' +
      '<span class="user-bar-sep">|</span>' +
      '<span class="user-bar-link" onclick="handleLogoutIndex()">ログアウト</span>';
  } else {
    // 未認証
    bar.innerHTML = '<a class="user-bar-link" href="lp.html">ログイン / 新規登録</a>' +
      '<span class="user-bar-sep">|</span>' +
      '<span class="user-bar-link" onclick="openInviteModal()">招待コードをお持ちの方</span>';
  }
}

function handleLogoutIndex() {
  const token = localStorage.getItem('auth_token');
  if (token) {
    fetch(AUTH_API + '/api/logout', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + token },
    }).catch(() => {});
  }
  localStorage.removeItem('auth_token');
  localStorage.removeItem('auth_email');
  updateUserBar();
}

function handleInviteLogout() {
  localStorage.removeItem('auth_email');
  localStorage.removeItem('invite_user');
  localStorage.removeItem('invite_expires');
  updateUserBar();
}

// ===== WEB PUSH 通知 =====
async function togglePushSubscription() {
  if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
    alert('このブラウザはプッシュ通知に対応していません。');
    return;
  }

  const reg = await navigator.serviceWorker.ready;
  const existingSub = await reg.pushManager.getSubscription();

  if (existingSub) {
    // 購読解除
    try {
      await fetch(PUSH_API + '/api/push/subscribe', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ endpoint: existingSub.endpoint }),
      });
      await existingSub.unsubscribe();
      _pushSubActive = false;
    } catch (e) {
      console.error('Unsubscribe error:', e);
    }
    updateUserBar();
    return;
  }

  // 新規購読
  try {
    const permission = await Notification.requestPermission();
    if (permission !== 'granted') {
      updateUserBar();
      return;
    }

    // VAPID公開鍵を取得
    const vapidRes = await fetch(PUSH_API + '/api/vapid-public-key');
    const { publicKey } = await vapidRes.json();

    // Base64URL → Uint8Array
    const padding = '='.repeat((4 - publicKey.length % 4) % 4);
    const base64 = (publicKey + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64);
    const applicationServerKey = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; i++) applicationServerKey[i] = rawData.charCodeAt(i);

    const subscription = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey,
    });

    // サーバーに登録
    await fetch(PUSH_API + '/api/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        subscription: subscription.toJSON(),
        email: localStorage.getItem('auth_email') || 'anonymous',
      }),
    });

    _pushSubActive = true;
    updateUserBar();
  } catch (e) {
    console.error('Push subscribe error:', e);
    alert('通知の登録に失敗しました。');
  }
}

// ===== PROFILE MODAL =====
const ALL_CATEGORIES = ['総合', 'テクノロジー', '国際', '経済', '社会', '政治', 'スポーツ', 'エンタメ', '文化', '暮らし'];
let profileCategories = [];
let profileKeywords = [];

function openProfile() {
  const token = localStorage.getItem('auth_token');
  if (!token) return;

  const overlay = document.getElementById('profileOverlay');
  const msg = document.getElementById('profileMsg');
  msg.textContent = '';
  msg.className = 'profile-msg';

  // カテゴリボタン生成
  renderCategoryButtons();
  renderKeywordTags();

  // サーバーからプロファイル取得
  fetch(AUTH_API + '/api/profile', {
    headers: { 'Authorization': 'Bearer ' + token },
  }).then(r => r.json()).then(data => {
    if (data.profile) {
      profileCategories = data.profile.categories || [];
      profileKeywords = data.profile.keywords || [];
      renderCategoryButtons();
      renderKeywordTags();
    }
  }).catch(() => {});

  overlay.classList.add('show');
}

function closeProfile() {
  document.getElementById('profileOverlay').classList.remove('show');
}

function renderCategoryButtons() {
  const container = document.getElementById('profileCats');
  container.innerHTML = ALL_CATEGORIES.map(cat => {
    const sel = profileCategories.includes(cat) ? ' selected' : '';
    return '<button class="profile-cat' + sel + '" onclick="toggleCategory(\'' + cat + '\')">' + cat + '</button>';
  }).join('');
}

function toggleCategory(cat) {
  const idx = profileCategories.indexOf(cat);
  if (idx >= 0) profileCategories.splice(idx, 1);
  else profileCategories.push(cat);
  renderCategoryButtons();
}

function renderKeywordTags() {
  const container = document.getElementById('profileTags');
  container.innerHTML = profileKeywords.map((kw, i) =>
    '<span class="profile-tag">' + kw + '<span class="profile-tag-x" onclick="removeKeyword(' + i + ')">×</span></span>'
  ).join('');
}

function addKeyword() {
  const input = document.getElementById('profileKeywordInput');
  const kw = input.value.trim();
  if (!kw || profileKeywords.length >= 10 || profileKeywords.includes(kw)) return;
  profileKeywords.push(kw);
  input.value = '';
  renderKeywordTags();
}

function removeKeyword(idx) {
  profileKeywords.splice(idx, 1);
  renderKeywordTags();
}

async function saveProfile() {
  const token = localStorage.getItem('auth_token');
  if (!token) return;

  const btn = document.getElementById('profileSave');
  const msg = document.getElementById('profileMsg');
  btn.disabled = true;
  btn.textContent = '保存中...';
  msg.textContent = '';
  msg.className = 'profile-msg';

  try {
    const res = await fetch(AUTH_API + '/api/profile', {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + token,
      },
      body: JSON.stringify({ categories: profileCategories, keywords: profileKeywords }),
    });
    const data = await res.json();
    if (data.success) {
      msg.textContent = '保存しました';
      msg.className = 'profile-msg success';
      setTimeout(() => closeProfile(), 1200);
    } else {
      msg.textContent = data.error || '保存に失敗しました';
      msg.className = 'profile-msg error';
    }
  } catch {
    msg.textContent = '通信エラーが発生しました';
    msg.className = 'profile-msg error';
  }
  btn.disabled = false;
  btn.textContent = '保存する';
}

// ===== CANCEL SUBSCRIPTION =====
const PAYMENT_API = 'https://payment-api.hiroshinagano0113.workers.dev';

function openCancelModal() {
  const msg = document.getElementById('cancelMsg');
  msg.textContent = '';
  msg.className = 'cancel-msg';
  document.getElementById('cancelConfirmBtn').disabled = false;
  document.getElementById('cancelOverlay').classList.add('show');
}

function closeCancelModal() {
  document.getElementById('cancelOverlay').classList.remove('show');
}

// URLハッシュ #cancel で解約モーダルを自動表示（メールからの導線）
if (location.hash === '#cancel') {
  openCancelModal();
  history.replaceState(null, '', location.pathname + location.search);
}

async function confirmCancel() {
  const email = localStorage.getItem('auth_email');
  if (!email) return;

  const btn = document.getElementById('cancelConfirmBtn');
  const msg = document.getElementById('cancelMsg');
  btn.disabled = true;
  btn.textContent = '処理中...';
  msg.textContent = '';
  msg.className = 'cancel-msg';

  try {
    const res = await fetch(PAYMENT_API + '/api/cancel', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email }),
    });
    const data = await res.json();

    if (data.success) {
      const endDate = data.currentPeriodEnd
        ? new Date(data.currentPeriodEnd).toLocaleDateString('ja-JP')
        : '';
      msg.textContent = endDate
        ? `解約を受け付けました。${endDate}まで閲覧可能です。`
        : '解約を受け付けました。期間終了まで閲覧可能です。';
      msg.className = 'cancel-msg success';
      setTimeout(() => closeCancelModal(), 3000);
    } else {
      msg.textContent = data.error || '解約に失敗しました';
      msg.className = 'cancel-msg error';
    }
  } catch {
    msg.textContent = '通信エラーが発生しました';
    msg.className = 'cancel-msg error';
  }

  btn.disabled = false;
  btn.textContent = '解約する';
}

// ===== INVITE PASS =====
function openInviteModal() {
  document.getElementById('inviteEmail').value = '';
  document.getElementById('inviteCode').value = '';
  document.getElementById('inviteSubmit').disabled = false;
  document.getElementById('inviteSubmit').textContent = '体験パスを有効にする';
  const msg = document.getElementById('inviteMsg');
  msg.textContent = '';
  msg.className = 'invite-msg';
  // URLパラメータから招待コードを自動入力
  const urlCode = new URLSearchParams(window.location.search).get('invite');
  if (urlCode) {
    document.getElementById('inviteCode').value = urlCode.toUpperCase();
  }
  document.getElementById('inviteOverlay').classList.add('show');
}

function closeInviteModal() {
  document.getElementById('inviteOverlay').classList.remove('show');
}

async function submitInvite() {
  const email = document.getElementById('inviteEmail').value.trim();
  const inviteCode = document.getElementById('inviteCode').value.trim();
  const btn = document.getElementById('inviteSubmit');
  const msg = document.getElementById('inviteMsg');

  if (!email || !email.includes('@')) {
    msg.textContent = 'メールアドレスを正しく入力してください';
    msg.className = 'invite-msg error';
    return;
  }
  if (!inviteCode) {
    msg.textContent = '招待コードを入力してください';
    msg.className = 'invite-msg error';
    return;
  }

  btn.disabled = true;
  btn.textContent = '処理中...';
  msg.textContent = '';
  msg.className = 'invite-msg';

  try {
    const res = await fetch(PAYMENT_API + '/api/invite', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, inviteCode }),
    });
    const data = await res.json();

    if (data.success) {
      localStorage.setItem('auth_email', data.email);
      localStorage.setItem('invite_user', 'true');
      localStorage.setItem('invite_expires', data.expiresAt);

      msg.textContent = data.message;
      msg.className = 'invite-msg success';
      setTimeout(() => {
        closeInviteModal();
        updateUserBar();
      }, 1500);
    } else {
      msg.textContent = data.error || '体験パスの登録に失敗しました';
      msg.className = 'invite-msg error';
      btn.disabled = false;
      btn.textContent = '体験パスを有効にする';
    }
  } catch {
    msg.textContent = '通信エラーが発生しました';
    msg.className = 'invite-msg error';
    btn.disabled = false;
    btn.textContent = '体験パスを有効にする';
  }
}

// セッション検証
(function() {
  const token = localStorage.getItem('auth_token');
  const isInvite = localStorage.getItem('invite_user') === 'true';

  if (token) {
    // 認証ユーザー
    fetch(AUTH_API + '/api/me', {
      headers: { 'Authorization': 'Bearer ' + token },
    }).then(r => r.json()).then(data => {
      if (!data.authenticated) {
        localStorage.removeItem('auth_token');
        localStorage.removeItem('auth_email');
      } else {
        // メール通知設定を読み込み
        const authEmail = localStorage.getItem('auth_email');
        if (authEmail) {
          fetch(PAYMENT_API + '/api/subscriber/' + encodeURIComponent(authEmail))
            .then(r => r.json())
            .then(subData => {
              if (subData.email_notify !== undefined) {
                _emailNotifyActive = subData.email_notify;
              }
              updateUserBar();
            }).catch(() => updateUserBar());
          return;
        }
      }
      updateUserBar();
    }).catch(() => updateUserBar());
  } else if (isInvite) {
    // 招待ユーザー: 期限チェック
    const email = localStorage.getItem('auth_email');
    if (email) {
      fetch(PAYMENT_API + '/api/subscriber/' + encodeURIComponent(email))
        .then(r => r.json())
        .then(data => {
          if (!data.subscribed || data.status === 'invite_expired') {
            localStorage.removeItem('invite_user');
            localStorage.removeItem('invite_expires');
            localStorage.removeItem('auth_email');
            // 期限切れ通知（subscribeToast流用）
            const toast = document.getElementById('subscribeToast');
            toast.querySelector('.toast-title').textContent = '体験パスの期限が終了しました';
            toast.querySelector('.toast-body').textContent = '引き続きご利用いただくには、正式にご購読ください。';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 10000);
          }
          // メール通知設定を読み込み
          if (data.email_notify !== undefined) {
            _emailNotifyActive = data.email_notify;
          }
          updateUserBar();
        })
        .catch(() => updateUserBar());
    } else {
      updateUserBar();
    }
  } else {
    // 未認証 → LPにリダイレクト（特定パラメータ付きURLは除外）
    const params = new URLSearchParams(window.location.search);
    if (!params.has('sample') && !params.has('invite') && !params.has('subscribed') && !window.location.hash.includes('cancel')) {
      window.location.href = 'lp.html';
      return;
    }
    updateUserBar();
  }
})();

// ===== FALLBACK DATA =====
const FALLBACK = {
  date: '令和七年 二月十二日（水曜日）',
  edition: '朝刊',
  issueNumber: '第〇〇七号',
  headline: {
    kicker: '一面',
    title: '生成AIが変える報道の未来——「読む」から「生成される」時代へ',
    body: '二〇二五年、ニュースの届き方が再び大きな転換点を迎えている。かつて新聞配達員が毎朝届けた朝刊のように、いまAIが個人の関心に沿った紙面を生成し、毎朝届ける時代が始まった。紙の時代に培われた「紙面を組む」という行為が、アルゴリズムと大規模言語モデルの手に委ねられつつある。',
    imageKeyword: 'artificial intelligence newspaper'
  },
  articles: [
    { category: 'テクノロジー', label: '人工知能', title: 'マルチモーダルAI、コード生成精度が人間を凌駕', body: '最新のベンチマークで大規模言語モデルがソフトウェア工学の複合タスクにおいて人間の成績を初めて上回った。特にデバッグとリファクタリング領域の飛躍が著しく、現場への導入が加速している。' },
    { category: 'テクノロジー', label: '量子計算', title: '量子コンピュータ、実用化の臨界点に到達か', body: '日米欧の研究機関が同時に、エラー耐性を持つ論理量子ビットの安定動作に成功と発表。商用化に向けた最大の障壁が崩れつつあるとの見方が業界に広がっている。' },
    { category: '国際', label: '宇宙開発', title: 'SpaceX、民間初の火星往還ミッション日程を正式発表', body: '二〇二七年打ち上げ予定。乗組員六名の選考が来月より開始される。月面基地構想との連携も視野に入れた野心的計画である。' },
    { category: '経済', label: '株式市場', title: '日経平均、四万円台を視野——半導体関連銘柄が牽引', body: '国内メーカーの設備投資拡大が市場の楽観ムードを後押し。AI関連需要の拡大が追い風となっている。' },
    { category: '社会', label: '教育改革', title: '東京都、来年度予算にAIリテラシー教育を大幅拡充へ', body: '全公立小中学校にAI活用カリキュラム導入。教員研修も同時開始。デジタル人材育成の基盤構築を急ぐ。' }
  ],
  column: {
    title: '天声生成',
    body: '朝、目が覚めて最初にすることが「画面を見る」になったのは、いつからだろう。かつてそれは新聞を広げることだった。インクの匂い、紙の擦れる音。あの所作には、一日を始める儀式としての重みがあった。\n\n新聞が衰退したのは、情報が遅いからではない。私たちが「待つ」ことをやめたからだ。ニュースは流れてくるものになり、見出しをスワイプで消費するものになった。記事を読むのではなく、見出しを読む。理解するのではなく、知った気になる。\n\n生成新聞という矛盾した名前のメディアが目指すのは、おそらくその逆である。最新の技術を使って、最も古い体験を取り戻す。あなたのために組まれた紙面を、朝、一枚ずつめくるように読む。急がなくていい。この紙面は、あなたが読み終わるまで、どこにも行かない。'
  },
  ticker: [
    { name: '日経平均', value: '38,942', change: '+312' },
    { name: 'TOPIX', value: '2,748', change: '+18' },
    { name: 'ドル円', value: '152.34', change: '-0.42' },
    { name: 'NYダウ', value: '44,128', change: '+186' },
    { name: 'S&P500', value: '6,012', change: '+22' },
    { name: 'BTC', value: '$97,420', change: '+2.8%' }
  ],
  numbers: [
    { number: '38,942', label: '日経平均株価（円）' },
    { number: '13万人', label: '米1月非農業部門雇用者増加数' },
    { number: '1.5℃', label: '産業革命前比の世界平均気温上昇幅' },
    { number: '3.2兆円', label: '国内AI関連投資額（年間推計）' },
    { number: '72km', label: '海洋生物の十年間平均移動距離' }
  ]
};

// ===== RENDER NEWSPAPER =====
function renderNewspaper(data) {
  currentNewspaper = data;

  // 前号のリード文が残らないようリセット
  document.getElementById('topHeadline').textContent = '';
  document.getElementById('topSub').textContent = '';

  // 号数はAPIから返される値を使用（朝刊=奇数, 夕刊=偶数）
  // APIが号数を返さない場合のフォールバック
  if (!data.issueNumber) {
    const nowUtc = Date.now();
    const jstMs = nowUtc + 9 * 60 * 60 * 1000;
    const baseMs = Date.UTC(2026, 0, 1, 0, 0, 0); // 2026-01-01 00:00 UTC = 09:00 JST
    const diffDays = Math.floor((jstMs - (baseMs + 9 * 60 * 60 * 1000)) / (1000 * 60 * 60 * 24)) + 1;
    const days = Math.max(1, diffDays);
    const isMorning = data.edition !== '夕刊';
    const issueNum = isMorning ? (days * 2) - 1 : days * 2;
    const padded = String(issueNum).padStart(3, '0');
    const kanjiMap = {'0':'〇','1':'一','2':'二','3':'三','4':'四','5':'五','6':'六','7':'七','8':'八','9':'九'};
    data.issueNumber = '第' + padded.split('').map(c => kanjiMap[c]).join('') + '号';
  }

  // Title
  document.title = `生成新聞 — ${data.issueNumber}`;

  // Masthead
  document.getElementById('mastheadDate').textContent = data.date;
  document.getElementById('issueNumber').textContent = data.issueNumber;

  // ヒーローキャンバスのテーマ更新
  updateHeroTheme(data);

  // Edition buttons
  const mBtn = document.getElementById('btnMorning');
  const eBtn = document.getElementById('btnEvening');
  if (data.edition === '夕刊') {
    eBtn.classList.add('active'); mBtn.classList.remove('active');
  } else {
    mBtn.classList.add('active'); eBtn.classList.remove('active');
  }

  // Column sub
  const colSub = document.getElementById('columnSub');
  colSub.textContent = data.edition === '夕刊'
    ? 'TENSEI GENERATED — AI夕刊コラム'
    : 'TENSEI GENERATED — AI朝刊コラム';

  // Ticker
  renderTicker(data.ticker || []);

  // Headline body + source
  renderHeadlineBody(data.headline.body, data.headline.sourceUrl, data.headline.sourceName);

  // Articles
  renderArticles(data.articles || []);

  // Column
  renderColumn(data.column);

  // Highlights / Numbers
  renderNumbers(data);

  // 新コーナー
  renderWeatherFashion(data.weatherFashion);
  // ご近所情報はnewspaper本体のデータを使用（step 10bで恵比寿・渋谷に限定済み）
  renderLocalNews(data.localNews);
  renderCulture(data.culture);
  renderSnsTrend(data.snsTrend);


  // Footer — 配達時刻を固定表示（朝刊=06:00、夕刊=17:00）
  const stamp = document.getElementById('genTimeStamp');
  const genTime = data.edition === '夕刊' ? '17:00' : '06:00';
  stamp.textContent = `GENERATED AT ${genTime} JST`;

  // Deliver step text
  const deliverStep = document.getElementById('genDeliverStep');
  if (deliverStep) {
    deliverStep.textContent = data.edition === '夕刊' ? '夕刊を配達中…' : '朝刊を配達中…';
  }
}

function renderTicker(tickers) {
  const track = document.getElementById('tickerTrack');
  if (!tickers.length) return;
  const html = tickers.map(t => {
    const num = parseFloat(String(t.change).replace(/[^0-9.\-]/g, ''));
    const cls = num < 0 ? 'dn' : 'up';
    const arrow = num < 0 ? '▼' : '▲';
    return `<span class="ticker-item">${t.name} ${t.value} <span class="${cls}">${arrow}${t.change.replace(/^[+\-]/, '')}</span></span>`;
  }).join('');
  // 2セット入れて、1セット分の幅だけスクロール → シームレスループ
  track.innerHTML = html + html;
  // 既存のアニメーションを除去してから再設定
  track.style.animation = 'none';
  requestAnimationFrame(() => {
    const halfWidth = track.scrollWidth / 2;
    // 動的にkeyframesを生成（正確な幅を使う）
    const styleId = 'ticker-scroll-style';
    let styleEl = document.getElementById(styleId);
    if (!styleEl) {
      styleEl = document.createElement('style');
      styleEl.id = styleId;
      document.head.appendChild(styleEl);
    }
    styleEl.textContent = `@keyframes tickerScroll { 0% { transform: translateX(0); } 100% { transform: translateX(-${halfWidth}px); } }`;
    track.style.animation = `tickerScroll 30s linear infinite`;
  });
}

function renderHeadlineBody(body, sourceUrl, sourceName) {
  const el = document.getElementById('headlineBody');
  if (!body) return;
  const paragraphs = body.split(/\n\n|\n/).filter(p => p.trim());
  let html = paragraphs.map((p, i) =>
    i === 0 ? `<p class="dropcap">${p}</p>` : `<p>${p}</p>`
  ).join('');
  if (sourceUrl && sourceName) {
    html += `<div style="font-size:10px;color:var(--caption);margin-top:8px;">出典: <a href="${sourceUrl}" target="_blank" rel="noopener" style="color:var(--caption);">${sourceName}</a></div>`;
  }
  el.innerHTML = html;
}

function articlePhotoHtml(a) {
  if (!a.imageUrl) return '';
  const credit = a.imageCredit
    ? `<div class="art-photo-credit">Based on photo by <a href="${a.imageCreditLink || '#'}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">${a.imageCredit}</a> / <a href="${a.unsplashLink || '#'}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">Unsplash</a></div>`
    : '';
  const canvasId = 'artCanvas_' + Math.random().toString(36).slice(2, 8);
  const category = a.category || 'ニュース';
  setTimeout(() => {
    const canvas = document.getElementById(canvasId);
    if (canvas) loadAndPixelate(a.imageUrl, canvas, category, 16, 9);
  }, 50);
  return `<div class="art-photo-wrap"><canvas id="${canvasId}" class="art-photo-canvas"></canvas></div>${credit}`;
}

function renderArticleFull(a) {
  const sourceHtml = a.sourceUrl && a.sourceName
    ? `<div style="font-size:10px;color:var(--caption);margin-top:4px;">出典: <a href="${a.sourceUrl}" target="_blank" rel="noopener" style="color:var(--caption);">${a.sourceName}</a></div>`
    : '';
  return `<div class="sec-rule gen-animate"><span>${a.category}</span></div>
    <div class="duo gen-animate"><div class="duo-item" style="grid-column:1/-1;padding:0;">
      ${articlePhotoHtml(a)}
      <div class="duo-tag">${a.label || a.category}</div>
      <h3>${a.title}</h3>
      <p>${a.body}</p>
      ${sourceHtml}
    </div></div>`;
}

function renderArticles(articles) {
  const container = document.getElementById('articlesContainer');
  if (!articles.length) return;

  let html = '';
  let i = 0;

  while (i < articles.length) {
    const a = articles[i];

    // 写真あり → 全幅1カラム
    if (a.imageUrl) {
      html += renderArticleFull(a);
      i++;
      continue;
    }

    // 写真なし → 次の記事も写真なしなら2カラム並び
    const next = articles[i + 1];
    if (next && !next.imageUrl) {
      const cat = a.category || 'ニュース';
      html += `<div class="sec-rule gen-animate"><span>${cat}</span></div>`;
      html += '<div class="duo gen-animate">';
      html += [a, next].map(x => {
        const srcHtml = x.sourceUrl && x.sourceName
          ? `<div style="font-size:10px;color:var(--caption);margin-top:4px;">出典: <a href="${x.sourceUrl}" target="_blank" rel="noopener" style="color:var(--caption);">${x.sourceName}</a></div>`
          : '';
        return `<div class="duo-item">
          <div class="duo-tag">${x.label || x.category}</div>
          <h3>${x.title}</h3>
          <p>${x.body}</p>
          ${srcHtml}
        </div>`;
      }).join('');
      html += '</div>';
      i += 2;
    } else {
      // 写真なし + 次が写真あり（or 最後の1件） → 全幅
      html += renderArticleFull(a);
      i++;
    }
  }

  container.innerHTML = html;
}

function renderColumn(column) {
  if (!column) return;
  const titleEl = document.getElementById('columnTitle');
  const bodyEl = document.getElementById('columnBody');
  titleEl.textContent = '天声生成';
  const paragraphs = column.body.split(/\n\n|\n/).filter(p => p.trim());
  bodyEl.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
}

function renderNumbers(data) {
  const container = document.getElementById('highlightsContainer');
  const header = document.getElementById('numbersHeader');
  // Resolve source: prefer numbers, fall back to highlights (legacy)
  const items = data.numbers || data.highlights || [];
  if (!items.length) {
    if (header) header.style.display = 'none';
    container.style.display = 'none';
    return;
  }
  const isLegacy = !data.numbers && !!data.highlights;
  container.innerHTML = items.map(n => {
    const num   = isLegacy ? n.title   : n.number;
    const label = isLegacy ? n.summary : n.label;
    return `<div class="s-item">
      <span class="s-num">${num || ''}</span>
      <span class="s-label">${label || ''}</span>
    </div>`;
  }).join('');
}

function renderSnsTrend(snsTrend) {
  const block = document.getElementById('snsTrendBlock');
  const bodyEl = document.getElementById('snsTrendBody');
  if (!snsTrend || !snsTrend.items || snsTrend.items.length === 0) {
    block.style.display = 'none';
    return;
  }
  block.style.display = '';

  const title = snsTrend.title || 'ネットで話題';

  // プラットフォームの種類を確認
  const platforms = new Set(snsTrend.items.map(i => i.platform || ''));
  const showPlatformLabel = platforms.size > 1;

  let html = `<div class="sns-platform-label">${title}</div>`;
  let lastPlatform = '';

  for (const item of snsTrend.items) {
    if (showPlatformLabel && item.platform !== lastPlatform) {
      html += `<div class="sns-platform-label">${item.platform}</div>`;
      lastPlatform = item.platform;
    }
    const topicHtml = item.url
      ? `<a href="${item.url}" target="_blank" rel="noopener" class="sns-topic-link">▸ ${item.topic}</a>`
      : `▸ ${item.topic}`;
    html += `<div class="sns-item">
      <div class="sns-topic">${topicHtml}</div>
      ${item.description ? `<div class="sns-desc">${item.description}</div>` : ''}
    </div>`;
  }

  bodyEl.innerHTML = html;
}

function renderLocalNews(localNews) {
  const block = document.getElementById('localNewsBlock');
  const areaEl = document.getElementById('localNewsArea');
  const bodyEl = document.getElementById('localNewsBody');
  if (!localNews || !localNews.items || localNews.items.length === 0) {
    block.style.display = 'none';
    return;
  }
  block.style.display = '';
  areaEl.textContent = localNews.area || '';
  bodyEl.innerHTML = localNews.items.map(item => {
    const safeTitle = escapeForDisplay(item.title);
    // HTMLタグが含まれるbodyは古いキャッシュの残骸なので無視
    const rawBody = (item.body && /<[a-z][\s\S]*>/i.test(item.body)) ? '' : (item.body || '');
    const safeBody = escapeForDisplay(rawBody);
    const safeSrc = escapeForDisplay(item.sourceName || item.source);
    const titleHtml = item.sourceUrl
      ? `<a href="${encodeURI(item.sourceUrl)}" target="_blank" rel="noopener">${safeTitle}</a>`
      : item.url
        ? `<a href="${encodeURI(item.url)}" target="_blank" rel="noopener">${safeTitle}</a>`
        : safeTitle;
    return `<div class="local-item">
      <div class="local-item-title">${titleHtml}</div>
      ${safeBody ? `<div class="local-item-body">${safeBody}</div>` : ''}
      ${safeSrc ? `<div class="local-item-source" style="font-size:10px;color:var(--caption);">${safeSrc}</div>` : ''}
    </div>`;
  }).join('');
}

function fetchLocalNewsWithGeolocation() {
  const block = document.getElementById('localNewsBlock');

  if (!navigator.geolocation) {
    block.style.display = 'none';
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      const { latitude, longitude } = pos.coords;
      try {
        const res = await fetch(
          `${API_URL.replace('/api/generate', '')}/api/local-news?lat=${latitude}&lon=${longitude}`,
          { signal: AbortSignal.timeout(15000) }
        );
        if (!res.ok) throw new Error('API error: ' + res.status);
        const data = await res.json();
        if (data.localNews) {
          renderLocalNews(data.localNews);
        } else {
          block.style.display = 'none';
        }
      } catch (err) {
        console.warn('Local news fetch failed:', err);
        block.style.display = 'none';
      }
    },
    () => {
      // 位置情報拒否 → セクション非表示
      block.style.display = 'none';
    },
    { enableHighAccuracy: false, timeout: 10000, maximumAge: 600000 }
  );
}

function renderWeatherFashion(wf) {
  const block = document.getElementById('weatherFashionBlock');
  const dataEl = document.getElementById('weatherData');
  const adviceEl = document.getElementById('weatherAdvice');
  const tipEl = document.getElementById('weatherTip');
  if (!wf) {
    block.style.display = 'none';
    return;
  }
  block.style.display = '';
  dataEl.innerHTML =
    `<div class="weather-data-temp">${wf.tempHigh || ''}℃ <small>/ ${wf.tempLow || ''}℃</small></div>` +
    `<div class="weather-data-detail">${wf.weather || ''}　降水 ${wf.rain || ''}</div>`;
  const items = wf.items || (wf.advice ? wf.advice.split(/[・\/\s]+/).filter(Boolean) : []);
  adviceEl.innerHTML = items.map(item => `<span class="weather-item-tag">${item}</span>`).join('');
  tipEl.style.display = 'none';
}

function renderCulture(culture) {
  const block = document.getElementById('cultureBlock');
  const bodyEl = document.getElementById('cultureBody');
  if (!culture || !culture.items || culture.items.length === 0) {
    block.style.display = 'none';
    return;
  }
  block.style.display = '';

  // タイプごとにグループ化
  const grouped = {};
  for (const item of culture.items) {
    const t = item.type || 'その他';
    if (!grouped[t]) grouped[t] = [];
    grouped[t].push(item);
  }

  let html = '';
  for (const [type, items] of Object.entries(grouped)) {
    html += `<div class="culture-type-label">${escapeForDisplay(type)}</div>`;
    html += items.map(item => {
      const safeTitle = escapeForDisplay(item.title);
      const safeVenue = escapeForDisplay(item.venue);
      const safePeriod = escapeForDisplay(item.period);
      const rawDesc = escapeForDisplay(item.description);
      const safeDesc = rawDesc.length > 30 ? rawDesc.slice(0, 30) + '…' : rawDesc;
      const safeSrc = escapeForDisplay(item.sourceName || item.source);
      const titleHtml = item.sourceUrl
        ? `<a href="${encodeURI(item.sourceUrl)}" target="_blank" rel="noopener">${safeTitle}</a>`
        : item.url
          ? `<a href="${encodeURI(item.url)}" target="_blank" rel="noopener">${safeTitle}</a>`
          : safeTitle;
      const metaParts = [];
      if (safeVenue) metaParts.push(safeVenue);
      if (safePeriod) metaParts.push(safePeriod);
      if (safeSrc) metaParts.push(safeSrc);
      return `<div class="culture-item">
        <div class="culture-item-title">${titleHtml}</div>
        ${metaParts.length > 0 ? `<div class="culture-item-meta">${metaParts.join('　')}</div>` : ''}
        ${safeDesc ? `<div class="culture-item-desc">${safeDesc}</div>` : ''}
      </div>`;
    }).join('');
  }
  bodyEl.innerHTML = html;
}

// ===== DETECT EDITION (JST) =====
function detectEdition() {
  // getUTCHours()を使い、手動でJST(+9)に変換（ブラウザのタイムゾーンに依存しない）
  const jstHour = (new Date().getUTCHours() + 9) % 24;
  return (jstHour >= 6 && jstHour < 17) ? 'morning' : 'evening';
}

// ===== FETCH NEWSPAPER =====
// フォールバック付き: 該当版がまだ生成されていなければ反対の版を取得
async function fetchNewspaper(edition) {
  if (!edition) edition = detectEdition();
  const url = `${API_URL}?edition=${edition}`;
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 45000);
  try {
    const response = await fetch(url, { signal: controller.signal });
    clearTimeout(timeoutId);
    if (!response.ok) throw new Error(`API ${response.status}`);
    const data = await response.json();
    return { newspaper: data.newspaper, actualEdition: edition };
  } catch (err) {
    clearTimeout(timeoutId);
    if (err.name === 'AbortError') throw new Error('API timeout (45s)');
    throw err;
  }
}

// ===== EDITION SWITCH =====
function showEditionToast(title, body) {
  const toast = document.getElementById('subscribeToast');
  toast.querySelector('.toast-title').textContent = title;
  toast.querySelector('.toast-body').textContent = body;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 5000);
}

function switchEdition(ed) {
  const mBtn = document.getElementById('btnMorning');
  const eBtn = document.getElementById('btnEvening');
  const currentEdition = detectEdition();

  // 朝の時間帯に夕刊を選んだ場合 → まだ未配達
  if (ed === 'evening' && currentEdition === 'morning') {
    showEditionToast('夕刊は未配達です', '本日の夕刊は17時ごろに配達予定です。');
    return;
  }

  if (ed === 'morning') {
    mBtn.classList.add('active'); eBtn.classList.remove('active');
  } else {
    eBtn.classList.add('active'); mBtn.classList.remove('active');
  }

  // Hide content
  document.querySelectorAll('.gen-animate').forEach(el => el.classList.remove('gen-visible'));

  // Fetch new edition
  fetchNewspaper(ed).then(result => {
    renderNewspaper(result.newspaper);
    // Re-observe new gen-animate elements
    setTimeout(() => {
      document.querySelectorAll('.gen-animate').forEach((el, i) => {
        setTimeout(() => el.classList.add('gen-visible'), i * 80);
      });
      typeHeadline(result.newspaper.headline.title);
      typeSub(result.newspaper.headline.body);
    }, 150);
  }).catch(() => {
    // On error, just re-show
    setTimeout(() => {
      document.querySelectorAll('.gen-animate').forEach((el, i) => {
        setTimeout(() => el.classList.add('gen-visible'), i * 80);
      });
    }, 150);
  });
}

// ===== GENERATION SEQUENCE + API FETCH =====
(function() {
  const overlay = document.getElementById('genOverlay');
  const steps = document.querySelectorAll('#genSteps li');

  // ステップリストの左端をロゴの左端に揃える
  requestAnimationFrame(() => {
    const title = overlay.querySelector('.gen-title');
    const stepList = document.getElementById('genSteps');
    if (title && stepList) {
      const titleRect = title.getBoundingClientRect();
      stepList.style.paddingLeft = titleRect.left + 'px';
    }
  });
  let step = 0;
  let newspaperData = null;
  let apiDone = false;
  let animDone = false;

  // Set initial edition button state based on JST time
  const initialEdition = detectEdition();
  if (initialEdition === 'evening') {
    document.getElementById('btnMorning').classList.remove('active');
    document.getElementById('btnEvening').classList.add('active');
  }

  // 招待コードパラメータ: ?invite=CODE があればモーダルを自動表示
  const inviteParam = new URLSearchParams(window.location.search).get('invite');
  if (inviteParam) {
    openInviteModal();
  }

  // 見本紙モード: ?sample=ID がURLにある場合
  const sampleId = new URLSearchParams(window.location.search).get('sample');
  if (sampleId) {
    // 見本紙バナーを表示
    const banner = document.getElementById('sampleBanner');
    if (banner) banner.style.display = 'flex';
    // 版切り替えボタンを非表示
    const editionBar = document.querySelector('.edition-bar');
    if (editionBar) editionBar.style.display = 'none';
    // 見本紙データを取得
    fetch(`https://news-generator.hiroshinagano0113.workers.dev/api/sample/${sampleId}`)
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(data => { newspaperData = data.newspaper; })
      .catch(err => { console.warn('Sample fetch failed:', err); newspaperData = FALLBACK; })
      .finally(() => { apiDone = true; tryReveal(); });
  } else {
    // 通常モード: Start API fetch immediately with detected edition
    // API側にフォールバックロジックがあるため、フロントはシンプルにリクエスト
    fetchNewspaper(initialEdition).then(result => {
      newspaperData = result.newspaper;
    }).catch(err => {
      console.warn('API fetch failed, using fallback:', err);
      newspaperData = FALLBACK;
    }).finally(() => {
      apiDone = true;
      tryReveal();
    });
  }

  function nextStep() {
    if (step > 0) { steps[step-1].classList.remove('active'); steps[step-1].classList.add('done-step'); }
    if (step < steps.length) {
      steps[step].classList.add('active');
      step++;
      setTimeout(nextStep, 500 + Math.random() * 400);
    } else {
      animDone = true;
      tryReveal();
    }
  }

  function tryReveal() {
    if (!apiDone || !animDone) return;
    if (tryReveal._fired) return;
    tryReveal._fired = true;
    // Render with API data or fallback
    const data = newspaperData || FALLBACK;
    renderNewspaper(data);

    setTimeout(() => {
      overlay.classList.add('done');
      revealContent(data);
    }, 600);
  }

  function revealContent(data) {
    const animEls = document.querySelectorAll('.gen-animate');
    let d = 0;
    animEls.forEach(el => { setTimeout(() => el.classList.add('gen-visible'), d); d += 180; });
    setTimeout(() => typeHeadline(data.headline.title), 400);
    setTimeout(() => typeSub(data.headline.body), 2200);

    // 購読成功トースト表示
    const params = new URLSearchParams(window.location.search);
    if (params.get('subscribed') === 'true') {
      setTimeout(() => {
        document.getElementById('subscribeToast').classList.add('show');
        // 8秒後に自動で消す
        setTimeout(() => {
          document.getElementById('subscribeToast').classList.remove('show');
        }, 8000);
      }, 2000);
      // URLからパラメータを削除（履歴を汚さない）
      const cleanUrl = window.location.pathname;
      window.history.replaceState({}, '', cleanUrl);
    }

    // ?invite=XXXX の処理は revealContent 外 (IIFE末尾) で実行
  }

  setTimeout(nextStep, 600);

  // Safety: force reveal with fallback after 50s to prevent infinite loading
  setTimeout(() => {
    if (!tryReveal._fired) {
      console.warn('Safety timeout: forcing reveal with fallback data');
      if (!newspaperData) newspaperData = FALLBACK;
      apiDone = true;
      animDone = true;
      tryReveal();
    }
  }, 50000);
})();

// ===== ?invite=XXXX 招待モーダル自動表示 =====
(function() {
  var inviteParams = new URLSearchParams(window.location.search);
  var inviteCode = inviteParams.get('invite');
  if (!inviteCode) return;
  // URLパラメータを即座にクリーン（履歴を汚さない）
  window.history.replaceState({}, '', window.location.pathname);
  // ログイン済み or 招待済みユーザーはスキップ
  var isLoggedIn = !!localStorage.getItem('auth_email');
  var isInviteUser = localStorage.getItem('invite_user') === 'true';
  if (isLoggedIn || isInviteUser) return;
  // ページ表示完了を待ってからモーダルを開く（ローディング完了後）
  var _inviteTimer = setInterval(function() {
    var overlay = document.querySelector('.gen-overlay');
    if (overlay && overlay.classList.contains('done')) {
      clearInterval(_inviteTimer);
      setTimeout(function() {
        openInviteModal();
        document.getElementById('inviteCode').value = inviteCode.toUpperCase();
      }, 800);
    }
  }, 300);
  // 安全策: 60秒で諦める
  setTimeout(function() { clearInterval(_inviteTimer); }, 60000);
})();

// ===== TYPEWRITER =====
function typeHeadline(text) {
  const el = document.getElementById('topHeadline');
  if (!text) return;
  el.textContent = '';
  el.classList.add('typing-cursor');
  let i = 0;
  const t = setInterval(() => {
    el.textContent = text.slice(0, ++i);
    if (i >= text.length) { clearInterval(t); el.classList.remove('typing-cursor'); }
  }, 45);
}
function typeSub(body) {
  const el = document.getElementById('topSub');
  if (!body) return;
  // Use first sentence as sub-headline
  const firstSentence = body.split(/。/)[0] + '。';
  el.textContent = '';
  el.classList.add('typing-cursor');
  let i = 0;
  const t = setInterval(() => {
    el.textContent = firstSentence.slice(0, ++i);
    if (i >= firstSentence.length) { clearInterval(t); el.classList.remove('typing-cursor'); }
  }, 35);
}

// ===== PIXELATION ENGINE =====
const CATEGORY_TINTS = {
  '経済':         { tint: [0, 60, 120],  strength: 0.2  },
  'テクノロジー': { tint: [80, 0, 160],  strength: 0.2  },
  '政治':         { tint: [120, 20, 20], strength: 0.15 },
  '社会':         { tint: [0, 80, 40],   strength: 0.15 },
  '国際':         { tint: [20, 20, 80],  strength: 0.15 },
  '文化':         { tint: [100, 20, 60], strength: 0.2  },
  '一面':         { tint: [40, 20, 20],  strength: 0.1  },
};

function pixelateToCanvas(img, canvas, category, aspectW, aspectH) {
  const pixelSize = 10;
  const posterizeLevels = 16;
  const contrast = 1.4;
  const palette = CATEGORY_TINTS[category] || CATEGORY_TINTS['一面'];
  const tint = palette.tint;
  const tintStr = palette.strength;

  // Canvas幅はコンテナに合わせる（後でCSS width:100%で伸縮）
  const outW = Math.floor(canvas.parentElement.getBoundingClientRect().width);
  const outH = Math.floor(outW * (aspectH / aspectW));
  const cols = Math.ceil(outW / pixelSize);
  const rows = Math.ceil(outH / pixelSize);

  canvas.width = outW;
  canvas.height = outH;
  const ctx = canvas.getContext('2d');

  // 縮小キャンバスで元画像をサンプリング
  const small = document.createElement('canvas');
  small.width = cols; small.height = rows;
  const sCtx = small.getContext('2d');

  // アスペクト比を合わせてセンタークロップ
  const srcRatio = aspectW / aspectH;
  const imgRatio = img.naturalWidth / img.naturalHeight;
  let sx = 0, sy = 0, sw = img.naturalWidth, sh = img.naturalHeight;
  if (imgRatio > srcRatio) {
    sw = img.naturalHeight * srcRatio;
    sx = (img.naturalWidth - sw) / 2;
  } else {
    sh = img.naturalWidth / srcRatio;
    sy = (img.naturalHeight - sh) / 2;
  }
  sCtx.drawImage(img, sx, sy, sw, sh, 0, 0, cols, rows);
  const data = sCtx.getImageData(0, 0, cols, rows).data;

  // 背景
  ctx.fillStyle = '#0a0a0a';
  ctx.fillRect(0, 0, outW, outH);

  const step = 256 / posterizeLevels;
  for (let row = 0; row < rows; row++) {
    for (let col = 0; col < cols; col++) {
      const i = (row * cols + col) * 4;
      let r = data[i], g = data[i+1], b = data[i+2];
      // カテゴリティント
      r = Math.round(r * (1 - tintStr) + tint[0] * tintStr);
      g = Math.round(g * (1 - tintStr) + tint[1] * tintStr);
      b = Math.round(b * (1 - tintStr) + tint[2] * tintStr);
      // コントラスト強調
      r = Math.min(255, Math.max(0, Math.round(((r/255 - 0.5) * contrast + 0.5) * 255)));
      g = Math.min(255, Math.max(0, Math.round(((g/255 - 0.5) * contrast + 0.5) * 255)));
      b = Math.min(255, Math.max(0, Math.round(((b/255 - 0.5) * contrast + 0.5) * 255)));
      // ポスタライズ
      r = Math.round(r / step) * step;
      g = Math.round(g / step) * step;
      b = Math.round(b / step) * step;
      ctx.fillStyle = `rgb(${Math.max(0,Math.min(255,r))},${Math.max(0,Math.min(255,g))},${Math.max(0,Math.min(255,b))})`;
      ctx.fillRect(col * pixelSize, row * pixelSize, pixelSize, pixelSize);
    }
  }
}

function loadAndPixelate(url, canvas, category, aspectW, aspectH) {
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = function() {
    pixelateToCanvas(img, canvas, category, aspectW || 16, aspectH || 9);
  };
  img.onerror = function() {
    // 画像取得失敗時は非表示
    canvas.style.display = 'none';
  };
  img.src = url;
}

// ===== HERO PHOTO =====
function updateHeroTheme(data) {
  if (!data || !data.headline) return;

  const frame = document.getElementById('mediaFrame');
  const canvas = document.getElementById('heroPhotoCanvas');
  const credit = document.getElementById('photoCredit');

  if (data.headline.imageUrl) {
    frame.style.display = '';
    canvas.style.display = 'block';
    const category = data.headline.category || data.headline.kicker || '一面';
    loadAndPixelate(data.headline.imageUrl, canvas, category, 16, 9);

    if (data.headline.imageCredit) {
      const creditLink = data.headline.imageCreditLink || '#';
      const unsplashLink = data.headline.unsplashLink || 'https://unsplash.com';
      credit.innerHTML = `Based on photo by <a href="${creditLink}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">${data.headline.imageCredit}</a> / <a href="${unsplashLink}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">Unsplash</a>`;
    } else {
      credit.innerHTML = '';
    }
  } else {
    frame.style.display = 'none';
  }
}

// ===== GEN ART =====
(function() {
  const c = document.getElementById('genArt'), ctx = c.getContext('2d');
  function resize() {
    const r = c.parentElement.getBoundingClientRect();
    c.width = r.width * 2; c.height = r.height * 2;
  }
  resize();
  const W=c.width, H=c.height, cols=70, rows=18, cw=W/cols, ch=H/rows;

  function loop(t) {
    ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H);
    for (let x=0;x<cols;x++) for (let y=0;y<rows;y++) {
      const n=Math.sin(x*0.12+t*0.0008)*Math.cos(y*0.18+t*0.0006);
      const v=(n+1)/2;
      if (v>0.55) {
        ctx.fillStyle = v>0.82 ? `rgba(184,32,16,${(v-0.55)*1.8})` : `rgba(243,237,226,${(v-0.55)*0.35})`;
        const s=cw*v*0.85;
        ctx.fillRect(x*cw+(cw-s)/2, y*ch+(ch-s)/2, s, s);
      }
    }
    const sy=(t*0.08)%H;
    ctx.strokeStyle='rgba(184,32,16,0.12)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,sy); ctx.lineTo(W,sy); ctx.stroke();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
<script>
// ===== Service Worker =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').then(reg => {
    // 新SWが見つかったら即座にactivate→リロード
    reg.addEventListener('updatefound', () => {
      const newSW = reg.installing;
      newSW.addEventListener('statechange', () => {
        if (newSW.state === 'activated') location.reload();
      });
    });
    // 既存SWがある場合、明示的に更新チェック
    if (reg.active) reg.update();
  });
}

</script>
</body>
</html>
