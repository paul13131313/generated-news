<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>生成新聞 — 第〇〇七号</title>
<meta name="theme-color" content="#111111">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="生成新聞">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;500;700;900&family=Noto+Sans+JP:wght@300;400;500;700;900&family=Shippori+Mincho:wght@400;500;600;700;800&family=Shippori+Mincho+B1:wght@400;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --ink: #111;
    --paper: #f3ede2;
    --paper-mid: #e9e1d3;
    --accent: #b82010;
    --rule: #222;
    --rule-light: #c4b9a8;
    --caption: #6b6358;
    --font-mincho: 'Shippori Mincho B1', 'Shippori Mincho', 'Noto Serif JP', serif;
    --font-gothic: 'Noto Sans JP', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--paper);
    color: var(--ink);
    font-family: var(--font-mincho);
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 512 512' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.035'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 9999;
  }

  /* ===== GENERATION OVERLAY ===== */
  .gen-overlay {
    position: fixed;
    inset: 0;
    background: var(--ink);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: opacity 1s ease;
  }
  .gen-overlay.done { opacity: 0; pointer-events: none; }

  .gen-overlay .gen-title {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 28px;
    color: var(--paper);
    letter-spacing: 0.5em;
    margin-right: -0.5em;
    margin-bottom: 32px;
    opacity: 0;
    animation: fadeUp 0.8s 0.3s forwards;
  }

  .gen-overlay .gen-steps {
    list-style: none;
    font-family: var(--font-gothic);
    font-size: 12px;
    color: rgba(243,237,226,0.3);
    letter-spacing: 0.12em;
    line-height: 2.4;
    text-align: left;
    width: 260px;
  }

  .gen-steps li {
    opacity: 0;
    transform: translateY(6px);
    transition: all 0.5s ease;
  }
  .gen-steps li.active {
    opacity: 1;
    color: rgba(243,237,226,0.9);
    transform: translateY(0);
  }
  .gen-steps li.done-step {
    opacity: 1;
    color: rgba(243,237,226,0.35);
    transform: translateY(0);
  }
  .gen-steps li::before {
    content: '';
    display: inline-block;
    width: 6px; height: 6px;
    border-radius: 50%;
    margin-right: 10px;
    vertical-align: middle;
    background: rgba(243,237,226,0.15);
    transition: background 0.4s;
  }
  .gen-steps li.active::before {
    background: var(--accent);
    box-shadow: 0 0 8px rgba(184,32,16,0.5);
  }
  .gen-steps li.done-step::before { background: rgba(243,237,226,0.3); }

  @keyframes fadeUp { to { opacity: 1; } }

  /* ===== GEN CONTENT ANIM ===== */
  .gen-animate {
    opacity: 0;
    transform: translateY(8px);
    filter: blur(3px);
    transition: opacity 0.7s ease, transform 0.7s ease, filter 0.7s ease;
  }
  .gen-animate.gen-visible {
    opacity: 1;
    transform: translateY(0);
    filter: blur(0);
  }

  .typing-cursor::after {
    content: '｜';
    color: var(--accent);
    animation: blink 0.7s step-end infinite;
    font-weight: 400;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* ===== MASTHEAD ===== */
  .masthead {
    padding: 16px 16px 0;
    border-bottom: 3px solid var(--rule);
  }

  .masthead-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    padding-bottom: 6px;
    border-bottom: 1px solid var(--rule-light);
    margin-bottom: 8px;
    font-family: var(--font-gothic);
    font-size: 11px;
    letter-spacing: 0.08em;
    color: var(--caption);
  }

  /* Edition toggle */
  .edition-toggle {
    display: flex;
    gap: 0;
    font-family: var(--font-gothic);
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.08em;
  }

  .edition-btn {
    padding: 3px 12px;
    border: 1px solid var(--rule);
    background: none;
    color: var(--caption);
    cursor: pointer;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    letter-spacing: inherit;
    transition: all 0.3s;
  }

  .edition-btn:first-child { border-right: none; }

  .edition-btn.active {
    background: var(--ink);
    color: var(--paper);
    border-color: var(--ink);
  }

  .masthead-center {
    text-align: center;
    padding: 10px 0 8px;
  }

  .masthead-center h1 {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 42px;
    letter-spacing: 0.3em;
    margin-right: -0.3em;
    line-height: 1;
  }

  .masthead-en {
    font-family: var(--font-gothic);
    font-size: 9px;
    font-weight: 500;
    letter-spacing: 0.45em;
    color: var(--caption);
    margin-top: 5px;
  }

  .masthead-rule {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    border-top: 1px solid var(--rule-light);
  }
  .masthead-rule::before, .masthead-rule::after {
    content: ''; flex: 1; height: 0; border-top: 1px solid var(--rule-light);
  }

  .issue-badge {
    font-family: var(--font-gothic);
    font-size: 9px;
    font-weight: 700;
    letter-spacing: 0.15em;
    color: var(--ink);
    padding: 2px 10px;
    border: 1px solid var(--rule);
  }

  .masthead-nav {
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 10px 0;
    font-family: var(--font-mincho);
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.08em;
    color: var(--caption);
  }
  .masthead-nav span.active {
    color: var(--ink);
    font-weight: 700;
    position: relative;
  }
  .masthead-nav span.active::after {
    content: '';
    position: absolute;
    bottom: -4px; left: 0; right: 0;
    height: 2px;
    background: var(--accent);
  }

  /* ===== TICKER ===== */
  .ticker {
    background: var(--ink);
    color: var(--paper);
    padding: 10px 0;
    overflow: hidden;
  }
  .ticker-track {
    display: flex;
    gap: 48px;
    animation: scroll 30s linear infinite;
    white-space: nowrap;
    font-family: var(--font-gothic);
    font-size: 13px;
    font-weight: 500;
    letter-spacing: 0.02em;
  }
  .ticker-track .up { color: #5cc779; }
  .ticker-track .dn { color: #e05040; }
  @keyframes scroll {
    0% { transform: translateX(0); }
    100% { transform: translateX(-50%); }
  }

  /* ===== CONTENT ===== */
  .content { padding: 0 16px; }

  /* ===== TOP ARTICLE ===== */
  .top-article {
    padding: 20px 0 18px;
    border-bottom: 2px solid var(--rule);
  }

  .kicker {
    font-family: var(--font-gothic);
    font-size: 12px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 0.12em;
    margin-bottom: 8px;
  }

  .top-headline {
    font-family: var(--font-mincho);
    font-weight: 800;
    font-size: 30px;
    line-height: 1.35;
    letter-spacing: -0.02em;
    margin-bottom: 6px;
    min-height: 2.7em;
  }

  .top-sub {
    font-family: var(--font-mincho);
    font-size: 17px;
    font-weight: 500;
    line-height: 1.5;
    color: #3a3a3a;
    letter-spacing: -0.01em;
    margin-bottom: 16px;
    min-height: 1.5em;
  }

  /* ===== MEDIA ===== */
  .media-frame {
    position: relative;
    width: 100%;
    aspect-ratio: 16/9;
    overflow: hidden;
    margin-bottom: 6px;
    border: 1px solid var(--rule-light);
  }
  .hero-photo {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }
  .photo-credit {
    font-family: var(--font-gothic);
    font-size: 9px;
    color: var(--caption);
    text-align: right;
    margin-top: 2px;
    margin-bottom: 10px;
  }
  .photo-credit a { color: var(--caption); text-decoration: none; }
  .photo-credit a:hover { text-decoration: underline; }

  /* ===== BODY TEXT ===== */
  .body-text {
    column-count: 2;
    column-gap: 14px;
    column-rule: 1px solid var(--rule-light);
    font-size: 15px;
    line-height: 1.9;
    letter-spacing: -0.01em;
    text-align: justify;
  }
  .body-text p { margin-bottom: 0.6em; text-indent: 1em; }
  .body-text p:first-child { text-indent: 0; }
  .body-text .dropcap::first-letter {
    font-size: 3.4em;
    float: left;
    line-height: 0.8;
    margin: 4px 6px 0 0;
    font-weight: 800;
  }

  /* ===== SECTION RULE ===== */
  .sec-rule {
    display: flex; align-items: center; gap: 10px;
    padding: 22px 0 14px;
  }
  .sec-rule::before, .sec-rule::after {
    content: ''; flex: 1; height: 1px; background: var(--rule);
  }
  .sec-rule span {
    font-family: var(--font-mincho);
    font-size: 14px; font-weight: 700; letter-spacing: 0.2em;
  }

  /* ===== DUO STORIES ===== */
  .duo {
    display: grid;
    grid-template-columns: 1fr 1fr;
    border-bottom: 1px solid var(--rule);
    padding-bottom: 16px;
  }
  .duo-item { padding: 0 12px; }
  .duo-item:first-child { padding-left: 0; }
  .duo-item:first-child:not(:last-child) { border-right: 1px solid var(--rule-light); }
  .duo-item:last-child { padding-right: 0; }
  .duo-tag {
    font-family: var(--font-gothic);
    font-size: 10px; font-weight: 700;
    color: var(--accent); letter-spacing: 0.1em; margin-bottom: 5px;
  }
  .duo-item h3 {
    font-family: var(--font-mincho);
    font-weight: 700; font-size: 18px;
    line-height: 1.4; letter-spacing: -0.02em; margin-bottom: 8px;
  }
  .duo-item p {
    font-size: 13px; line-height: 1.8; color: #3a3a3a; letter-spacing: -0.01em;
  }

  /* ===== ARTICLE PHOTO ===== */
  .art-photo-wrap {
    width: 100%;
    aspect-ratio: 16/9;
    overflow: hidden;
    margin-bottom: 6px;
    border: 1px solid var(--rule-light);
  }
  .art-photo {
    width: 100%; height: 100%;
    object-fit: cover;
    display: block;
  }
  .art-photo-credit {
    font-family: var(--font-gothic);
    font-size: 9px;
    color: var(--caption);
    text-align: right;
    margin-top: 2px;
    margin-bottom: 8px;
  }
  .art-photo-credit a { color: var(--caption); text-decoration: none; }
  .art-photo-credit a:hover { text-decoration: underline; }

  /* ===== STATS ===== */
  .stats {
    display: flex;
    border-bottom: 2px solid var(--rule);
    padding: 16px 0;
  }
  .stat { flex: 1; text-align: center; }
  .stat:not(:last-child) { border-right: 1px solid var(--rule-light); }
  .stat-num {
    font-family: var(--font-gothic);
    font-size: 32px; font-weight: 900;
    letter-spacing: -0.02em; line-height: 1;
  }
  .stat-lbl {
    font-family: var(--font-gothic);
    font-size: 11px; color: var(--caption); margin-top: 4px;
  }
  .stat-chg {
    font-family: var(--font-gothic);
    font-size: 11px; font-weight: 700; margin-top: 3px;
  }
  .stat-chg.up { color: #2a8a4a; }
  .stat-chg.dn { color: var(--accent); }

  /* ===== GEN ART ===== */
  .gen-art {
    position: relative; width: 100%; height: 160px;
    background: var(--ink); margin: 18px 0; overflow: hidden;
    border-top: 1px solid #333; border-bottom: 1px solid #333;
  }
  .gen-art canvas { width: 100%; height: 100%; }
  .gen-art-tag {
    position: absolute; bottom: 6px; left: 8px;
    font-family: var(--font-gothic);
    font-size: 8px; color: rgba(255,255,255,0.35); letter-spacing: 0.18em;
  }

  /* ===== COLUMN (天声生成) ===== */
  .column-block {
    padding: 20px 0;
    border-bottom: 2px solid var(--rule);
  }
  .column-head {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 14px; padding-bottom: 10px;
    border-bottom: 1px solid var(--rule-light);
  }
  .column-stamp {
    font-family: var(--font-mincho);
    font-weight: 800; font-size: 20px; letter-spacing: 0.08em;
  }
  .column-stamp-sub {
    font-family: var(--font-gothic);
    font-size: 10px; color: var(--caption); letter-spacing: 0.06em;
  }
  .column-body {
    font-family: var(--font-mincho);
    font-size: 15px; line-height: 2;
    letter-spacing: -0.01em; text-align: justify;
    position: relative;
  }
  .column-body::before {
    content: '';
    position: absolute; left: -16px; top: 0; bottom: 0;
    width: 3px; background: var(--accent);
  }
  .column-body p { text-indent: 1em; margin-bottom: 0.4em; }

  /* ===== SMALL STORIES ===== */
  .stories-list { padding: 12px 0 8px; }
  .s-item {
    display: flex; gap: 12px; padding: 14px 0;
    border-bottom: 1px solid var(--rule-light); align-items: flex-start;
  }
  .s-item:last-child { border-bottom: none; }
  .s-num {
    font-family: var(--font-gothic);
    font-size: 30px; font-weight: 900;
    color: var(--rule-light); line-height: 1; min-width: 36px;
  }
  .s-item h4 {
    font-family: var(--font-mincho);
    font-weight: 700; font-size: 16px;
    line-height: 1.45; letter-spacing: -0.02em; margin-bottom: 4px;
  }
  .s-item p {
    font-size: 13px; color: var(--caption); line-height: 1.6;
    font-family: var(--font-gothic);
  }

  /* ===== FOOTER ===== */
  footer {
    padding: 24px 16px;
    text-align: center;
    border-top: 3px solid var(--rule);
    margin-top: 16px;
  }
  footer .f-logo {
    font-family: var(--font-mincho);
    font-weight: 800; font-size: 18px;
    letter-spacing: 0.3em; margin-right: -0.3em;
  }
  footer .f-tagline {
    font-family: var(--font-mincho);
    font-size: 14px; color: var(--caption);
    margin-top: 6px; letter-spacing: 0.06em;
  }
  footer .f-edition-info {
    font-family: var(--font-gothic);
    font-size: 11px; color: var(--caption);
    margin-top: 10px; letter-spacing: 0.04em;
    line-height: 1.8;
  }
  footer .f-stamp {
    display: inline-flex; align-items: center; gap: 6px;
    margin-top: 14px; padding: 5px 14px;
    border: 1px solid var(--rule-light);
    font-family: var(--font-gothic);
    font-size: 10px; color: var(--caption); letter-spacing: 0.12em;
  }
  footer .f-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent);
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.4); }
  }
</style>
</head>
<body>

<!-- GENERATION OVERLAY -->
<div class="gen-overlay" id="genOverlay">
  <div class="gen-title">生成新聞</div>
  <ul class="gen-steps" id="genSteps">
    <li>関心領域を分析中…</li>
    <li>ニュースソースを収集中…</li>
    <li>記事を構成中…</li>
    <li>紙面レイアウトを生成中…</li>
    <li>データを可視化中…</li>
    <li id="genDeliverStep">朝刊を配達中…</li>
  </ul>
</div>

<!-- MASTHEAD -->
<header class="masthead gen-animate">
  <div class="masthead-top">
    <span id="mastheadDate">令和七年 二月十二日（水曜日）</span>
    <div class="edition-toggle">
      <button class="edition-btn active" id="btnMorning" onclick="switchEdition('morning')">朝刊</button>
      <button class="edition-btn" id="btnEvening" onclick="switchEdition('evening')">夕刊</button>
    </div>
  </div>
  <div class="masthead-center">
    <h1>生成新聞</h1>
    <div class="masthead-en">GENERATED DAILY NEWS</div>
  </div>
  <div class="masthead-rule">
    <span class="issue-badge" id="issueNumber">第〇〇七号</span>
  </div>
  <nav class="masthead-nav">
    <span class="active">総合</span>
    <span>テクノロジー</span>
    <span>国際</span>
    <span>経済</span>
    <span>文化</span>
  </nav>
</header>

<!-- TICKER -->
<div class="ticker gen-animate">
  <div class="ticker-track" id="tickerTrack"></div>
</div>

<main class="content">

  <!-- TOP ARTICLE -->
  <article class="top-article gen-animate">
    <div class="kicker" id="headlineKicker">一面</div>
    <h2 class="top-headline" id="topHeadline"></h2>
    <p class="top-sub" id="topSub"></p>

    <div class="media-frame" id="mediaFrame" style="display:none;">
      <img id="heroPhoto" class="hero-photo" alt="">
      <div class="photo-credit" id="photoCredit"></div>
    </div>
    <div class="body-text" id="headlineBody"></div>
  </article>

  <!-- ARTICLES (generated dynamically) -->
  <div id="articlesContainer"></div>

  <!-- GEN ART -->
  <div class="gen-art gen-animate">
    <canvas id="genArt"></canvas>
    <div class="gen-art-tag">INFORMATION FLOW — REAL-TIME GENERATIVE VISUALIZATION</div>
  </div>

  <!-- 天声生成 -->
  <div class="column-block gen-animate">
    <div class="column-head">
      <div>
        <div class="column-stamp" id="columnTitle">天声生成</div>
        <div class="column-stamp-sub" id="columnSub">TENSEI GENERATED — AI朝刊コラム</div>
      </div>
    </div>
    <div class="column-body" id="columnBody"></div>
  </div>

  <!-- TOPICS -->
  <div class="sec-rule gen-animate"><span>注目の記事</span></div>

  <div class="stories-list gen-animate" id="highlightsContainer"></div>

  <!-- STATS -->
  <div class="stats gen-animate">
    <div class="stat">
      <div class="stat-num" data-to="1847" data-suf="">0</div>
      <div class="stat-lbl">本日の生成記事数</div>
      <div class="stat-chg up">▲ 12%</div>
    </div>
    <div class="stat">
      <div class="stat-num" data-to="342" data-suf="K">0</div>
      <div class="stat-lbl">読者数</div>
      <div class="stat-chg up">▲ 8.3%</div>
    </div>
    <div class="stat">
      <div class="stat-num" data-to="2" data-suf="回">0</div>
      <div class="stat-lbl">本日の生成回数</div>
      <div class="stat-chg up">朝刊・夕刊</div>
    </div>
  </div>

</main>

<footer>
  <div class="f-logo">生成新聞</div>
  <div class="f-tagline">あなたの関心から、生まれる新聞。</div>
  <div class="f-edition-info">朝刊 06:00 ／ 夕刊 17:00</div>
  <div class="f-stamp">
    <span class="f-dot"></span>
    <span id="genTimeStamp">GENERATED AT 06:00 JST</span>
  </div>
</footer>

<script>
// ===== CONFIG =====
const API_URL = 'https://news-generator.hiroshinagano0113.workers.dev/api/generate';
let currentNewspaper = null;

// ===== FALLBACK DATA =====
const FALLBACK = {
  date: '令和七年 二月十二日（水曜日）',
  edition: '朝刊',
  issueNumber: '第〇〇七号',
  headline: {
    kicker: '一面',
    title: '生成AIが変える報道の未来——「読む」から「生成される」時代へ',
    body: '二〇二五年、ニュースの届き方が再び大きな転換点を迎えている。かつて新聞配達員が毎朝届けた朝刊のように、いまAIが個人の関心に沿った紙面を生成し、毎朝届ける時代が始まった。紙の時代に培われた「紙面を組む」という行為が、アルゴリズムと大規模言語モデルの手に委ねられつつある。',
    imageKeyword: 'artificial intelligence newspaper'
  },
  articles: [
    { category: 'テクノロジー', label: '人工知能', title: 'マルチモーダルAI、コード生成精度が人間を凌駕', body: '最新のベンチマークで大規模言語モデルがソフトウェア工学の複合タスクにおいて人間の成績を初めて上回った。特にデバッグとリファクタリング領域の飛躍が著しく、現場への導入が加速している。' },
    { category: 'テクノロジー', label: '量子計算', title: '量子コンピュータ、実用化の臨界点に到達か', body: '日米欧の研究機関が同時に、エラー耐性を持つ論理量子ビットの安定動作に成功と発表。商用化に向けた最大の障壁が崩れつつあるとの見方が業界に広がっている。' },
    { category: '国際', label: '宇宙開発', title: 'SpaceX、民間初の火星往還ミッション日程を正式発表', body: '二〇二七年打ち上げ予定。乗組員六名の選考が来月より開始される。月面基地構想との連携も視野に入れた野心的計画である。' },
    { category: '経済', label: '株式市場', title: '日経平均、四万円台を視野——半導体関連銘柄が牽引', body: '国内メーカーの設備投資拡大が市場の楽観ムードを後押し。AI関連需要の拡大が追い風となっている。' },
    { category: '社会', label: '教育改革', title: '東京都、来年度予算にAIリテラシー教育を大幅拡充へ', body: '全公立小中学校にAI活用カリキュラム導入。教員研修も同時開始。デジタル人材育成の基盤構築を急ぐ。' }
  ],
  column: {
    title: '天声生成',
    body: '朝、目が覚めて最初にすることが「画面を見る」になったのは、いつからだろう。かつてそれは新聞を広げることだった。インクの匂い、紙の擦れる音。あの所作には、一日を始める儀式としての重みがあった。\n\n新聞が衰退したのは、情報が遅いからではない。私たちが「待つ」ことをやめたからだ。ニュースは流れてくるものになり、見出しをスワイプで消費するものになった。記事を読むのではなく、見出しを読む。理解するのではなく、知った気になる。\n\n生成新聞という矛盾した名前のメディアが目指すのは、おそらくその逆である。最新の技術を使って、最も古い体験を取り戻す。あなたのために組まれた紙面を、朝、一枚ずつめくるように読む。急がなくていい。この紙面は、あなたが読み終わるまで、どこにも行かない。'
  },
  ticker: [
    { name: '日経平均', value: '38,942', change: '+312' },
    { name: 'TOPIX', value: '2,748', change: '+18' },
    { name: 'ドル円', value: '152.34', change: '-0.42' },
    { name: 'NYダウ', value: '44,128', change: '+186' },
    { name: 'S&P500', value: '6,012', change: '+22' },
    { name: 'BTC', value: '$97,420', change: '+2.8%' }
  ],
  highlights: [
    { title: '東京都、来年度予算にAIリテラシー教育を大幅拡充へ', summary: '全公立小中学校にAI活用カリキュラム導入。教員研修も同時開始。' },
    { title: 'SpaceX、民間初の火星往還ミッション日程を正式発表', summary: '二〇二七年打ち上げ予定。乗組員六名の選考が来月より開始される。' },
    { title: '日経平均、四万円台を視野——半導体関連銘柄が牽引', summary: '国内メーカーの設備投資拡大が市場の楽観ムードを後押し。' },
    { title: '新たな音楽生成AIが作曲家との「共創モデル」を提示', summary: '人間の創造性を補完するAI活用の新しい標準形として注目を集める。' },
    { title: '世界の平均気温、観測史上最高を三年連続で更新', summary: 'COP30を控え、各国が排出削減目標の上方修正を迫られる状況に。' }
  ]
};

// ===== RENDER NEWSPAPER =====
function renderNewspaper(data) {
  currentNewspaper = data;

  // 号数を日付ベースで自動採番（2026年1月1日=第〇〇一号）
  const now = new Date();
  const jst = new Date(now.getTime() + 9 * 60 * 60 * 1000);
  const base = new Date('2026-01-01T00:00:00+09:00');
  const diffDays = Math.floor((jst - base) / (1000 * 60 * 60 * 24)) + 1;
  const issueNum = Math.max(1, diffDays);
  const padded = String(issueNum).padStart(3, '0');
  const kanjiMap = {'0':'〇','1':'一','2':'二','3':'三','4':'四','5':'五','6':'六','7':'七','8':'八','9':'九'};
  const kanjiIssue = '第' + padded.split('').map(c => kanjiMap[c]).join('') + '号';
  data.issueNumber = kanjiIssue;

  // Title
  document.title = `生成新聞 — ${data.issueNumber}`;

  // Masthead
  document.getElementById('mastheadDate').textContent = data.date;
  document.getElementById('issueNumber').textContent = data.issueNumber;

  // ヒーローキャンバスのテーマ更新
  updateHeroTheme(data);

  // Edition buttons
  const mBtn = document.getElementById('btnMorning');
  const eBtn = document.getElementById('btnEvening');
  if (data.edition === '夕刊') {
    eBtn.classList.add('active'); mBtn.classList.remove('active');
  } else {
    mBtn.classList.add('active'); eBtn.classList.remove('active');
  }

  // Column sub
  const colSub = document.getElementById('columnSub');
  colSub.textContent = data.edition === '夕刊'
    ? 'TENSEI GENERATED — AI夕刊コラム'
    : 'TENSEI GENERATED — AI朝刊コラム';

  // Ticker
  renderTicker(data.ticker || []);

  // Headline body
  renderHeadlineBody(data.headline.body);

  // Articles
  renderArticles(data.articles || []);

  // Column
  renderColumn(data.column);

  // Highlights
  renderHighlights(data.highlights || []);

  // Footer
  const stamp = document.getElementById('genTimeStamp');
  const footerNow = new Date();
  const jstH = new Date(footerNow.getTime() + 9*60*60*1000).getHours();
  const jstM = new Date(footerNow.getTime() + 9*60*60*1000).getMinutes();
  stamp.textContent = `GENERATED AT ${String(jstH).padStart(2,'0')}:${String(jstM).padStart(2,'0')} JST`;

  // Deliver step text
  const deliverStep = document.getElementById('genDeliverStep');
  if (deliverStep) {
    deliverStep.textContent = data.edition === '夕刊' ? '夕刊を配達中…' : '朝刊を配達中…';
  }
}

function renderTicker(tickers) {
  const track = document.getElementById('tickerTrack');
  if (!tickers.length) return;
  const html = tickers.map(t => {
    const num = parseFloat(String(t.change).replace(/[^0-9.\-]/g, ''));
    const cls = num < 0 ? 'dn' : 'up';
    const arrow = num < 0 ? '▼' : '▲';
    return `<span>${t.name} ${t.value} <span class="${cls}">${arrow}${t.change.replace(/^[+\-]/, '')}</span></span>`;
  }).join('');
  // Duplicate for seamless scroll
  track.innerHTML = html + html;
}

function renderHeadlineBody(body) {
  const el = document.getElementById('headlineBody');
  if (!body) return;
  const paragraphs = body.split(/\n\n|\n/).filter(p => p.trim());
  el.innerHTML = paragraphs.map((p, i) =>
    i === 0 ? `<p class="dropcap">${p}</p>` : `<p>${p}</p>`
  ).join('');
}

function articlePhotoHtml(a) {
  if (!a.imageUrl) return '';
  const credit = a.imageCredit
    ? `<div class="art-photo-credit">Photo by <a href="${a.imageCreditLink || '#'}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">${a.imageCredit}</a> / <a href="${a.unsplashLink || '#'}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">Unsplash</a></div>`
    : '';
  return `<div class="art-photo-wrap"><img class="art-photo" src="${a.imageUrl}" alt="" loading="lazy"></div>${credit}`;
}

function renderArticles(articles) {
  const container = document.getElementById('articlesContainer');
  if (!articles.length) return;

  // Group articles into pairs for duo layout, by category sections
  let html = '';
  const categories = [...new Set(articles.map(a => a.category))];

  // First pair: use duo layout
  if (articles.length >= 2) {
    const cat = articles[0].category || categories[0] || 'ニュース';
    html += `<div class="sec-rule gen-animate"><span>${cat}</span></div>`;
    html += '<div class="duo gen-animate">';
    html += articles.slice(0, 2).map(a => `
      <div class="duo-item">
        ${articlePhotoHtml(a)}
        <div class="duo-tag">${a.label || a.category}</div>
        <h3>${a.title}</h3>
        <p>${a.body}</p>
      </div>
    `).join('');
    html += '</div>';
  }

  // Remaining articles as individual items
  articles.slice(2).forEach(a => {
    html += `<div class="sec-rule gen-animate"><span>${a.category}</span></div>`;
    html += `<div class="duo gen-animate"><div class="duo-item" style="grid-column:1/-1;padding:0;">
      ${articlePhotoHtml(a)}
      <div class="duo-tag">${a.label || a.category}</div>
      <h3>${a.title}</h3>
      <p>${a.body}</p>
    </div></div>`;
  });

  container.innerHTML = html;
}

function renderColumn(column) {
  if (!column) return;
  const titleEl = document.getElementById('columnTitle');
  const bodyEl = document.getElementById('columnBody');
  titleEl.textContent = column.title || '天声生成';
  const paragraphs = column.body.split(/\n\n|\n/).filter(p => p.trim());
  bodyEl.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
}

function renderHighlights(highlights) {
  const container = document.getElementById('highlightsContainer');
  if (!highlights.length) return;
  container.innerHTML = highlights.map((h, i) => `
    <div class="s-item">
      <div class="s-num">${String(i + 1).padStart(2, '0')}</div>
      <div>
        <h4>${h.title}</h4>
        <p>${h.summary}</p>
      </div>
    </div>
  `).join('');
}

// ===== DETECT EDITION (JST) =====
function detectEdition() {
  const jstHour = new Date(Date.now() + 9 * 60 * 60 * 1000).getHours();
  return (jstHour >= 6 && jstHour < 17) ? 'morning' : 'evening';
}

// ===== FETCH NEWSPAPER =====
async function fetchNewspaper(edition) {
  if (!edition) edition = detectEdition();
  const url = `${API_URL}?edition=${edition}`;
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), 45000);
  try {
    const response = await fetch(url, { signal: controller.signal });
    clearTimeout(timeoutId);
    if (!response.ok) throw new Error(`API ${response.status}`);
    const data = await response.json();
    return data.newspaper;
  } catch (err) {
    clearTimeout(timeoutId);
    if (err.name === 'AbortError') throw new Error('API timeout (45s)');
    throw err;
  }
}

// ===== EDITION SWITCH =====
function switchEdition(ed) {
  const mBtn = document.getElementById('btnMorning');
  const eBtn = document.getElementById('btnEvening');

  if (ed === 'morning') {
    mBtn.classList.add('active'); eBtn.classList.remove('active');
  } else {
    eBtn.classList.add('active'); mBtn.classList.remove('active');
  }

  // Hide content
  document.querySelectorAll('.gen-animate').forEach(el => el.classList.remove('gen-visible'));

  // Fetch new edition
  fetchNewspaper(ed).then(data => {
    renderNewspaper(data);
    // Re-observe new gen-animate elements
    setTimeout(() => {
      document.querySelectorAll('.gen-animate').forEach((el, i) => {
        setTimeout(() => el.classList.add('gen-visible'), i * 80);
      });
      typeHeadline(data.headline.title);
    }, 150);
  }).catch(() => {
    // On error, just re-show
    setTimeout(() => {
      document.querySelectorAll('.gen-animate').forEach((el, i) => {
        setTimeout(() => el.classList.add('gen-visible'), i * 80);
      });
    }, 150);
  });
}

// ===== GENERATION SEQUENCE + API FETCH =====
(function() {
  const overlay = document.getElementById('genOverlay');
  const steps = document.querySelectorAll('#genSteps li');
  let step = 0;
  let newspaperData = null;
  let apiDone = false;
  let animDone = false;

  // Set initial edition button state based on JST time
  const initialEdition = detectEdition();
  if (initialEdition === 'evening') {
    document.getElementById('btnMorning').classList.remove('active');
    document.getElementById('btnEvening').classList.add('active');
  }

  // Start API fetch immediately with detected edition
  fetchNewspaper(initialEdition).then(data => {
    newspaperData = data;
  }).catch(err => {
    console.warn('API fetch failed, using fallback:', err);
    newspaperData = FALLBACK;
  }).finally(() => {
    apiDone = true;
    tryReveal();
  });

  function nextStep() {
    if (step > 0) { steps[step-1].classList.remove('active'); steps[step-1].classList.add('done-step'); }
    if (step < steps.length) {
      steps[step].classList.add('active');
      step++;
      setTimeout(nextStep, 500 + Math.random() * 400);
    } else {
      animDone = true;
      tryReveal();
    }
  }

  function tryReveal() {
    if (!apiDone || !animDone) return;
    if (tryReveal._fired) return;
    tryReveal._fired = true;
    // Render with API data or fallback
    const data = newspaperData || FALLBACK;
    renderNewspaper(data);

    setTimeout(() => {
      overlay.classList.add('done');
      revealContent(data);
    }, 600);
  }

  function revealContent(data) {
    const animEls = document.querySelectorAll('.gen-animate');
    let d = 0;
    animEls.forEach(el => { setTimeout(() => el.classList.add('gen-visible'), d); d += 180; });
    setTimeout(() => typeHeadline(data.headline.title), 400);
    setTimeout(() => typeSub(data.headline.body), 2200);
  }

  setTimeout(nextStep, 600);

  // Safety: force reveal with fallback after 50s to prevent infinite loading
  setTimeout(() => {
    if (!tryReveal._fired) {
      console.warn('Safety timeout: forcing reveal with fallback data');
      if (!newspaperData) newspaperData = FALLBACK;
      apiDone = true;
      animDone = true;
      tryReveal();
    }
  }, 50000);
})();

// ===== TYPEWRITER =====
function typeHeadline(text) {
  const el = document.getElementById('topHeadline');
  if (!text) return;
  el.textContent = '';
  el.classList.add('typing-cursor');
  let i = 0;
  const t = setInterval(() => {
    el.textContent = text.slice(0, ++i);
    if (i >= text.length) { clearInterval(t); el.classList.remove('typing-cursor'); }
  }, 45);
}
function typeSub(body) {
  const el = document.getElementById('topSub');
  if (!body) return;
  // Use first sentence as sub-headline
  const firstSentence = body.split(/。/)[0] + '。';
  el.textContent = '';
  el.classList.add('typing-cursor');
  let i = 0;
  const t = setInterval(() => {
    el.textContent = firstSentence.slice(0, ++i);
    if (i >= firstSentence.length) { clearInterval(t); el.classList.remove('typing-cursor'); }
  }, 35);
}

// ===== COUNTER =====
const statObs = new IntersectionObserver(entries => {
  entries.forEach(e => {
    if (!e.isIntersecting) return;
    const el = e.target, to = +el.dataset.to, suf = el.dataset.suf || '';
    let cur = 0; const inc = to / 50;
    const t = setInterval(() => {
      cur += inc; if (cur >= to) { cur = to; clearInterval(t); }
      el.textContent = Math.floor(cur).toLocaleString() + suf;
    }, 30);
    statObs.unobserve(el);
  });
}, { threshold: 0.5 });
document.querySelectorAll('.stat-num').forEach(el => statObs.observe(el));

// ===== HERO PHOTO =====
function updateHeroTheme(data) {
  if (!data || !data.headline) return;

  const frame = document.getElementById('mediaFrame');
  const photo = document.getElementById('heroPhoto');
  const credit = document.getElementById('photoCredit');

  if (data.headline.imageUrl) {
    photo.src = data.headline.imageUrl;
    photo.alt = data.headline.imageKeyword || data.headline.title || '';
    frame.style.display = '';

    if (data.headline.imageCredit) {
      const creditLink = data.headline.imageCreditLink || '#';
      const unsplashLink = data.headline.unsplashLink || 'https://unsplash.com';
      credit.innerHTML = `Photo by <a href="${creditLink}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">${data.headline.imageCredit}</a> on <a href="${unsplashLink}?utm_source=generated_news&utm_medium=referral" target="_blank" rel="noopener">Unsplash</a>`;
    } else {
      credit.innerHTML = '';
    }
  } else {
    frame.style.display = 'none';
  }
}

// ===== GEN ART =====
(function() {
  const c = document.getElementById('genArt'), ctx = c.getContext('2d');
  function resize() {
    const r = c.parentElement.getBoundingClientRect();
    c.width = r.width * 2; c.height = r.height * 2;
  }
  resize();
  const W=c.width, H=c.height, cols=70, rows=18, cw=W/cols, ch=H/rows;

  function loop(t) {
    ctx.fillStyle='#111'; ctx.fillRect(0,0,W,H);
    for (let x=0;x<cols;x++) for (let y=0;y<rows;y++) {
      const n=Math.sin(x*0.12+t*0.0008)*Math.cos(y*0.18+t*0.0006);
      const v=(n+1)/2;
      if (v>0.55) {
        ctx.fillStyle = v>0.82 ? `rgba(184,32,16,${(v-0.55)*1.8})` : `rgba(243,237,226,${(v-0.55)*0.35})`;
        const s=cw*v*0.85;
        ctx.fillRect(x*cw+(cw-s)/2, y*ch+(ch-s)/2, s, s);
      }
    }
    const sy=(t*0.08)%H;
    ctx.strokeStyle='rgba(184,32,16,0.12)'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(0,sy); ctx.lineTo(W,sy); ctx.stroke();
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  // 古いキャッシュを全て削除してから新しいSWを登録
  caches.keys().then(keys => Promise.all(keys.map(k => caches.delete(k))));
  navigator.serviceWorker.register('sw.js').then(reg => {
    // 新しいSWがあれば即座に更新
    reg.addEventListener('updatefound', () => {
      const newSW = reg.installing;
      newSW.addEventListener('statechange', () => {
        if (newSW.state === 'activated') location.reload();
      });
    });
  });
}
</script>
</body>
</html>
