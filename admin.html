<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç”Ÿæˆæ–°è â€” ç®¡ç†ç”»é¢</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
  body { font-family: 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif; }
  .nav-item { transition: background 0.15s; }
  .nav-item.active { background: rgba(255,255,255,0.1); }
  .nav-item:hover { background: rgba(255,255,255,0.07); }
  .status-badge { display: inline-flex; align-items: center; gap: 4px; }
  #preview-frame { width: 100%; height: calc(100vh - 120px); border: none; border-radius: 8px; }
  .copy-btn:active { transform: scale(0.95); }
  .sample-card { transition: box-shadow 0.15s; }
  .sample-card:hover { box-shadow: 0 0 0 2px rgba(255,255,255,0.15); }
</style>
</head>
<body class="bg-gray-950 text-gray-100 min-h-screen">

<!-- ===== ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ ===== -->
<div id="loginScreen" class="fixed inset-0 flex items-center justify-center bg-gray-950 z-50">
  <div class="bg-gray-900 rounded-xl p-8 w-full max-w-sm shadow-2xl border border-gray-800">
    <div class="text-center mb-6">
      <div class="text-2xl font-bold text-white tracking-widest">ç”Ÿæˆæ–°è</div>
      <div class="text-sm text-gray-400 mt-1">ç®¡ç†ç”»é¢</div>
    </div>
    <div id="loginError" class="hidden bg-red-900/50 text-red-300 text-sm rounded-lg px-4 py-2 mb-4"></div>
    <form id="loginForm">
      <input
        id="passwordInput"
        type="password"
        placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
        class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:border-gray-500 mb-4"
      />
      <button
        type="submit"
        class="w-full bg-white text-gray-900 font-bold rounded-lg py-3 hover:bg-gray-200 transition-colors"
      >ãƒ­ã‚°ã‚¤ãƒ³</button>
    </form>
  </div>
</div>

<!-- ===== ç®¡ç†ç”»é¢æœ¬ä½“ ===== -->
<div id="adminApp" class="hidden flex h-screen">

  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <aside class="w-52 bg-gray-900 border-r border-gray-800 flex flex-col flex-shrink-0">
    <div class="px-5 py-5 border-b border-gray-800">
      <div class="font-bold text-white text-sm tracking-widest">ç”Ÿæˆæ–°è</div>
      <div class="text-xs text-gray-500 mt-0.5">ç®¡ç†ç”»é¢</div>
    </div>
    <nav class="flex-1 py-3 space-y-0.5 px-2">
      <button onclick="showSection('dashboard')" id="nav-dashboard"
        class="nav-item active w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ“Š</span> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
      </button>
      <button onclick="showSection('preview')" id="nav-preview"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ—ï¸</span> ç´™é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      </button>
      <button onclick="showSection('pages')" id="nav-pages"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ”—</span> ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      </button>
      <button onclick="showSection('sample')" id="nav-sample"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ“¤</span> è¦‹æœ¬ç´™ç™ºè¡Œ
      </button>
      <div class="border-t border-gray-800 my-2"></div>
      <button onclick="showSection('subscribers')" id="nav-subscribers"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ‘¥</span> è³¼èª­è€…ç®¡ç†
      </button>
      <button onclick="showSection('invites')" id="nav-invites"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸŸï¸</span> æ‹›å¾…ã‚³ãƒ¼ãƒ‰
      </button>
      <button onclick="showSection('logs')" id="nav-logs"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ“‹</span> é…ä¿¡ãƒ­ã‚°
      </button>
      <div class="border-t border-gray-800 my-2"></div>
      <button onclick="showSection('content')" id="nav-content"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ“°</span> ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¢ºèª
      </button>
      <button onclick="showSection('announce')" id="nav-announce"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ“£</span> ãŠçŸ¥ã‚‰ã›é…ä¿¡
      </button>
      <div class="border-t border-gray-800 my-2"></div>
      <button onclick="showSection('diagnose')" id="nav-diagnose"
        class="nav-item w-full text-left px-3 py-2.5 rounded-lg text-sm text-gray-200 flex items-center gap-2.5">
        <span>ğŸ”§</span> è³¼èª­ãƒ•ãƒ­ãƒ¼è¨ºæ–­
      </button>
    </nav>
    <div class="px-4 py-4 border-t border-gray-800">
      <button onclick="logout()" class="text-xs text-gray-500 hover:text-gray-300 transition-colors">
        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
      </button>
    </div>
  </aside>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <main class="flex-1 overflow-y-auto bg-gray-950">

    <!-- ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ ===== -->
    <section id="section-dashboard" class="p-8">
      <h1 class="text-xl font-bold text-white mb-6">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚«ãƒ¼ãƒ‰ -->
      <div class="grid grid-cols-3 gap-4 mb-8">
        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
          <div class="text-xs text-gray-500 mb-1">è³¼èª­è€…æ•°</div>
          <div class="text-3xl font-bold text-white" id="stat-subscribers">â€”</div>
          <div class="text-xs text-gray-500 mt-1"><span id="stat-trial">â€”</span> ä½“é¨“ä¸­</div>
        </div>
        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
          <div class="text-xs text-gray-500 mb-1">ä»Šæ—¥ã®æœåˆŠ</div>
          <div class="text-2xl font-bold" id="stat-morning">â€”</div>
          <div class="text-xs text-gray-500 mt-1" id="stat-morning-time">â€”</div>
        </div>
        <div class="bg-gray-900 rounded-xl p-5 border border-gray-800">
          <div class="text-xs text-gray-500 mb-1">ä»Šæ—¥ã®å¤•åˆŠ</div>
          <div class="text-2xl font-bold" id="stat-evening">â€”</div>
          <div class="text-xs text-gray-500 mt-1" id="stat-evening-time">â€”</div>
        </div>
      </div>

      <!-- ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <h2 class="text-sm font-bold text-gray-300 mb-4">ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
        <div class="flex gap-3 flex-wrap">
          <button onclick="regenerateNow()" id="btn-regen"
            class="bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium px-4 py-2.5 rounded-lg transition-colors flex items-center gap-2">
            <span>ğŸ”„</span> ä»Šã™ãå†ç”Ÿæˆ
          </button>
          <button onclick="showSection('sample')"
            class="bg-gray-700 hover:bg-gray-600 text-white text-sm font-medium px-4 py-2.5 rounded-lg transition-colors flex items-center gap-2">
            <span>ğŸ“¤</span> è¦‹æœ¬ç´™ã‚’ç™ºè¡Œ
          </button>
        </div>
        <div id="regen-result" class="hidden mt-3 text-sm text-green-400"></div>
      </div>

      <!-- è³¼èª­è€…æ¨ç§»ã‚°ãƒ©ãƒ•ï¼ˆ7æ—¥é–“ï¼‰ -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <h2 class="text-sm font-bold text-gray-300 mb-4">è³¼èª­è€…æ¨ç§»ï¼ˆç›´è¿‘7æ—¥ï¼‰</h2>
        <div style="height: 200px;">
          <canvas id="chart-subscribers"></canvas>
        </div>
      </div>

      <!-- è¦‹æœ¬ç´™ç™ºè¡Œæ•° -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
        <h2 class="text-sm font-bold text-gray-300 mb-2">è¦‹æœ¬ç´™</h2>
        <div class="flex items-end gap-2">
          <div class="text-3xl font-bold text-white" id="stat-samples">â€”</div>
          <div class="text-sm text-gray-500 pb-1">ä»¶ç™ºè¡Œæ¸ˆã¿</div>
        </div>
      </div>
    </section>

    <!-- ===== ç´™é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===== -->
    <section id="section-preview" class="hidden p-6">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-bold text-white">ç´™é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
        <div class="flex gap-2">
          <button onclick="loadPreview('morning')" id="prev-btn-morning"
            class="text-sm px-4 py-2 rounded-lg bg-white text-gray-900 font-medium">æœåˆŠ</button>
          <button onclick="loadPreview('evening')" id="prev-btn-evening"
            class="text-sm px-4 py-2 rounded-lg bg-gray-700 text-white font-medium">å¤•åˆŠ</button>
        </div>
      </div>
      <iframe id="preview-frame" src="about:blank" class="bg-gray-900 rounded-lg"></iframe>
    </section>

    <!-- ===== ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ ===== -->
    <section id="section-pages" class="hidden p-6">
      <div class="mb-4">
        <div class="flex items-center justify-between mb-3">
          <h1 class="text-xl font-bold text-white">ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
          <div class="flex gap-1.5">
            <button onclick="setPageDevice('desktop')" id="device-desktop"
              class="text-xs px-3 py-1.5 rounded-lg bg-white text-gray-900 font-medium whitespace-nowrap">ğŸ–¥ PC</button>
            <button onclick="setPageDevice('mobile')" id="device-mobile"
              class="text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white whitespace-nowrap">ğŸ“± SP</button>
          </div>
        </div>
        <div class="flex gap-1.5">
          <button onclick="loadPagePreview('lp')" id="page-btn-lp"
            class="text-xs px-3 py-1.5 rounded-lg bg-white text-gray-900 font-medium whitespace-nowrap">LP</button>
          <button onclick="loadPagePreview('sample')" id="page-btn-sample"
            class="text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white whitespace-nowrap">è¦‹æœ¬ç´™</button>
          <button onclick="loadPagePreview('terms')" id="page-btn-terms"
            class="text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white whitespace-nowrap">åˆ©ç”¨è¦ç´„</button>
          <button onclick="loadPagePreview('privacy')" id="page-btn-privacy"
            class="text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white whitespace-nowrap">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼</button>
        </div>
      </div>
      <div id="page-frame-wrapper" class="flex justify-center">
        <div id="page-phone-frame" class="transition-all" style="width:100%;">
          <iframe id="page-frame" src="about:blank"
            class="bg-white rounded-lg transition-all"
            style="width:100%; height:calc(100vh - 180px); border:2px solid #4b5563;"></iframe>
        </div>
      </div>
    </section>

    <!-- ===== è¦‹æœ¬ç´™ç™ºè¡Œ ===== -->
    <section id="section-sample" class="hidden p-8">
      <h1 class="text-xl font-bold text-white mb-6">è¦‹æœ¬ç´™ç™ºè¡Œ</h1>

      <!-- ç™ºè¡Œãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <h2 class="text-sm font-bold text-gray-300 mb-4">è¦‹æœ¬ç´™ã‚’ç™ºè¡Œã™ã‚‹</h2>
        <p class="text-sm text-gray-400 mb-4">
          ä»Šæ—¥ã®ç´™é¢ãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«è¦‹æœ¬ç´™ã‚’ç™ºè¡Œã—ã¾ã™ã€‚ç™ºè¡Œã•ã‚ŒãŸè¦‹æœ¬ç´™ã¯èª°ã§ã‚‚é–²è¦§ã§ãã‚‹å…¬é–‹URLãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
        </p>
        <div class="flex gap-3 mb-4">
          <select id="sample-edition"
            class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg px-3 py-2.5 focus:outline-none focus:border-gray-500">
            <option value="morning">æœåˆŠ</option>
            <option value="evening">å¤•åˆŠ</option>
          </select>
          <button onclick="issueSample()" id="btn-issue"
            class="bg-white text-gray-900 font-bold text-sm px-6 py-2.5 rounded-lg hover:bg-gray-200 transition-colors">
            ç™ºè¡Œã™ã‚‹
          </button>
        </div>
        <div id="issue-result" class="hidden"></div>
      </div>

      <!-- ç™ºè¡Œæ¸ˆã¿ä¸€è¦§ -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-bold text-gray-300">ç™ºè¡Œæ¸ˆã¿ä¸€è¦§</h2>
          <button onclick="loadSampleList()" class="text-xs text-gray-500 hover:text-gray-300 transition-colors">
            æ›´æ–°
          </button>
        </div>
        <div id="sample-list">
          <div class="text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>
      </div>
    </section>

    <!-- ===== è³¼èª­è€…ç®¡ç† ===== -->
    <section id="section-subscribers" class="hidden p-8">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-xl font-bold text-white">è³¼èª­è€…ç®¡ç†</h1>
        <button onclick="exportSubscribers()"
          class="text-sm bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2">
          <span>â¬‡ï¸</span> CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </button>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ -->
      <div class="flex gap-2 mb-4 flex-wrap">
        <button onclick="filterSubscribers('all')" id="filter-all"
          class="text-xs px-3 py-1.5 rounded-lg bg-white text-gray-900 font-medium">å…¨å“¡</button>
        <button onclick="filterSubscribers('active')" id="filter-active"
          class="text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</button>
        <button onclick="filterSubscribers('invite')" id="filter-invite"
          class="text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white">ä½“é¨“ä¸­</button>
        <button onclick="filterSubscribers('canceled')" id="filter-canceled"
          class="text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white">è§£ç´„æ¸ˆã¿</button>
      </div>

      <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-x-auto">
        <div id="subscribers-list">
          <div class="p-6 text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>
      </div>
    </section>

    <!-- ===== æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç®¡ç† ===== -->
    <section id="section-invites" class="hidden p-8">
      <h1 class="text-xl font-bold text-white mb-6">æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

      <!-- ç™ºè¡Œãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <h2 class="text-sm font-bold text-gray-300 mb-4">æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œ</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
          <div>
            <label class="text-xs text-gray-500 block mb-1">ã‚³ãƒ¼ãƒ‰ï¼ˆç©ºæ¬„ã§è‡ªå‹•ç”Ÿæˆï¼‰</label>
            <input id="invite-code" type="text" placeholder="ä¾‹: WELCOME2026"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-600 focus:outline-none focus:border-gray-500">
          </div>
          <div>
            <label class="text-xs text-gray-500 block mb-1">åˆ©ç”¨ä¸Šé™ï¼ˆç©ºæ¬„ã§ç„¡åˆ¶é™ï¼‰</label>
            <input id="invite-max-uses" type="number" placeholder="ä¾‹: 10" min="1"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-600 focus:outline-none focus:border-gray-500">
          </div>
          <div>
            <label class="text-xs text-gray-500 block mb-1">æœ‰åŠ¹æœŸé™ï¼ˆç©ºæ¬„ã§ç„¡æœŸé™ï¼‰</label>
            <input id="invite-expires-at" type="date"
              class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-gray-500 [color-scheme:dark]">
          </div>
        </div>
        <button onclick="createInvite()" id="btn-create-invite"
          class="bg-white text-gray-900 font-bold text-sm px-5 py-2.5 rounded-lg hover:bg-gray-200 transition-colors">
          ç™ºè¡Œã™ã‚‹
        </button>
        <div id="invite-create-result" class="mt-3 hidden"></div>
      </div>

      <!-- ä¸€è¦§ -->
      <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-x-auto">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
          <h2 class="text-sm font-bold text-gray-300">ç™ºè¡Œæ¸ˆã¿ã‚³ãƒ¼ãƒ‰ä¸€è¦§</h2>
          <button onclick="loadInvites()" class="text-xs text-gray-500 hover:text-gray-300 transition-colors">æ›´æ–°</button>
        </div>
        <div id="invites-list">
          <div class="p-6 text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>
      </div>
    </section>

    <!-- ===== é…ä¿¡ãƒ­ã‚° ===== -->
    <section id="section-logs" class="hidden p-8">
      <div class="flex items-center justify-between mb-6">
        <h1 class="text-xl font-bold text-white">é…ä¿¡ãƒ­ã‚°ï¼ˆç›´è¿‘30æ—¥ï¼‰</h1>
        <button onclick="loadDeliveryLogs()" class="text-xs text-gray-500 hover:text-gray-300 transition-colors">æ›´æ–°</button>
      </div>
      <div class="bg-gray-900 rounded-xl border border-gray-800 overflow-x-auto">
        <div id="logs-list">
          <div class="p-6 text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>
      </div>
    </section>

    <!-- ===== ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¢ºèª ===== -->
    <section id="section-content" class="hidden p-8">
      <h1 class="text-xl font-bold text-white mb-6">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¢ºèª</h1>

      <!-- ãƒ•ã‚£ãƒ«ã‚¿ -->
      <div class="flex gap-3 mb-6 flex-wrap items-end">
        <div>
          <label class="text-xs text-gray-500 block mb-1">æ—¥ä»˜</label>
          <input id="content-date" type="date"
            class="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm focus:outline-none focus:border-gray-500 [color-scheme:dark]">
        </div>
        <div>
          <label class="text-xs text-gray-500 block mb-1">ç‰ˆ</label>
          <select id="content-edition"
            class="bg-gray-800 border border-gray-700 text-white text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-gray-500">
            <option value="morning">æœåˆŠ</option>
            <option value="evening">å¤•åˆŠ</option>
          </select>
        </div>
        <button onclick="loadContent()"
          class="bg-gray-700 hover:bg-gray-600 text-white text-sm px-4 py-2 rounded-lg transition-colors">
          è¡¨ç¤º
        </button>
      </div>

      <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤º -->
      <div id="content-body">
        <div class="text-sm text-gray-500">æ—¥ä»˜ã¨ç‰ˆã‚’é¸ã‚“ã§ã€Œè¡¨ç¤ºã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
      </div>
    </section>

    <!-- ===== ãŠçŸ¥ã‚‰ã›é…ä¿¡ ===== -->
    <section id="section-announce" class="hidden p-8">
      <h1 class="text-xl font-bold text-white mb-6">ãŠçŸ¥ã‚‰ã›é…ä¿¡</h1>

      <!-- é€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <h2 class="text-sm font-bold text-gray-300 mb-4">æ–°ã—ã„ãŠçŸ¥ã‚‰ã›ã‚’é€ã‚‹</h2>
        <div class="mb-4">
          <label class="text-xs text-gray-500 block mb-1">ä»¶å</label>
          <input id="announce-subject" type="text" placeholder="ä¾‹: ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã®ãŠçŸ¥ã‚‰ã›"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-600 focus:outline-none focus:border-gray-500">
        </div>
        <div class="mb-4">
          <label class="text-xs text-gray-500 block mb-1">æœ¬æ–‡</label>
          <textarea id="announce-body" rows="5" placeholder="ãŠçŸ¥ã‚‰ã›ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"
            class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-sm placeholder-gray-600 focus:outline-none focus:border-gray-500 resize-y"></textarea>
        </div>
        <div class="flex gap-4 items-center mb-4">
          <label class="text-xs text-gray-500">é…ä¿¡å¯¾è±¡:</label>
          <label class="flex items-center gap-1.5 text-sm text-gray-300">
            <input type="radio" name="announce-target" value="all" checked class="accent-white"> å…¨å“¡
          </label>
          <label class="flex items-center gap-1.5 text-sm text-gray-300">
            <input type="radio" name="announce-target" value="active" class="accent-white"> ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿
          </label>
          <label class="flex items-center gap-1.5 text-sm text-gray-300">
            <input type="radio" name="announce-target" value="invite" class="accent-white"> ä½“é¨“ä¸­ã®ã¿
          </label>
        </div>
        <div class="flex gap-3 items-center">
          <button onclick="sendAnnouncement()" id="btn-announce"
            class="bg-white text-gray-900 font-bold text-sm px-6 py-2.5 rounded-lg hover:bg-gray-200 transition-colors">
            é€ä¿¡ã™ã‚‹
          </button>
          <button onclick="previewAnnouncement()"
            class="bg-gray-700 hover:bg-gray-600 text-white text-sm px-4 py-2.5 rounded-lg transition-colors">
            ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          </button>
        </div>
        <div id="announce-result" class="mt-3 hidden"></div>
        <div id="announce-preview" class="mt-3 hidden"></div>
      </div>

      <!-- é€ä¿¡å±¥æ­´ -->
      <div class="bg-gray-900 rounded-xl border border-gray-800">
        <div class="flex items-center justify-between px-6 py-4 border-b border-gray-800">
          <h2 class="text-sm font-bold text-gray-300">é€ä¿¡å±¥æ­´</h2>
          <button onclick="loadAnnounceHistory()" class="text-xs text-gray-500 hover:text-gray-300 transition-colors">æ›´æ–°</button>
        </div>
        <div id="announce-history">
          <div class="p-6 text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
        </div>
      </div>
    </section>

    <!-- ===== è³¼èª­ãƒ•ãƒ­ãƒ¼è¨ºæ–­ ===== -->
    <section id="section-diagnose" class="hidden p-8">
      <h1 class="text-xl font-bold text-white mb-6">è³¼èª­ãƒ•ãƒ­ãƒ¼è¨ºæ–­</h1>

      <!-- ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆ -->
      <div class="mb-6">
        <button onclick="runFullDiagnose()" id="btn-full-diagnose"
          class="bg-white text-gray-900 font-bold text-sm px-6 py-2.5 rounded-lg hover:bg-gray-200 transition-colors">
          ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        </button>
        <div id="diagnose-summary" class="mt-3 text-sm text-gray-400"></div>
      </div>

      <!-- 3-1. APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-bold text-gray-300">APIãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯</h2>
          <button onclick="runHealthCheck()" id="btn-health"
            class="bg-gray-700 hover:bg-gray-600 text-white text-xs px-4 py-2 rounded-lg transition-colors">
            ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
          </button>
        </div>
        <div id="health-results" class="space-y-2 text-sm"></div>
      </div>

      <!-- 3-2. Checkout APIãƒ†ã‚¹ãƒˆ -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-bold text-gray-300">Checkout APIãƒ†ã‚¹ãƒˆ</h2>
          <button onclick="runCheckoutTest()" id="btn-checkout"
            class="bg-gray-700 hover:bg-gray-600 text-white text-xs px-4 py-2 rounded-lg transition-colors">
            Checkout Sessionä½œæˆãƒ†ã‚¹ãƒˆ
          </button>
        </div>
        <div id="checkout-results" class="text-sm"></div>
      </div>

      <!-- 3-3. ãƒšãƒ¼ã‚¸å†…ãƒœã‚¿ãƒ³å‹•ä½œãƒã‚§ãƒƒã‚¯ -->
      <div class="bg-gray-900 rounded-xl p-6 border border-gray-800 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-sm font-bold text-gray-300">ãƒšãƒ¼ã‚¸å†…ãƒœã‚¿ãƒ³ç¢ºèª</h2>
          <button onclick="runPageCheck()" id="btn-pagecheck"
            class="bg-gray-700 hover:bg-gray-600 text-white text-xs px-4 py-2 rounded-lg transition-colors">
            ãƒšãƒ¼ã‚¸å†…ãƒœã‚¿ãƒ³ç¢ºèª
          </button>
        </div>
        <div id="pagecheck-results" class="text-sm"></div>
      </div>
    </section>

  </main>
</div>

<script>
const API = 'https://news-generator.hiroshinagano0113.workers.dev';
let token = null;

// ===== èªè¨¼ =====

function getToken() {
  return localStorage.getItem('admin_token');
}

function setToken(t) {
  token = t;
  localStorage.setItem('admin_token', t);
}

function clearToken() {
  token = null;
  localStorage.removeItem('admin_token');
}

async function apiCall(path, options = {}) {
  const t = token || getToken();
  const res = await fetch(`${API}${path}`, {
    ...options,
    headers: {
      'Content-Type': 'application/json',
      ...(t ? { Authorization: `Bearer ${t}` } : {}),
      ...options.headers,
    },
  });
  return res;
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚: ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã¨ã—ã¦æ‰±ã†
window.addEventListener('DOMContentLoaded', () => {
  const saved = getToken();
  if (saved) {
    token = saved;
    showAdminApp();
  }
});

// ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ 
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const password = document.getElementById('passwordInput').value;
  const errEl = document.getElementById('loginError');
  errEl.classList.add('hidden');

  try {
    const res = await fetch(`${API}/api/admin/auth`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password }),
    });
    const data = await res.json();
    if (!res.ok) {
      errEl.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™';
      errEl.classList.remove('hidden');
      return;
    }
    setToken(data.token);
    showAdminApp();
  } catch (err) {
    errEl.textContent = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
    errEl.classList.remove('hidden');
  }
});

function showAdminApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('adminApp').classList.remove('hidden');
  document.getElementById('adminApp').classList.add('flex');
  loadStats();
  loadSubscriberChart();
}

function logout() {
  clearToken();
  location.reload();
}

// ===== ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ‡ã‚Šæ›¿ãˆ =====

function showSection(name) {
  ['dashboard', 'preview', 'pages', 'sample', 'subscribers', 'invites', 'logs', 'content', 'announce', 'diagnose'].forEach(s => {
    document.getElementById(`section-${s}`).classList.add('hidden');
    document.getElementById(`nav-${s}`).classList.remove('active');
  });
  document.getElementById(`section-${name}`).classList.remove('hidden');
  document.getElementById(`nav-${name}`).classList.add('active');

  if (name === 'preview') loadPreview('morning');
  if (name === 'pages') loadPagePreview('lp');
  if (name === 'sample') loadSampleList();
  if (name === 'subscribers') loadSubscribers();
  if (name === 'invites') loadInvites();
  if (name === 'logs') loadDeliveryLogs();
  if (name === 'content') loadContent();
  if (name === 'announce') loadAnnounceHistory();
}

// ===== ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ =====

async function loadStats() {
  try {
    const res = await apiCall('/api/admin/stats');
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();

    document.getElementById('stat-subscribers').textContent = data.subscribers?.total ?? 0;
    document.getElementById('stat-trial').textContent = data.subscribers?.trial ?? 0;
    document.getElementById('stat-samples').textContent = data.samples ?? 0;

    setDeliveryStatus('morning', data.delivery?.morning);
    setDeliveryStatus('evening', data.delivery?.evening);
  } catch (err) {
    console.error('Stats load failed:', err);
  }
}

function setDeliveryStatus(edition, info) {
  const el = document.getElementById(`stat-${edition}`);
  const timeEl = document.getElementById(`stat-${edition}-time`);
  if (!info || info.status === 'pending') {
    el.textContent = 'â³';
    el.className = 'text-2xl font-bold text-yellow-400';
    timeEl.textContent = 'æœªé…ä¿¡';
  } else {
    el.textContent = 'âœ…';
    el.className = 'text-2xl font-bold text-green-400';
    if (info.generatedAt) {
      const d = new Date(info.generatedAt);
      timeEl.textContent = `${d.getHours()}:${String(d.getMinutes()).padStart(2, '0')} é…ä¿¡æ¸ˆã¿`;
    } else {
      timeEl.textContent = 'é…ä¿¡æ¸ˆã¿';
    }
  }
}

async function regenerateNow() {
  const btn = document.getElementById('btn-regen');
  const result = document.getElementById('regen-result');
  btn.disabled = true;
  btn.textContent = 'â³ ç”Ÿæˆä¸­â€¦ï¼ˆç´„30ç§’ï¼‰';
  result.classList.add('hidden');

  try {
    const res = await fetch(`${API}/api/generate?force=true`);
    if (res.ok) {
      result.textContent = 'âœ… å†ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚';
      result.className = 'mt-3 text-sm text-green-400';
      result.classList.remove('hidden');
      loadStats();
    } else {
      throw new Error(`HTTP ${res.status}`);
    }
  } catch (err) {
    result.textContent = `âŒ å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`;
    result.className = 'mt-3 text-sm text-red-400';
    result.classList.remove('hidden');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<span>ğŸ”„</span> ä»Šã™ãå†ç”Ÿæˆ';
  }
}

// ===== ç´™é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====

function loadPreview(edition) {
  const frame = document.getElementById('preview-frame');
  frame.src = `index.html?edition=${edition}`;
  document.getElementById('prev-btn-morning').className =
    edition === 'morning'
      ? 'text-sm px-4 py-2 rounded-lg bg-white text-gray-900 font-medium'
      : 'text-sm px-4 py-2 rounded-lg bg-gray-700 text-white font-medium';
  document.getElementById('prev-btn-evening').className =
    edition === 'evening'
      ? 'text-sm px-4 py-2 rounded-lg bg-white text-gray-900 font-medium'
      : 'text-sm px-4 py-2 rounded-lg bg-gray-700 text-white font-medium';
}

// ===== ãƒšãƒ¼ã‚¸ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ =====

const PAGE_MAP = {
  lp:      { file: 'lp.html', label: 'LP' },
  sample:  { file: 'sample.html', label: 'è¦‹æœ¬ç´™ãƒšãƒ¼ã‚¸' },
  terms:   { file: 'terms.html', label: 'åˆ©ç”¨è¦ç´„' },
  privacy: { file: 'privacy.html', label: 'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼' },
};
let currentPageDevice = 'desktop';

function loadPagePreview(page) {
  const info = PAGE_MAP[page];
  if (!info) return;
  const frame = document.getElementById('page-frame');
  frame.src = info.file;

  // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡æ›¿
  Object.keys(PAGE_MAP).forEach(key => {
    const btn = document.getElementById(`page-btn-${key}`);
    if (btn) {
      btn.className = key === page
        ? 'text-xs px-3 py-1.5 rounded-lg bg-white text-gray-900 font-medium whitespace-nowrap'
        : 'text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white whitespace-nowrap';
    }
  });
}

function setPageDevice(device) {
  currentPageDevice = device;
  const frame = document.getElementById('page-frame');
  const wrapper = document.getElementById('page-frame-wrapper');

  document.getElementById('device-desktop').className =
    device === 'desktop'
      ? 'text-xs px-3 py-1.5 rounded-lg bg-white text-gray-900 font-medium whitespace-nowrap'
      : 'text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white whitespace-nowrap';
  document.getElementById('device-mobile').className =
    device === 'mobile'
      ? 'text-xs px-3 py-1.5 rounded-lg bg-white text-gray-900 font-medium whitespace-nowrap'
      : 'text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white whitespace-nowrap';

  const phoneFrame = document.getElementById('page-phone-frame');
  if (device === 'mobile') {
    phoneFrame.style.width = '407px';
    phoneFrame.style.padding = '16px';
    phoneFrame.style.background = '#1f2937';
    phoneFrame.style.borderRadius = '32px';
    phoneFrame.style.border = '3px solid #4b5563';
    phoneFrame.style.boxShadow = '0 10px 40px rgba(0,0,0,0.5)';
    frame.style.width = '375px';
    frame.style.height = '700px';
    frame.style.borderRadius = '16px';
    frame.style.border = '2px solid #6b7280';
  } else {
    phoneFrame.style.width = '100%';
    phoneFrame.style.padding = '0';
    phoneFrame.style.background = 'none';
    phoneFrame.style.borderRadius = '0';
    phoneFrame.style.border = 'none';
    phoneFrame.style.boxShadow = 'none';
    frame.style.width = '100%';
    frame.style.height = 'calc(100vh - 180px)';
    frame.style.borderRadius = '8px';
    frame.style.border = '2px solid #4b5563';
  }
}

// ===== è¦‹æœ¬ç´™ç™ºè¡Œ =====

async function issueSample() {
  const edition = document.getElementById('sample-edition').value;
  const btn = document.getElementById('btn-issue');
  const result = document.getElementById('issue-result');

  btn.disabled = true;
  btn.textContent = 'ç™ºè¡Œä¸­â€¦';
  result.classList.add('hidden');

  try {
    const res = await apiCall('/api/admin/sample/issue', {
      method: 'POST',
      body: JSON.stringify({ edition }),
    });
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();

    if (!res.ok) {
      result.innerHTML = `<div class="text-sm text-red-400">âŒ ${data.error}</div>`;
      result.classList.remove('hidden');
      return;
    }

    const editionLabel = edition === 'morning' ? 'æœåˆŠ' : 'å¤•åˆŠ';
    result.innerHTML = `
      <div class="bg-gray-800 rounded-lg p-4">
        <div class="flex items-center gap-2 mb-3">
          <span class="text-green-400 font-bold text-sm">âœ… è¦‹æœ¬ç´™ã‚’ç™ºè¡Œã—ã¾ã—ãŸ</span>
          <span class="text-xs text-gray-500">${editionLabel} / ID: ${data.id}</span>
        </div>
        <div class="flex items-center gap-2 bg-gray-900 rounded-lg px-3 py-2.5">
          <input
            id="issued-url"
            value="${data.url}"
            readonly
            class="flex-1 bg-transparent text-sm text-gray-300 focus:outline-none min-w-0"
          />
          <button onclick="copyUrl('issued-url')" class="copy-btn text-xs text-gray-400 hover:text-white transition-colors shrink-0 px-2 py-1 bg-gray-700 rounded">
            ã‚³ãƒ”ãƒ¼
          </button>
        </div>
        <div class="flex gap-2 mt-3">
          <a href="${data.url}" target="_blank"
            class="text-xs text-gray-400 hover:text-white transition-colors flex items-center gap-1">
            <span>ğŸ”—</span> é–‹ã
          </a>
          <button onclick="shareToX('${data.url}', '${editionLabel}')"
            class="text-xs text-gray-400 hover:text-white transition-colors flex items-center gap-1">
            <span>ğ•</span> Xã«æŠ•ç¨¿
          </button>
        </div>
      </div>
    `;
    result.classList.remove('hidden');
    loadSampleList();
    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ã‚µãƒ³ãƒ—ãƒ«æ•°ã‚‚æ›´æ–°
    loadStats();
  } catch (err) {
    result.innerHTML = `<div class="text-sm text-red-400">âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
    result.classList.remove('hidden');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ç™ºè¡Œã™ã‚‹';
  }
}

async function loadSampleList() {
  const el = document.getElementById('sample-list');
  try {
    const res = await apiCall('/api/admin/sample/list');
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();

    if (!data.samples || data.samples.length === 0) {
      el.innerHTML = '<div class="text-sm text-gray-500">ã¾ã è¦‹æœ¬ç´™ãŒç™ºè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
      return;
    }

    el.innerHTML = data.samples.map(s => {
      const editionLabel = s.edition === 'morning' ? 'æœåˆŠ' : 'å¤•åˆŠ';
      const url = `https://paul13131313.github.io/generated-news/?sample=${s.id}`;
      const dt = new Date(s.issuedAt);
      const dateStr = `${dt.getMonth() + 1}/${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2, '0')}`;
      return `
        <div class="sample-card flex items-center gap-3 py-3 border-b border-gray-800 last:border-0">
          <div class="shrink-0 text-xs text-gray-500 w-20">${dateStr}</div>
          <div class="shrink-0">
            <span class="text-xs bg-gray-700 text-gray-300 px-2 py-0.5 rounded">${editionLabel}</span>
          </div>
          <div class="flex-1 text-sm text-gray-400 truncate font-mono">${s.id}</div>
          <div class="flex items-center gap-2 shrink-0">
            <button onclick="copyText('${url}')" class="copy-btn text-xs text-gray-500 hover:text-white transition-colors px-2 py-1 bg-gray-800 rounded">
              URL
            </button>
            <a href="${url}" target="_blank" class="text-xs text-gray-500 hover:text-white transition-colors">
              é–‹ã
            </a>
          </div>
        </div>
      `;
    }).join('');
  } catch (err) {
    el.innerHTML = `<div class="text-sm text-red-400">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
  }
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====

function copyUrl(inputId) {
  const input = document.getElementById(inputId);
  copyText(input.value);
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    // ç°¡æ˜“ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
    const el = document.activeElement;
    if (el && el.textContent === 'ã‚³ãƒ”ãƒ¼') { el.textContent = 'âœ“'; setTimeout(() => { el.textContent = 'ã‚³ãƒ”ãƒ¼'; }, 1500); }
    if (el && el.textContent === 'URL') { el.textContent = 'âœ“'; setTimeout(() => { el.textContent = 'URL'; }, 1500); }
  } catch {
    prompt('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„:', text);
  }
}

function shareToX(url, editionLabel) {
  const text = `ç”Ÿæˆæ–°è ${editionLabel}ã®è¦‹æœ¬ç´™ã‚’å…¬é–‹ä¸­ã§ã™ã€‚AIãŒæ¯æœãƒ»æ¯å¤•ç”Ÿæˆã™ã‚‹æ–°èã‚’ãœã²ã”è¦§ãã ã•ã„ã€‚`;
  const tweetUrl = `https://x.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
  window.open(tweetUrl, '_blank');
}

// ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆPhase 2 å…±é€šï¼‰ =====

function escapeHtml(text) {
  return String(text)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

function formatDate(isoString) {
  const d = new Date(isoString);
  return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()}`;
}

function statusBadge(status) {
  const map = {
    active:         ['text-green-300 bg-green-900/40', 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–'],
    invite:         ['text-blue-300 bg-blue-900/40', 'ä½“é¨“ä¸­'],
    invite_expired: ['text-yellow-300 bg-yellow-900/40', 'æœŸé™åˆ‡ã‚Œ'],
    canceled:       ['text-gray-400 bg-gray-800', 'è§£ç´„æ¸ˆã¿'],
    past_due:       ['text-red-300 bg-red-900/40', 'æ”¯æ‰•é…å»¶'],
  };
  const [cls, label] = map[status] || ['text-gray-400 bg-gray-800', status];
  return `<span class="text-xs px-2 py-0.5 rounded-full ${cls}">${label}</span>`;
}

// ===== è³¼èª­è€…ç®¡ç† =====

let allSubscribers = [];
let currentFilter = 'all';

async function loadSubscribers() {
  const el = document.getElementById('subscribers-list');
  el.innerHTML = '<div class="p-6 text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  try {
    const res = await apiCall('/api/admin/subscribers');
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();
    allSubscribers = data.subscribers || [];
    renderSubscribers();
  } catch (err) {
    el.innerHTML = `<div class="p-6 text-sm text-red-400">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
  }
}

function filterSubscribers(filter) {
  currentFilter = filter;
  ['all', 'active', 'invite', 'canceled'].forEach(f => {
    const btn = document.getElementById(`filter-${f}`);
    btn.className = f === filter
      ? 'text-xs px-3 py-1.5 rounded-lg bg-white text-gray-900 font-medium'
      : 'text-xs px-3 py-1.5 rounded-lg bg-gray-700 text-white';
  });
  renderSubscribers();
}

function renderSubscribers() {
  const el = document.getElementById('subscribers-list');
  const filtered = currentFilter === 'all'
    ? allSubscribers
    : allSubscribers.filter(s =>
        currentFilter === 'canceled'
          ? (s.status === 'canceled' || s.status === 'past_due')
          : s.status === currentFilter
      );

  if (filtered.length === 0) {
    el.innerHTML = '<div class="p-6 text-sm text-gray-500">è©²å½“ã™ã‚‹è³¼èª­è€…ã¯ã„ã¾ã›ã‚“</div>';
    return;
  }

  el.innerHTML = `
    <table class="w-full text-sm">
      <thead>
        <tr class="border-b border-gray-800">
          <th class="text-left px-6 py-3 text-xs text-gray-500 font-medium">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</th>
          <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
          <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">ç™»éŒ²æ—¥</th>
          <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">æ‹›å¾…ã‚³ãƒ¼ãƒ‰</th>
        </tr>
      </thead>
      <tbody>
        ${filtered.map(s => `
          <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition-colors">
            <td class="px-6 py-3 text-gray-300 font-mono text-xs">${escapeHtml(s.email)}</td>
            <td class="px-4 py-3">${statusBadge(s.status)}</td>
            <td class="px-4 py-3 text-gray-500 text-xs">${s.subscribedAt ? formatDate(s.subscribedAt) : 'â€”'}</td>
            <td class="px-4 py-3 text-gray-500 text-xs font-mono">${s.inviteCode ? escapeHtml(s.inviteCode) : 'â€”'}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div class="px-6 py-3 border-t border-gray-800 text-xs text-gray-500">${filtered.length} ä»¶</div>
  `;
}

async function exportSubscribers() {
  try {
    const res = await apiCall('/api/admin/subscribers/export');
    if (!res.ok) { alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ'); return; }
    const csv = await res.text();
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `subscribers-${new Date().toISOString().slice(0, 10)}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (err) {
    alert(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
  }
}

// ===== æ‹›å¾…ã‚³ãƒ¼ãƒ‰ç®¡ç† =====

async function loadInvites() {
  const el = document.getElementById('invites-list');
  el.innerHTML = '<div class="p-6 text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  try {
    const res = await apiCall('/api/admin/invites');
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();
    const invites = data.invites || [];

    if (invites.length === 0) {
      el.innerHTML = '<div class="p-6 text-sm text-gray-500">æ‹›å¾…ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }

    el.innerHTML = `
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-800">
            <th class="text-left px-6 py-3 text-xs text-gray-500 font-medium">ã‚³ãƒ¼ãƒ‰</th>
            <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">åˆ©ç”¨æ•° / ä¸Šé™</th>
            <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">æœ‰åŠ¹æœŸé™</th>
            <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">çŠ¶æ…‹</th>
            <th class="px-4 py-3"></th>
          </tr>
        </thead>
        <tbody>
          ${invites.map(inv => `
            <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition-colors">
              <td class="px-6 py-3">
                <span class="font-mono text-white text-sm">${escapeHtml(inv.code)}</span>
                <button onclick="copyText('${escapeHtml(inv.code)}')"
                  class="ml-2 text-xs text-gray-500 hover:text-white transition-colors px-1.5 py-0.5 bg-gray-800 rounded">ã‚³ãƒ”ãƒ¼</button>
              </td>
              <td class="px-4 py-3 text-gray-400 text-xs">
                ${inv.usedCount != null ? inv.usedCount : 'â€”'} / ${inv.maxUses != null ? inv.maxUses : 'âˆ'}
              </td>
              <td class="px-4 py-3 text-gray-400 text-xs">${inv.expiresAt ? formatDate(inv.expiresAt) : 'ç„¡æœŸé™'}</td>
              <td class="px-4 py-3">
                ${inv.active !== false
                  ? '<span class="text-xs px-2 py-0.5 rounded-full text-green-300 bg-green-900/40">æœ‰åŠ¹</span>'
                  : '<span class="text-xs px-2 py-0.5 rounded-full text-gray-400 bg-gray-800">ç„¡åŠ¹</span>'}
              </td>
              <td class="px-4 py-3 text-right">
                ${inv.active !== false
                  ? `<button onclick="deactivateInvite('${escapeHtml(inv.code)}')"
                      class="text-xs text-red-400 hover:text-red-300 transition-colors">ç„¡åŠ¹åŒ–</button>`
                  : ''}
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } catch (err) {
    el.innerHTML = `<div class="p-6 text-sm text-red-400">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
  }
}

async function createInvite() {
  const code = document.getElementById('invite-code').value.trim();
  const maxUses = document.getElementById('invite-max-uses').value;
  const expiresAt = document.getElementById('invite-expires-at').value;
  const btn = document.getElementById('btn-create-invite');
  const result = document.getElementById('invite-create-result');

  btn.disabled = true;
  btn.textContent = 'ç™ºè¡Œä¸­â€¦';
  result.classList.add('hidden');

  try {
    const body = {};
    if (code) body.code = code;
    if (maxUses) body.maxUses = parseInt(maxUses);
    if (expiresAt) body.expiresAt = expiresAt;

    const res = await apiCall('/api/admin/invites', {
      method: 'POST',
      body: JSON.stringify(body),
    });
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();

    if (!res.ok) {
      result.innerHTML = `<div class="text-sm text-red-400">âŒ ${escapeHtml(data.error)}</div>`;
      result.classList.remove('hidden');
      return;
    }

    result.innerHTML = `
      <div class="text-sm text-green-400 flex items-center gap-2 flex-wrap">
        âœ… ã‚³ãƒ¼ãƒ‰ <span class="font-mono font-bold">${escapeHtml(data.code)}</span> ã‚’ç™ºè¡Œã—ã¾ã—ãŸ
        <button onclick="copyText('${escapeHtml(data.code)}')"
          class="text-xs text-gray-400 hover:text-white px-1.5 py-0.5 bg-gray-700 rounded">ã‚³ãƒ”ãƒ¼</button>
      </div>
    `;
    result.classList.remove('hidden');
    document.getElementById('invite-code').value = '';
    document.getElementById('invite-max-uses').value = '';
    document.getElementById('invite-expires-at').value = '';
    loadInvites();
  } catch (err) {
    result.innerHTML = `<div class="text-sm text-red-400">âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
    result.classList.remove('hidden');
  } finally {
    btn.disabled = false;
    btn.textContent = 'ç™ºè¡Œã™ã‚‹';
  }
}

async function deactivateInvite(code) {
  if (!confirm(`ã‚³ãƒ¼ãƒ‰ "${code}" ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ`)) return;
  try {
    const res = await apiCall(`/api/admin/invites/${encodeURIComponent(code)}`, { method: 'PATCH' });
    if (res.status === 401) { clearToken(); location.reload(); return; }
    if (!res.ok) {
      const data = await res.json();
      alert(`ã‚¨ãƒ©ãƒ¼: ${data.error}`);
      return;
    }
    loadInvites();
  } catch (err) {
    alert(`ã‚¨ãƒ©ãƒ¼: ${err.message}`);
  }
}

// ===== é…ä¿¡ãƒ­ã‚° =====

async function loadDeliveryLogs() {
  const el = document.getElementById('logs-list');
  el.innerHTML = '<div class="p-6 text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';
  try {
    const res = await apiCall('/api/admin/delivery-logs?days=30');
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();
    const logs = data.logs || [];

    if (logs.length === 0) {
      el.innerHTML = '<div class="p-6 text-sm text-gray-500">é…ä¿¡ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ¬¡å›ã®Cronå®Ÿè¡Œã‹ã‚‰è¨˜éŒ²ã•ã‚Œã¾ã™ã€‚</div>';
      return;
    }

    el.innerHTML = `
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b border-gray-800">
            <th class="text-left px-6 py-3 text-xs text-gray-500 font-medium">æ—¥ä»˜</th>
            <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">æœåˆŠ</th>
            <th class="text-left px-4 py-3 text-xs text-gray-500 font-medium">å¤•åˆŠ</th>
          </tr>
        </thead>
        <tbody>
          ${logs.map(log => `
            <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition-colors">
              <td class="px-6 py-3 text-gray-300 text-xs font-mono">${log.date}</td>
              <td class="px-4 py-3">${renderLogEntry(log.morning)}</td>
              <td class="px-4 py-3">${renderLogEntry(log.evening)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  } catch (err) {
    el.innerHTML = `<div class="p-6 text-sm text-red-400">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
  }
}

function renderLogEntry(entry) {
  if (!entry) return '<span class="text-xs text-gray-600">â€”</span>';
  const icon = entry.status === 'success' ? 'âœ…' : 'âŒ';
  const email = entry.emailSent != null ? ` ãƒ¡ãƒ¼ãƒ« ${entry.emailSent}ä»¶` : '';
  const sec = entry.elapsedMs ? ` ${(entry.elapsedMs / 1000).toFixed(1)}ç§’` : '';
  return `<span class="text-xs text-gray-400">${icon}${email}${sec}</span>`;
}

// ===== Phase 3: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚°ãƒ©ãƒ• =====

let subscriberChart = null;

async function loadSubscriberChart() {
  try {
    const res = await apiCall('/api/admin/stats/daily?days=7');
    if (!res.ok) return;
    const data = await res.json();
    const days = data.days || [];

    const labels = days.map(d => {
      const parts = d.date.split('-');
      return `${parseInt(parts[1])}/${parseInt(parts[2])}`;
    });
    const totals = days.map(d => d.total || 0);
    const newSubs = days.map(d => d.new || 0);
    const churned = days.map(d => d.churned || 0);

    const ctx = document.getElementById('chart-subscribers').getContext('2d');

    if (subscriberChart) subscriberChart.destroy();

    subscriberChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [
          {
            label: 'è³¼èª­è€…æ•°',
            data: totals,
            borderColor: '#fff',
            backgroundColor: 'rgba(255,255,255,0.05)',
            fill: true,
            tension: 0.3,
            pointRadius: 3,
          },
          {
            label: 'æ–°è¦',
            data: newSubs,
            borderColor: '#4ade80',
            backgroundColor: 'transparent',
            tension: 0.3,
            pointRadius: 3,
            borderDash: [4, 4],
          },
          {
            label: 'è§£ç´„',
            data: churned,
            borderColor: '#f87171',
            backgroundColor: 'transparent',
            tension: 0.3,
            pointRadius: 3,
            borderDash: [4, 4],
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: { color: '#9ca3af', font: { size: 11 } },
          },
        },
        scales: {
          x: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.04)' } },
          y: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(255,255,255,0.04)' }, beginAtZero: true },
        },
      },
    });
  } catch (err) {
    console.error('Chart load failed:', err);
  }
}

// ===== Phase 3: ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç¢ºèª =====

const CORNER_LABELS = {
  headline:      { emoji: 'ğŸ“°', name: 'ä¸€é¢' },
  articles:      { emoji: 'ğŸ“', name: 'è¨˜äº‹' },
  culture:       { emoji: 'ğŸ­', name: 'å‚¬äº‹' },
  weatherFashion:{ emoji: 'ğŸŒ¤ï¸', name: 'å¤©æ°—ã¨æœè£…' },
  localNews:     { emoji: 'ğŸ˜ï¸', name: 'ã”è¿‘æ‰€æƒ…å ±' },
  genArt:        { emoji: 'ğŸ¨', name: 'GEN ART' },
  aiEditorial:   { emoji: 'âœï¸', name: 'å¤©å£°ç”Ÿæˆ' },
  snsTrend:      { emoji: 'ğŸ“±', name: 'SNSãƒˆãƒ¬ãƒ³ãƒ‰' },
  numbers:       { emoji: 'ğŸ”¢', name: 'æ•°å­—ã§èª­ã‚€' },
  heartwarming:  { emoji: 'â˜€ï¸', name: 'ã²ã ã¾ã‚Š' },
};

async function loadContent() {
  const dateInput = document.getElementById('content-date');
  const edition = document.getElementById('content-edition').value;
  const el = document.getElementById('content-body');

  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
  if (!dateInput.value) {
    const now = new Date(Date.now() + 9 * 60 * 60 * 1000);
    dateInput.value = now.toISOString().slice(0, 10);
  }

  const date = dateInput.value;
  el.innerHTML = '<div class="text-sm text-gray-500">èª­ã¿è¾¼ã¿ä¸­â€¦</div>';

  try {
    const res = await fetch(`${API}/api/generate?edition=${edition}&date=${date}`);
    if (!res.ok) {
      el.innerHTML = `<div class="text-sm text-gray-500">ã“ã®æ—¥ã®${edition === 'morning' ? 'æœåˆŠ' : 'å¤•åˆŠ'}ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>`;
      return;
    }
    const data = await res.json();
    const np = data.newspaper || data;

    renderContentView(np, el);
  } catch (err) {
    el.innerHTML = `<div class="text-sm text-red-400">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
  }
}

function renderContentView(np, el) {
  let html = '';

  // ä¸€é¢
  if (np.headline) {
    html += renderCornerCard('headline', np.headline);
  }

  // è¨˜äº‹ä¸€è¦§
  if (np.articles && np.articles.length > 0) {
    html += `<div class="bg-gray-900 rounded-xl border border-gray-800 mb-4">
      <div class="px-5 py-3 border-b border-gray-800">
        <span class="text-sm font-bold text-gray-300">ğŸ“ è¨˜äº‹ï¼ˆ${np.articles.length}æœ¬ï¼‰</span>
      </div>`;
    np.articles.forEach((a, i) => {
      html += `<div class="px-5 py-3 border-b border-gray-800/50">
        <div class="text-xs text-gray-500 mb-1">è¨˜äº‹ ${i + 1}${a.category ? ` / ${escapeHtml(a.category)}` : ''}</div>
        <div class="text-sm font-bold text-white mb-1">${escapeHtml(a.title || '')}</div>
        <div class="text-sm text-gray-400 leading-relaxed">${escapeHtml(a.body || a.content || '')}</div>
        ${a.source ? `<div class="text-xs text-gray-600 mt-1">ã‚½ãƒ¼ã‚¹: ${escapeHtml(a.source)}</div>` : ''}
      </div>`;
    });
    html += '</div>';
  }

  // ãã®ä»–ã®ã‚³ãƒ¼ãƒŠãƒ¼
  const otherKeys = ['culture', 'weatherFashion', 'localNews', 'genArt', 'aiEditorial', 'snsTrend', 'numbers', 'heartwarming'];
  for (const key of otherKeys) {
    if (np[key]) {
      html += renderCornerCard(key, np[key]);
    }
  }

  if (!html) {
    html = '<div class="text-sm text-gray-500">ç´™é¢ãƒ‡ãƒ¼ã‚¿ã«ã‚³ãƒ¼ãƒŠãƒ¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“</div>';
  }

  el.innerHTML = html;
}

function renderCornerCard(key, data) {
  const label = CORNER_LABELS[key] || { emoji: 'ğŸ“„', name: key };
  let content = '';

  if (typeof data === 'string') {
    content = `<div class="text-sm text-gray-400 leading-relaxed">${escapeHtml(data)}</div>`;
  } else if (typeof data === 'object') {
    // ã‚¿ã‚¤ãƒˆãƒ«
    if (data.title) {
      content += `<div class="text-sm font-bold text-white mb-1">${escapeHtml(data.title)}</div>`;
    }
    // æœ¬æ–‡
    if (data.body || data.content || data.text) {
      content += `<div class="text-sm text-gray-400 leading-relaxed mb-2">${escapeHtml(data.body || data.content || data.text)}</div>`;
    }
    // é…åˆ—ï¼ˆsnsTrendã®itemsç­‰ï¼‰
    if (data.items && Array.isArray(data.items)) {
      data.items.forEach(item => {
        content += `<div class="text-sm text-gray-400 py-1 border-b border-gray-800/30 last:border-0">`;
        if (item.title) content += `<span class="text-white font-medium">${escapeHtml(item.title)}</span> `;
        if (item.body || item.text || item.content) content += escapeHtml(item.body || item.text || item.content);
        if (item.platform) content += ` <span class="text-xs text-gray-600">[${escapeHtml(item.platform)}]</span>`;
        content += '</div>';
      });
    }
    // ç‚ä¸Šä¸­ï¼ˆsnsTrendå†…ï¼‰
    if (data.flame) {
      content += `<div class="mt-2 p-2 bg-red-950/30 rounded-lg border border-red-900/30">
        <div class="text-xs text-red-400 font-bold mb-1">ğŸ”¥ ç‚ä¸Šä¸­</div>
        <div class="text-sm text-gray-400">${escapeHtml(typeof data.flame === 'string' ? data.flame : (data.flame.title || data.flame.body || JSON.stringify(data.flame)))}</div>
      </div>`;
    }
    // tipï¼ˆå¤©æ°—ã¨æœè£…ã®tipç­‰ï¼‰
    if (data.tip) {
      content += `<div class="mt-2 p-2 bg-blue-950/30 rounded-lg border border-blue-900/30">
        <div class="text-xs text-blue-400 mb-1">ğŸ’¡ ãƒ†ã‚£ãƒƒãƒ—</div>
        <div class="text-sm text-gray-400">${escapeHtml(data.tip)}</div>
      </div>`;
    }
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä»–ã®ã‚­ãƒ¼ã‚’è¡¨ç¤º
    if (!content) {
      content = `<pre class="text-xs text-gray-500 overflow-x-auto">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`;
    }
  }

  return `<div class="bg-gray-900 rounded-xl border border-gray-800 mb-4">
    <div class="px-5 py-3 border-b border-gray-800">
      <span class="text-sm font-bold text-gray-300">${label.emoji} ${label.name}</span>
    </div>
    <div class="px-5 py-4">${content}</div>
  </div>`;
}

// ===== Phase 3: ãŠçŸ¥ã‚‰ã›é…ä¿¡ =====

function previewAnnouncement() {
  const subject = document.getElementById('announce-subject').value.trim();
  const body = document.getElementById('announce-body').value.trim();
  const target = document.querySelector('input[name="announce-target"]:checked').value;
  const el = document.getElementById('announce-preview');

  if (!subject || !body) {
    el.innerHTML = '<div class="text-sm text-yellow-400">ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
    el.classList.remove('hidden');
    return;
  }

  const targetLabel = { all: 'å…¨å“¡', active: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®ã¿', invite: 'ä½“é¨“ä¸­ã®ã¿' }[target];
  el.innerHTML = `
    <div class="bg-gray-800 rounded-lg p-4">
      <div class="text-xs text-gray-500 mb-2">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆé…ä¿¡å¯¾è±¡: ${targetLabel}ï¼‰</div>
      <div class="text-sm font-bold text-white mb-2">${escapeHtml(subject)}</div>
      <div class="text-sm text-gray-400 whitespace-pre-wrap leading-relaxed">${escapeHtml(body)}</div>
    </div>
  `;
  el.classList.remove('hidden');
}

async function sendAnnouncement() {
  const subject = document.getElementById('announce-subject').value.trim();
  const body = document.getElementById('announce-body').value.trim();
  const target = document.querySelector('input[name="announce-target"]:checked').value;
  const btn = document.getElementById('btn-announce');
  const result = document.getElementById('announce-result');

  if (!subject || !body) {
    result.innerHTML = '<div class="text-sm text-yellow-400">ä»¶åã¨æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
    result.classList.remove('hidden');
    return;
  }

  if (!confirm(`ãŠçŸ¥ã‚‰ã›ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nä»¶å: ${subject}\nå¯¾è±¡: ${target}`)) return;

  btn.disabled = true;
  btn.textContent = 'é€ä¿¡ä¸­â€¦';
  result.classList.add('hidden');
  document.getElementById('announce-preview').classList.add('hidden');

  try {
    const res = await apiCall('/api/admin/announce', {
      method: 'POST',
      body: JSON.stringify({ subject, body, target }),
    });
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();

    if (!res.ok) {
      result.innerHTML = `<div class="text-sm text-red-400">âŒ ${escapeHtml(data.error)}</div>`;
      result.classList.remove('hidden');
      return;
    }

    result.innerHTML = `<div class="text-sm text-green-400">âœ… ${data.sentCount || 0}ä»¶ ã«é€ä¿¡ã—ã¾ã—ãŸ</div>`;
    result.classList.remove('hidden');
    document.getElementById('announce-subject').value = '';
    document.getElementById('announce-body').value = '';
    loadAnnounceHistory();
  } catch (err) {
    result.innerHTML = `<div class="text-sm text-red-400">âŒ ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
    result.classList.remove('hidden');
  } finally {
    btn.disabled = false;
    btn.textContent = 'é€ä¿¡ã™ã‚‹';
  }
}

async function loadAnnounceHistory() {
  const el = document.getElementById('announce-history');
  try {
    const res = await apiCall('/api/admin/announcements');
    if (res.status === 401) { clearToken(); location.reload(); return; }
    const data = await res.json();
    const items = data.announcements || [];

    if (items.length === 0) {
      el.innerHTML = '<div class="p-6 text-sm text-gray-500">ã¾ã ãŠçŸ¥ã‚‰ã›ã‚’é€ä¿¡ã—ã¦ã„ã¾ã›ã‚“</div>';
      return;
    }

    el.innerHTML = items.map(a => {
      const dt = new Date(a.sentAt);
      const dateStr = `${dt.getMonth() + 1}/${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2, '0')}`;
      const targetLabel = { all: 'å…¨å“¡', active: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–', invite: 'ä½“é¨“ä¸­' }[a.target] || a.target;
      return `
        <div class="px-6 py-4 border-b border-gray-800/50 last:border-0">
          <div class="flex items-center gap-3 mb-1">
            <span class="text-xs text-gray-500">${dateStr}</span>
            <span class="text-xs bg-gray-800 text-gray-400 px-2 py-0.5 rounded">${targetLabel}</span>
            <span class="text-xs text-gray-600">${a.sentCount || 0}ä»¶é€ä¿¡</span>
          </div>
          <div class="text-sm font-bold text-white">${escapeHtml(a.subject)}</div>
          <div class="text-sm text-gray-500 mt-0.5 line-clamp-2">${escapeHtml(a.body)}</div>
        </div>
      `;
    }).join('');
  } catch (err) {
    el.innerHTML = `<div class="p-6 text-sm text-red-400">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}</div>`;
  }
}

// ===== è³¼èª­ãƒ•ãƒ­ãƒ¼è¨ºæ–­ =====

const DIAGNOSE_ENDPOINTS = [
  { name: 'Payment API', url: 'https://payment-api.hiroshinagano0113.workers.dev/health' },
  { name: 'News Generator', url: `${API}/health` },
];

function setDiagnoseBtn(id, disabled) {
  const btn = document.getElementById(id);
  if (!btn) return;
  if (disabled) {
    btn.dataset.origText = btn.textContent;
    btn.textContent = 'ãƒ†ã‚¹ãƒˆä¸­...';
    btn.disabled = true;
  } else {
    btn.textContent = btn.dataset.origText || btn.textContent;
    btn.disabled = false;
  }
}

async function runHealthCheck() {
  const el = document.getElementById('health-results');
  el.innerHTML = '<div class="text-gray-500">ãƒ†ã‚¹ãƒˆä¸­...</div>';
  setDiagnoseBtn('btn-health', true);
  const results = [];

  for (const ep of DIAGNOSE_ENDPOINTS) {
    const start = performance.now();
    try {
      const res = await fetch(ep.url);
      const ms = Math.round(performance.now() - start);
      if (res.ok) {
        results.push({ name: ep.name, status: 'ok', msg: `${res.status} OK`, ms });
      } else {
        results.push({ name: ep.name, status: 'error', msg: `${res.status} ${res.statusText}`, ms });
      }
    } catch (err) {
      const ms = Math.round(performance.now() - start);
      results.push({ name: ep.name, status: 'error', msg: err.message, ms });
    }
  }

  el.innerHTML = results.map(r => `
    <div class="flex items-center gap-3 p-3 bg-gray-800 rounded-lg">
      <span>${r.status === 'ok' ? 'âœ…' : 'âŒ'}</span>
      <span class="font-medium text-gray-200 w-40">${r.name}</span>
      <span class="${r.status === 'ok' ? 'text-green-400' : 'text-red-400'}">${r.msg}</span>
      <span class="text-gray-500 ml-auto">${r.ms}ms</span>
    </div>
  `).join('');

  setDiagnoseBtn('btn-health', false);
  return results;
}

async function runCheckoutTest() {
  const el = document.getElementById('checkout-results');
  el.innerHTML = '<div class="text-gray-500">ãƒ†ã‚¹ãƒˆä¸­...</div>';
  setDiagnoseBtn('btn-checkout', true);
  let result;

  try {
    const res = await fetch('https://payment-api.hiroshinagano0113.workers.dev/api/checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });
    const data = await res.json();

    if (data.url) {
      result = { status: 'ok', msg: 'Checkout URLå–å¾—æˆåŠŸ' };
      el.innerHTML = `
        <div class="p-3 bg-gray-800 rounded-lg">
          <div class="flex items-center gap-2 mb-2">
            <span>âœ…</span>
            <span class="text-green-400 font-medium">Checkout Sessionä½œæˆæˆåŠŸ</span>
          </div>
          <div class="text-xs text-gray-400 break-all">
            <a href="${escapeHtml(data.url)}" target="_blank" rel="noopener" class="text-blue-400 hover:underline">${escapeHtml(data.url)}</a>
          </div>
        </div>`;
    } else {
      result = { status: 'error', msg: data.message || `HTTP ${res.status}` };
      el.innerHTML = `
        <div class="p-3 bg-gray-800 rounded-lg">
          <div class="flex items-center gap-2">
            <span>âŒ</span>
            <span class="text-red-400">${escapeHtml(data.message || 'URLæœªå–å¾—')} (HTTP ${res.status})</span>
          </div>
        </div>`;
    }
  } catch (err) {
    const isCors = err.message.includes('Failed to fetch') || err.name === 'TypeError';
    result = { status: 'error', msg: isCors ? 'CORSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§' : err.message };
    el.innerHTML = `
      <div class="p-3 bg-gray-800 rounded-lg">
        <div class="flex items-center gap-2">
          <span>âŒ</span>
          <span class="text-red-400">${isCors ? 'CORSã‚¨ãƒ©ãƒ¼ã®å¯èƒ½æ€§: ' : ''}${escapeHtml(err.message)}</span>
        </div>
      </div>`;
  }

  setDiagnoseBtn('btn-checkout', false);
  return result;
}

async function runPageCheck() {
  const el = document.getElementById('pagecheck-results');
  el.innerHTML = '<div class="text-gray-500">ãƒ†ã‚¹ãƒˆä¸­...</div>';
  setDiagnoseBtn('btn-pagecheck', true);
  const checks = [];

  const pages = [
    { name: 'lp.html', url: 'lp.html' },
    { name: 'index.html', url: 'index.html' },
  ];

  for (const page of pages) {
    try {
      const res = await fetch(page.url);
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      const hasHandleSubscribe = html.includes('function handleSubscribe');
      const hasSubscribeBtn = !!doc.getElementById('subscribeBtn');
      const hasSubscribeSection = !!doc.getElementById('subscribeSection');

      const onclickBtns = [];
      doc.querySelectorAll('[onclick]').forEach(el => {
        const oc = el.getAttribute('onclick');
        if (oc.includes('subscribe') || oc.includes('Subscribe')) {
          onclickBtns.push({ tag: el.tagName, text: el.textContent.trim().slice(0, 30), onclick: oc });
        }
      });

      const hrefBtns = [];
      doc.querySelectorAll('a[href*="subscribe"], a[href*="lp.html"]').forEach(el => {
        hrefBtns.push({ tag: 'A', text: el.textContent.trim().slice(0, 30), href: el.getAttribute('href') });
      });

      checks.push({
        page: page.name,
        status: 'ok',
        hasHandleSubscribe,
        hasSubscribeBtn,
        hasSubscribeSection,
        onclickBtns,
        hrefBtns,
      });
    } catch (err) {
      checks.push({ page: page.name, status: 'error', msg: err.message });
    }
  }

  let html = '<table class="w-full text-sm"><thead><tr class="text-left text-gray-500 border-b border-gray-700">' +
    '<th class="pb-2 pr-3">ãƒšãƒ¼ã‚¸</th><th class="pb-2 pr-3">handleSubscribe</th><th class="pb-2 pr-3">subscribeBtn</th>' +
    '<th class="pb-2 pr-3">subscribeSection</th><th class="pb-2">è³¼èª­é–¢é€£ãƒœã‚¿ãƒ³</th></tr></thead><tbody>';

  for (const c of checks) {
    if (c.status === 'error') {
      html += `<tr class="border-b border-gray-800"><td class="py-2 pr-3 text-gray-200">${c.page}</td>` +
        `<td colspan="4" class="py-2 text-red-400">âŒ ${escapeHtml(c.msg)}</td></tr>`;
      continue;
    }
    const allBtns = [...(c.onclickBtns || []).map(b => `${b.tag}: "${b.text}" â†’ ${b.onclick}`),
                      ...(c.hrefBtns || []).map(b => `${b.tag}: "${b.text}" â†’ href="${b.href}"`)];
    html += `<tr class="border-b border-gray-800">` +
      `<td class="py-2 pr-3 text-gray-200">${c.page}</td>` +
      `<td class="py-2 pr-3">${c.hasHandleSubscribe ? 'âœ… ã‚ã‚Š' : 'â€” ãªã—'}</td>` +
      `<td class="py-2 pr-3">${c.hasSubscribeBtn ? 'âœ… ã‚ã‚Š' : 'â€” ãªã—'}</td>` +
      `<td class="py-2 pr-3">${c.hasSubscribeSection ? 'âš ï¸ ã‚ã‚Š' : 'âœ… ãªã—'}</td>` +
      `<td class="py-2 text-gray-400">${allBtns.length ? allBtns.map(b => `<div class="truncate max-w-md">${escapeHtml(b)}</div>`).join('') : 'â€” ãªã—'}</td>` +
      `</tr>`;
  }
  html += '</tbody></table>';
  el.innerHTML = html;

  setDiagnoseBtn('btn-pagecheck', false);
  return checks;
}

async function runFullDiagnose() {
  setDiagnoseBtn('btn-full-diagnose', true);
  const summaryEl = document.getElementById('diagnose-summary');
  summaryEl.textContent = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';

  const healthResults = await runHealthCheck();
  const checkoutResult = await runCheckoutTest();
  const pageResults = await runPageCheck();

  let total = 0, passed = 0;

  healthResults.forEach(r => { total++; if (r.status === 'ok') passed++; });
  if (checkoutResult) { total++; if (checkoutResult.status === 'ok') passed++; }
  pageResults.forEach(r => { total++; if (r.status === 'ok') passed++; });

  const icon = passed === total ? 'âœ…' : passed > 0 ? 'âš ï¸' : 'âŒ';
  summaryEl.innerHTML = `<span class="text-lg">${icon}</span> <strong>${total}ä»¶ä¸­ ${passed}ä»¶ æ­£å¸¸</strong>`;

  setDiagnoseBtn('btn-full-diagnose', false);
}
</script>
</body>
</html>
