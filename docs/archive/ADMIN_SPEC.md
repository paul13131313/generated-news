# generated-news 管理画面（ダッシュボード）仕様書

## 概要

generated-news の運営・プロモーションを支援する管理画面。  
URLは `admin.html`（GitHub Pages上）とし、パスワード認証で保護する。

---

## 画面構成

管理画面は **1ページ構成のシングルページ** とし、セクション切り替え（タブ or サイドメニュー）で各機能にアクセスする。

---

## 1. ダッシュボード（トップ）

管理画面を開いたときに最初に表示される概況画面。

### 表示項目

| 項目 | 内容 | データソース |
|------|------|-------------|
| 購読者数（総数） | 現在のアクティブ購読者数 | Cloudflare Workers KV |
| 体験パス利用中 | 無料体験中のユーザー数 | KV（有効期限チェック） |
| 今日の配信状況 | 朝刊 ✅ / 夕刊 ⏳ のようなステータス | Workers の配信ログ |
| 直近7日の購読者推移 | 折れ線グラフ（新規・解約・純増） | KV に日次記録 |
| 見本紙の発行数（累計） | プロモーション効果の把握用 | KV |

### 補足
- グラフは軽量ライブラリ（Chart.js CDN）で描画
- 数値はWorkers APIから取得（`/api/admin/stats`）

---

## 2. 最新紙面プレビュー

自分（管理者）の設定情報をベースに、最新の朝刊・夕刊をその場で確認できる。

### 機能

- **朝刊 / 夕刊の切り替え**：タブで切り替え
- **紙面表示**：`index.html` と同じレイアウトで表示（iframe or 同一コンポーネント読み込み）
- **管理者プロフィール**：住所＝恵比寿、関心カテゴリ＝全カテゴリ、キーワード＝任意設定可能
- **再生成ボタン**：紙面を手動で再生成できる（テスト・確認用）

### API
```
GET /api/admin/preview?edition=morning
GET /api/admin/preview?edition=evening
POST /api/admin/preview/regenerate?edition=morning
```

---

## 3. 見本紙の発行（★ プロモーション用コア機能）

その日の紙面を「見本紙」として無料公開し、SNS等でシェアできるようにする。

### 発行フロー

```
[発行ボタン押下]
    ↓
[その日の紙面データを取得（管理者設定ベース）]
    ↓
[固有の見本紙IDを生成（例: sample-20260226-a3x9）]
    ↓
[見本紙用の公開ページを生成]
    ↓
[紙面のスクリーンショット画像を生成]
    ↓
[固有URL + スクリーンショット画像を表示]
```

### 見本紙の仕様

| 項目 | 内容 |
|------|------|
| 公開URL | `https://paul13131313.github.io/generated-news/sample/{見本紙ID}` |
| 有効期限 | 無期限（発行した見本紙は恒久的に閲覧可能） |
| 閲覧制限 | なし（誰でも閲覧可、購読不要） |
| ヘッダー表示 | 「見本紙」バッジ + 購読導線（CTAボタン） |
| フッター表示 | 「この新聞はAIが生成しています」+ 購読リンク |
| OGP設定 | タイトル「生成新聞 ○月○日号【見本紙】」+ スクリーンショット画像 |

### スクリーンショット生成

- **方式**: Cloudflare Workers + Puppeteer（`@cloudflare/puppeteer`）  
  ※ Cloudflare Browser Rendering を利用  
  ※ 代替案: 外部サービス（screenshotapi.net 等）のAPI利用
- **出力**: PNG画像（幅1200px、紙面全体）
- **保存先**: Cloudflare R2（オブジェクトストレージ）
- **用途**: OGP画像 / SNSシェア用 / 管理画面での確認用

### 管理画面での見本紙操作

- **発行ボタン**：「今日の見本紙を発行」→ 確認ダイアログ → 発行
- **発行済み一覧**：過去の見本紙をリスト表示（日付・URL・閲覧数）
- **コピー機能**：URLワンクリックコピー、スクリーンショット画像のダウンロード
- **SNSシェアボタン**：X（Twitter）/ LINE / リンクコピー

### API
```
POST /api/admin/sample/issue          → 見本紙を発行
GET  /api/admin/sample/list           → 発行済み一覧
GET  /api/admin/sample/{id}/screenshot → スクリーンショット取得
GET  /api/sample/{id}                 → 見本紙公開ページ（一般公開）
```

---

## 4. 購読者管理

### 一覧表示

| カラム | 内容 |
|--------|------|
| メールアドレス | 購読者のメール |
| ステータス | アクティブ / 体験中 / 解約済み |
| 登録日 | 購読開始日 |
| 関心カテゴリ | 設定済みカテゴリ一覧 |
| 招待元 | 招待コード（あれば） |

### 機能
- 検索・フィルタ（ステータス別）
- CSVエクスポート
- 購読者の詳細表示（設定内容の確認）

### API
```
GET /api/admin/subscribers?status=active&page=1
GET /api/admin/subscribers/export
```

---

## 5. 招待コード管理

体験パス（7日間無料）の招待コードを発行・管理する。

### 機能

- **新規発行**：コード生成（自動 or カスタム文字列）、有効期限・利用回数上限の設定
- **一覧表示**：コード / 利用回数 / 残数 / 有効期限 / ステータス
- **無効化**：特定のコードを手動で無効化
- **プロモーション用一括発行**：10〜50件のコードをまとめて発行、CSV出力

### API
```
POST /api/admin/invites              → コード発行
GET  /api/admin/invites              → 一覧取得
PATCH /api/admin/invites/{code}      → 無効化
POST /api/admin/invites/bulk         → 一括発行
```

---

## 6. 配信ログ

### 表示内容

| 項目 | 内容 |
|------|------|
| 配信日時 | 朝刊06:00 / 夕刊17:00 |
| ステータス | 成功 / 失敗 / 一部失敗 |
| 配信対象数 | 配信した購読者数 |
| 生成時間 | 記事生成にかかった秒数 |
| エラー詳細 | 失敗時の原因（API制限、タイムアウト等） |

### 機能
- 直近30日分のログ表示
- エラーがある場合はダッシュボードにもアラート表示
- 手動再配信ボタン（配信失敗時のリカバリ用）

### API
```
GET  /api/admin/delivery-logs?days=30
POST /api/admin/delivery/retry/{logId}
```

---

## 7. コンテンツ確認

生成された記事を事後確認するための画面。編集はしない（AI生成の一貫性を保つため）。

### 表示内容
- 日付・版（朝刊/夕刊）でフィルタ
- コーナー別に記事一覧（一面 / 天声生成 / 数字で読む / 地域ニュース等）
- 各記事のタイトル・本文・生成に使用したソース情報

### 用途
- 品質チェック（不適切な内容がないか）
- 記事のネタ確認（SNS投稿のヒントに）

---

## 8. お知らせ配信（シンプル版）

購読者全員、または特定セグメントにお知らせを送る機能。

### 用途
- メンテナンス告知
- 新コーナー追加のお知らせ
- 特別号の案内

### 機能
- テキスト入力 → プレビュー → 送信
- 配信対象：全員 / アクティブのみ / 体験中のみ

### API
```
POST /api/admin/announce
```

---

## 技術設計

### 認証

```
方式: シンプルなパスワード認証
─────────────────────────────
管理画面アクセス時にパスワード入力を要求。
パスワードのハッシュをCloudflare Workers の環境変数に保存。
入力パスワードをハッシュ化してAPI側で照合。
認証トークン（JWT）を発行し、以降のAPI呼び出しに使用。
トークン有効期限: 24時間
```

### フロントエンド

```
ファイル: admin.html（GitHub Pages上に配置）
フレームワーク: なし（Vanilla JS）※ 既存プロジェクトに合わせる
UIライブラリ: Tailwind CSS（CDN）
グラフ: Chart.js（CDN）
```

### バックエンド（Cloudflare Workers）

```
新規ルート: /api/admin/* を追加
認証ミドルウェア: admin系APIは全てJWT検証を通す
データ保存: Cloudflare KV（既存を拡張）
画像保存: Cloudflare R2（見本紙スクリーンショット用）
スクリーンショット: Cloudflare Browser Rendering
```

### データ構造（KV追加分）

```
admin:stats:daily:{YYYYMMDD}     → { subscribers, trials, new, churned }
admin:sample:{id}                → { date, edition, newspaperData, screenshotUrl, views }
admin:delivery-log:{YYYYMMDD}    → { morning: {...}, evening: {...} }
admin:announcements:{id}         → { text, target, sentAt, sentCount }
invite:{code}                    → { maxUses, usedCount, expiresAt, active }
```

---

## 画面ワイヤーフレーム（概念）

```
┌─────────────────────────────────────────────────┐
│  🗞️ generated-news 管理画面          [ログアウト] │
├──────────┬──────────────────────────────────────┤
│          │                                      │
│ Dashboard│  購読者数        配信状況             │
│          │  ┌─────┐       ┌──────────┐          │
│ 紙面     │  │ 128 │       │朝刊 ✅   │          │
│ プレビュー│  │  名  │       │夕刊 ⏳   │          │
│          │  └─────┘       └──────────┘          │
│ 見本紙   │                                      │
│ 発行     │  購読者推移（7日間）                   │
│          │  ┌──────────────────────┐             │
│ 購読者   │  │  📈                  │             │
│ 管理     │  │     ／＼  ／         │             │
│          │  │   ／    ＼           │             │
│ 招待コード│  └──────────────────────┘             │
│          │                                      │
│ 配信ログ │  見本紙クイック発行                     │
│          │  ┌──────────────────────┐             │
│ コンテンツ│  │ [今日の見本紙を発行]  │             │
│ 確認     │  │ 最終発行: 2/25 朝刊   │             │
│          │  └──────────────────────┘             │
│ お知らせ │                                      │
│          │                                      │
├──────────┴──────────────────────────────────────┤
│  © generated-news                               │
└─────────────────────────────────────────────────┘
```

---

## 実装優先度

### Phase 1（MVP）— まず使えるように
1. ✅ 認証（パスワードログイン）
2. ✅ ダッシュボード（購読者数・配信状況）
3. ✅ 最新紙面プレビュー
4. ✅ 見本紙の発行（URL生成 + スクリーンショット）

### Phase 2 — 運営を楽に
5. 購読者管理（一覧・検索・エクスポート）
6. 招待コード管理
7. 配信ログ

### Phase 3 — 成長のために
8. コンテンツ確認
9. お知らせ配信
10. ダッシュボードのグラフ強化（閲覧数、人気コーナー等）

---

## 補足: スクリーンショット生成の代替案

Cloudflare Browser Rendering が難しい場合の代替案：

| 方式 | メリット | デメリット |
|------|---------|-----------|
| Cloudflare Browser Rendering | Workers内で完結、高速 | 有料プラン（$5/mo〜）必要 |
| 外部API（screenshotapi.net等） | 導入が簡単 | 従量課金、外部依存 |
| html2canvas（クライアント側） | 無料、サーバー不要 | 品質にばらつき、フォント問題 |
| GitHub Actions + Puppeteer | 無料枠あり、高品質 | リアルタイム生成不可（バッチ） |

**推奨**: まずは Cloudflare Browser Rendering で進め、コスト面で問題があれば html2canvas にフォールバック。
